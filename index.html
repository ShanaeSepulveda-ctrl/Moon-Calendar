<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <title>The Ancient Rhythm</title>
  <meta name="apple-mobile-web-app-title" content="Ancient Rhythm">
  <meta name="application-name" content="The Ancient Rhythm">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåë</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåë</text></svg>">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Charm:wght@400;700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">
  <style>
    :root { 
      --space: #020105; --gold: #e6ccff; --glass: rgba(12, 6, 24, 0.96); 
      --blood: #ff3385; --aura: #9d50bb; --amethyst: #df80ff;
      --retro: #ff6b6b; --portal: #ffd700; --moon-glow: #a8e6cf; --zodiac: #99ccff; --phase: #b388ff;
    }
    body { 
      font-family: 'Quicksand', sans-serif; background: var(--space); 
      background-image: radial-gradient(circle at top, #1a0b2e 0%, var(--space) 100%); 
      color: #fdfbff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
    }
    
    /* V83/V85 STAR FIELD */
    .star-field { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--d) infinite ease-in-out; box-shadow: 0 0 4px rgba(255, 255, 255, 0.8); }
    @keyframes twinkle { 
      0%, 100% { opacity: 0.2; transform: scale(0.8); } 
      50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 8px rgba(255, 255, 255, 1); } 
    }

    #oracleDash, #grimoireView, #yearlyView { 
      width: 92%; max-width: 450px; background: var(--glass); backdrop-filter: blur(30px); 
      border: 1px solid rgba(230, 204, 255, 0.1); border-top: 3px solid var(--aura); 
      border-radius: 35px; padding: 20px; margin: 15px 0; box-shadow: 0 15px 50px rgba(0,0,0,0.9); text-align: center; display: none; position: relative;
    }
    #oracleDash { display: block; }

    /* COSMIC MODAL STYLING */
    #cosmicModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: rgba(15, 5, 25, 0.98); border: 2px solid var(--gold); border-radius: 25px; padding: 25px; z-index: 1000; text-align: left; box-shadow: 0 0 50px rgba(200, 180, 255, 0.3); max-height: 80vh; overflow-y: auto; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }
    
    .modal-section { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    .modal-section:last-child { border-bottom: none; }
    .modal-label { font-family: 'Cinzel'; font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; display: block; margin-bottom: 8px; font-weight: bold; }
    .modal-content-text { font-family: 'Charm'; font-size: 1.2rem; color: #fff; line-height: 1.5; }
    .modal-link { color: var(--zodiac); font-size: 0.8rem; text-decoration: underline; cursor: pointer; display: block; margin-top: 8px; font-family: 'Quicksand'; opacity: 0.8; }

    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; width: 100%; max-width: 450px; margin-bottom: 10px; }
    .day-label { font-size: 0.55rem; color: var(--gold); font-family: 'Cinzel'; opacity: 0.6; }
    .day { background: rgba(255,255,255,0.02); border-radius: 10px; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1.5px solid transparent; cursor: pointer; transition: 0.3s; }
    
    .day.today { border: 2.5px solid var(--gold); box-shadow: 0 0 15px var(--gold); z-index: 2; }
    .day.full-moon-day { background: radial-gradient(circle, rgba(230, 204, 255, 0.3) 0%, transparent 70%); }
    .day.new-moon-day { background: radial-gradient(circle, rgba(75, 0, 130, 0.4) 0%, transparent 70%); }
    .day.celestial-pivot { border: 1.5px dashed var(--gold); }
    .day.selected { border: 1px solid #fff; background: rgba(255, 255, 255, 0.1); }
    .day.period { border-bottom: 3px solid var(--blood) !important; }

    .d-num { position: absolute; top: 4px; left: 6px; font-size: 0.55rem; opacity: 0.4; }
    .t-num { position: absolute; top: 4px; right: 6px; font-size: 0.55rem; color: var(--gold); font-weight: bold; }
    .m-ico { font-size: 1rem; margin-top: 5px; filter: drop-shadow(0 0 5px var(--aura)); }
    .z-ico { font-size: 0.45rem; color: var(--gold); margin-top: 2px; font-family: 'Cinzel'; }

    .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); border-radius: 15px; padding: 8px 12px; font-family: 'Cinzel'; font-size: 0.6rem; margin: 5px; }
    .cycle-btn { border: 1.5px solid var(--blood); color: var(--blood); background: transparent; padding: 14px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.8rem; width: 100%; margin-top: 15px; transition: 0.3s; }
    .cycle-btn.active { background: var(--blood); color: white; box-shadow: 0 0 15px var(--blood); }
    .sister-btn { background: rgba(255,255,255,0.05); color: var(--gold); border: 1px solid var(--aura); padding: 10px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.65rem; width: 100%; margin-top: 10px; }
    .explore-btn { background: var(--gold); color: var(--space); border: none; padding: 10px 25px; border-radius: 20px; font-family: 'Cinzel'; font-size: 0.75rem; margin-top: 15px; cursor: pointer; text-decoration: none; display: inline-block; box-shadow: 0 0 15px var(--gold); }

    .wisdom-card { text-align: left; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 25px; border-left: 3px solid var(--aura); margin-bottom: 15px; }
    .wisdom-label { font-family: 'Cinzel'; font-size: 0.6rem; color: var(--gold); letter-spacing: 2px; display: block; margin-bottom: 8px; }
    .wisdom-text { font-family: 'Charm'; font-size: 1.15rem; line-height: 1.6; color: #eee; }
    .affirmation { font-family: 'Cinzel'; font-size: 0.7rem; color: var(--gold); margin-top: 12px; opacity: 0.8; font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;}
    
    .energy-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .energy-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 8px; flex: 1; margin: 0 3px; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
    .energy-btn.active { background: var(--aura); border-color: var(--gold); box-shadow: 0 0 10px var(--aura); transform: scale(1.1); }
    .energy-label { font-family: 'Cinzel'; font-size: 0.55rem; color: var(--gold); margin-bottom: 15px; height: 10px; letter-spacing: 1px; }

    #journalInput { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; color: #fff; font-family: 'Charm'; font-size: 1.2rem; min-height: 100px; box-sizing: border-box; outline: none; }
    
    /* V83/V85: Minimalist Badges */
    .event-badge { font-size: 0.6rem; padding: 4px 12px; border-radius: 15px; display: inline-block; margin-bottom: 5px; font-family: 'Cinzel'; letter-spacing: 1px; cursor: pointer; }
    .portal-badge { background: var(--portal); color: var(--space); box-shadow: 0 0 10px var(--portal); }
    .retro-badge { background: var(--retro); color: var(--space); box-shadow: 0 0 10px var(--retro); }
    .newyear-badge { background: linear-gradient(90deg, #2ecc71, #df80ff); color: white; box-shadow: 0 0 20px #2ecc71; padding: 8px 20px; font-size: 0.75rem; border: 1px solid white; cursor: pointer;}
    
    /* V83/V85: CLICKABLE GLOWING TITLE */
    .clickable-title { 
      cursor: pointer; 
      transition: all 0.4s ease; 
      position: relative; 
      display: inline-block;
      text-shadow: 0 0 10px rgba(230, 204, 255, 0.3);
      padding: 12px 30px;
      background: rgba(230, 204, 255, 0.05);
      border: 1px solid rgba(230, 204, 255, 0.25);
      border-radius: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .clickable-title:hover { 
      text-shadow: 0 0 20px var(--gold), 0 0 40px var(--aura); 
      transform: scale(1.03) translateY(-3px);
      color: #fff;
      background: rgba(230, 204, 255, 0.12);
      border-color: var(--gold);
      box-shadow: 0 10px 25px rgba(230, 204, 255, 0.3), inset 0 0 15px rgba(230, 204, 255, 0.1);
    }

    .grim-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; }
    .grim-btn { background: transparent; border: none; color: #aaa; font-size: 0.9rem; cursor: pointer; }
    .support-link { margin-top: 20px; font-size: 0.7rem; color: var(--gold); opacity: 0.7; cursor: pointer; text-decoration: underline; font-family: 'Cinzel'; display: block; }
    
    .backup-section { border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 20px; }
    .backup-title { font-family: 'Cinzel'; font-size: 0.7rem; color: var(--gold); margin-bottom: 10px; display:block;}
    .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .backup-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); padding: 10px; border-radius: 10px; font-family: 'Cinzel'; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .backup-btn:hover { background: rgba(255,255,255,0.1); }
    .export-btn { background: var(--aura); border: none; color: white; grid-column: span 2; }
  </style>
</head>
<body>

<div class="star-field" id="starField"></div>

<div style="display: flex; justify-content: space-between; width: 92%; max-width: 450px;">
  <button class="nav-btn" onclick="showView('yearly')">YEARLY MAP</button>
  <button class="nav-btn" onclick="showView('grimoire')">MY HISTORY</button>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 450px; margin: 10px 0;">
  <span style="cursor:pointer; font-size: 2rem; color:var(--gold);" onclick="changeMonth(-1)">‚òæ</span>
  <h3 id="monthLabel" style="font-family:'Cinzel'; letter-spacing: 4px; margin:0; font-size: 1rem;"></h3>
  <span style="cursor:pointer; font-size: 2rem; color:var(--gold);" onclick="changeMonth(1)">‚òΩ</span>
</div>

<div id="calendar"></div>

<div id="oracleDash">
  <div id="eventDisplay"></div>
  <h2 id="dashTitle" class="clickable-title" style="font-family:'Cinzel'; margin: 25px 0 5px 0; color:var(--gold); letter-spacing: 3px; font-size: 1.4rem;"></h2>
  <div id="dashSub" style="font-size: 0.6rem; letter-spacing: 2px; margin-bottom: 30px; opacity: 0.8; font-family: 'Cinzel';"></div>
  
  <div class="wisdom-card">
    <span class="wisdom-label">ANCESTRAL WHISPER</span>
    <div class="wisdom-text" id="guidanceText"></div>
    <div class="affirmation" id="affirmationText"></div>
  </div>

  <div class="wisdom-card" id="shadowCard" style="display:none; border-left: 3px solid var(--retro);">
    <span class="wisdom-label" style="color:var(--retro);">SHADOW WORK INQUIRY</span>
    <div class="wisdom-text" id="shadowText"></div>
  </div>

  <div class="wisdom-card">
    <span class="wisdom-label">SACRED EARTH RITUAL</span>
    <div class="wisdom-text" id="ritualText"></div>
  </div>

  <div class="energy-row">
    <div class="energy-btn" onclick="setEnergy('üî•')" id="e-fire">üî•</div>
    <div class="energy-btn" onclick="setEnergy('üíß')" id="e-water">üíß</div>
    <div class="energy-btn" onclick="setEnergy('üå¨Ô∏è')" id="e-air">üå¨Ô∏è</div>
    <div class="energy-btn" onclick="setEnergy('ü™®')" id="e-earth">ü™®</div>
  </div>
  <div id="energyLabel" class="energy-label">Select your dominant energy</div>

  <textarea id="journalInput" placeholder="Scribe your soul's journey..." oninput="saveData()"></textarea>
  
  <div style="display: flex; flex-direction: column; gap: 5px;">
    <button id="flowBtn" class="cycle-btn" onclick="toggleFlow()">MARK MOON FLOW</button>
    <button class="sister-btn" onclick="copySisterReport()">
      <span>‚ú®</span> SHARE MOON REPORT <span>‚ú®</span>
    </button>
  </div>
</div>

<div class="modal-overlay" onclick="closeModal()"></div>
<div id="cosmicModal">
  <h2 id="modalTitle" style="font-family:'Cinzel'; color:var(--gold); text-align:center; border-bottom: 1px solid var(--gold); padding-bottom:10px; margin-bottom:15px;"></h2>
  <div id="modalContent"></div>
  <div style="text-align:center; margin-top:20px;">
      <button class="explore-btn" onclick="closeModal()">CLOSE</button>
  </div>
</div>

<div id="grimoireView">
  <span style="float:right; cursor:pointer;" onclick="showView('dash')">‚úï</span>
  <h2 style="font-family:'Cinzel';">MY SACRED HISTORY</h2>
  <div style="font-size:0.6rem; margin-bottom:10px; opacity:0.6;">Your journey is sacred. Export to view your patterns.</div>
  
  <div class="backup-section">
    <span class="backup-title">DATA MANAGEMENT</span>
    <div class="backup-grid">
        <button class="backup-btn export-btn" onclick="exportToCSV()">üìä EXPORT SPREADSHEET (READABLE)</button>
        <button class="backup-btn" onclick="backupData()">‚¨áÔ∏è BACKUP (FILE)</button>
        <button class="backup-btn" onclick="document.getElementById('restoreInput').click()">‚¨ÜÔ∏è RESTORE</button>
    </div>
    <input type="file" id="restoreInput" style="display:none" onchange="restoreData(this)">
  </div>
  
  <div id="grimoireContent" style="max-height: 350px; overflow-y: auto; margin-top: 15px;"></div>
  <a class="support-link" href="https://ko-fi.com/theancientrhythm" target="_blank">Created with Love ‚Ä¢ Support the Journey</a>
</div>

<div id="yearlyView">
  <span style="float:right; cursor:pointer;" onclick="showView('dash')">‚úï</span>
  <h2 style="font-family:'Cinzel'; font-size: 1rem;">CELESTIAL TIMELINE</h2>
  <div id="yearlyContent" style="text-align: left; padding: 10px; font-size: 0.75rem;"></div>
</div>

<script>
  let activeD = new Date(2026, 0, 16); 
  let selectedDate = new Date().toDateString();
  let db = JSON.parse(localStorage.getItem('ancestral_moon_v85')) || { logs: {}, journals: {}, zodCache: {}, energy: {} };

  const ELEMENTS = { "FIRE": "#ff4d4d", "EARTH": "#2ecc71", "AIR": "#3498db", "WATER": "#df80ff" };
  const ZOD_ELEMENTS = { "Aries ‚ôà":"FIRE", "Leo ‚ôå":"FIRE", "Sagittarius ‚ôê":"FIRE", "Taurus ‚ôâ":"EARTH", "Virgo ‚ôç":"EARTH", "Capricorn ‚ôë":"EARTH", "Gemini ‚ôä":"AIR", "Libra ‚ôé":"AIR", "Aquarius ‚ôí":"AIR", "Cancer ‚ôã":"WATER", "Scorpio ‚ôè":"WATER", "Pisces ‚ôì":"WATER" };
  
  const SUN_SIGN_DATA = {
    "Aries": "THE SEASON OF ACTION. The world wakes up. Fire energy.",
    "Taurus": "THE SEASON OF GROUNDING. Roots go deep. Earth energy.",
    "Gemini": "THE SEASON OF CONNECTION. Ideas flow. Air energy.",
    "Cancer": "THE SEASON OF FEELING. Emotional depth. Water energy.",
    "Leo": "THE SEASON OF RADIANCE. Shine bright. Fire energy.",
    "Virgo": "THE SEASON OF REFINEMENT. Order and harvest. Earth energy.",
    "Libra": "THE SEASON OF BALANCE. Relationships focus. Air energy.",
    "Scorpio": "THE SEASON OF TRANSFORMATION. Deep waters. Water energy.",
    "Sagittarius": "THE SEASON OF EXPANSION. Seeking truth. Fire energy.",
    "Capricorn": "THE SEASON OF BUILDING. Structure and ambition. Earth energy.",
    "Aquarius": "THE SEASON OF VISION. Innovation and future. Air energy.",
    "Pisces": "THE SEASON OF DREAMS. Spirituality and surrender. Water energy."
  };

  const DAILY_WISDOM_LIBRARY = {
    "Aries": { "Waxing": ["The spark has caught. Fan the flame.", "Warrior spirit supports you.", "Initiate action now."], "Waning": ["Release anger.", "Reflect on battles.", "Pause and rest."], "Full": ["Passion is a beacon.", "Stand tall.", "Celebrate victory."], "New": ["Seed of fire.", "Void is potential.", "Silence before strike."] },
    "Taurus": { "Waxing": ["Build slowly.", "Nourish the seed.", "Ground intentions."], "Waning": ["Release clutter.", "Compost excess.", "Let go of stubbornness."], "Full": ["Harvest pleasure.", "Honor the body.", "Solid manifestation."], "New": ["Plant deep.", "Intention for peace.", "Rest in earth."] },
    "Gemini": { "Waxing": ["Speak truth.", "Connect ideas.", "Curiosity is key."], "Waning": ["Quiet mind.", "Unlearn.", "Wind settles."], "Full": ["Illuminate mind.", "Open conversation.", "Share light."], "New": ["Plant thought.", "Set voice intention.", "Blank page."] },
    "Cancer": { "Waxing": ["Nurture dream.", "Flow with tide.", "Build safety."], "Waning": ["Release weight.", "Forgive past.", "Return to source."], "Full": ["Overflowing heart.", "Mother shines.", "Trust intuition."], "New": ["Womb of world.", "Plant love.", "Retreat inward."] },
    "Leo": { "Waxing": ["Shine.", "Create.", "Play."], "Waning": ["Release applause.", "Ego rests.", "Shed mask."], "Full": ["Radiance.", "Lead with love.", "Celebrate self."], "New": ["Seed of creativity.", "Intention for joy.", "Listen to heart."] },
    "Virgo": { "Waxing": ["Refine plan.", "Attend ritual.", "Purify intent."], "Waning": ["Cleanse.", "Release perfection.", "Analyze."], "Full": ["Service is magic.", "Order from chaos.", "Healing light."], "New": ["Seed of order.", "Health intention.", "Quiet service."] },
    "Libra": { "Waxing": ["Balance scales.", "Beautify path.", "Connect."], "Waning": ["Release pleasing.", "Trust choice.", "Unbind."], "Full": ["Mirror magic.", "Climax of beauty.", "Justice."], "New": ["Peace intention.", "Sow partnership.", "Equilibrium."] },
    "Scorpio": { "Waxing": ["Dive deep.", "Invest energy.", "Trust gut."], "Waning": ["Shed skin.", "Release grudge.", "Compost soul."], "Full": ["Phoenix rises.", "Secrets revealed.", "Intense magic."], "New": ["The void.", "Die to be born.", "Plant secret."] },
    "Sagittarius": { "Waxing": ["Aim high.", "Explore.", "Expand vision."], "Waning": ["Release dogma.", "Simplify.", "Wanderer rests."], "Full": ["Truth illuminates.", "Wild celebration.", "Teacher speaks."], "New": ["Seed of freedom.", "Seek truth.", "Trust path."] },
    "Capricorn": { "Waxing": ["Climb.", "Commit.", "Build legacy."], "Waning": ["Release burden.", "Flow around.", "Elder rests."], "Full": ["The summit.", "Power manifested.", "Structure."], "New": ["Blueprint.", "Great Work.", "Ground ambition."] },
    "Aquarius": { "Waxing": ["Innovate.", "Connect web.", "Break mold."], "Waning": ["Release detachment.", "Just be.", "Clear static."], "Full": ["Cosmic connection.", "Rebel shines.", "Future vision."], "New": ["Download vision.", "Need space.", "Seed for collective."] },
    "Pisces": { "Waxing": ["Dream.", "Flow.", "Create."], "Waning": ["Dissolve.", "Surrender.", "Cleansing rain."], "Full": ["Mystical union.", "Dreamer awakens.", "Ocean of light."], "New": ["Womb of universe.", "Pray.", "Drift."] }
  };

  const DAILY_RITUALS = {
    "Aries": ["Light a red candle.", "Move vigorously.", "Breathe fire."],
    "Taurus": ["Walk barefoot.", "Eat fruit slowly.", "Hold a stone."],
    "Gemini": ["Write a letter.", "Whisper to wind.", "Burn incense."],
    "Cancer": ["Bath with salt.", "Moon water.", "Hand on heart."],
    "Leo": ["Wear gold.", "Dance.", "Sun gaze."],
    "Virgo": ["Clean a corner.", "Herbal tea.", "List gratitude."],
    "Libra": ["Light two candles.", "Flowers.", "Listen to bell."],
    "Scorpio": ["Sit in darkness.", "Burn fear.", "Scry in water."],
    "Sagittarius": ["Walk new path.", "Purple candle.", "Look at horizon."],
    "Capricorn": ["Stand like mountain.", "Plant seed.", "Hold quartz."],
    "Aquarius": ["Meditate on stars.", "Fresh air.", "Web of light."],
    "Pisces": ["Listen to water.", "Feet in water.", "Sleep with crystal."]
  };

  const ELEMENT_MEANINGS = { "FIRE": "Action, Spirit, Passion, Transformation. Fire energy asks you to move, burn away the old, and ignite your will. It is the spark of creation.", "EARTH": "Grounding, Body, Stability, Manifestation. Earth energy asks you to root down, care for your physical vessel, and build slowly with patience.", "AIR": "Intellect, Communication, Vision, Breath. Air energy asks you to speak your truth, clarify your thoughts, and connect with ideas.", "WATER": "Emotion, Intuition, Healing, Flow. Water energy asks you to feel deeply, cleanse your spirit, and trust the mystery of the unknown." };
  const ZODIAC_WISDOM = { "Aries": "Warrior Energy. Initiation and Courage. A time to start.", "Taurus": "The Gardener. Grounding and Pleasure. A time to build.", "Gemini": "The Messenger. Connection and Wit. A time to speak.", "Cancer": "The Mother. Emotion and Safety. A time to nurture.", "Leo": "The Royal. Creativity and Joy. A time to shine.", "Virgo": "The Healer. Order and Service. A time to purify.", "Libra": "The Diplomat. Balance and Beauty. A time to relate.", "Scorpio": "The Alchemist. Depth and Transformation. A time to feel.", "Sagittarius": "The Explorer. Freedom and Truth. A time to seek.", "Capricorn": "The Architect. Ambition and Structure. A time to plan.", "Aquarius": "The Visionary. Innovation and Community. A time to dream.", "Pisces": "The Mystic. Dreams and Surrender. A time to trust." };
  const PHASE_MEANINGS = { "New Moon": "The Void. Potential and Planting. The start of the cycle.", "Waxing Crescent": "The Sprout. Courage and Growth. Taking the first step.", "First Quarter": "The Root. Action and Resistance. Overcoming obstacles.", "Waxing Gibbous": "The Bud. Refinement and perfecting. Adjusting the plan.", "Full Moon": "The Bloom. Peak energy and celebration. Illumination.", "Waning Gibbous": "The Fruit. Gratitude and Sharing. Harvesting.", "Last Quarter": "The Compost. Release and Forgiveness. Letting go.", "Waning Crescent": "The Seed. Rest and Surrender. Emptying the cup." };
  
  const PIVOT_DATA = { "Mar 20": {n: "Spring Equinox", w: "The Great Turning. Rebirth.", r: "Seed Ceremony."}, "Jun 21": {n: "Summer Solstice", w: "Zenith of Light. Power.", r: "Fire Crown."}, "Sep 22": {n: "Autumn Equinox", w: "Second Harvest. Balance.", r: "Release Leaf."}, "Dec 21": {n: "Winter Solstice", w: "Womb of Night. Stillness.", r: "Return of Light."}, "Sep 23": {n: "Autumn Equinox", w: "Second Harvest.", r: "Release Leaf."}, "Dec 22": {n: "Winter Solstice", w: "Womb of Night.", r: "Return of Light."} };
  
  const FULL_MOON_DATA = {
    "Jan 3, 2026": {n: "Wolf Moon", w: "Endurance. Loyalty to your pack. Hunger that drives you forward.", r: "Howl your truth. Visualize the wolf. 'My voice is my power.'"},
    "Feb 1, 2026": {n: "Snow Moon", w: "Purity. The world is frozen and cleansed. Focus on clarity.", r: "Whisper worries into snow/ice. Watch them melt. 'I dissolve what binds me.'"},
    "Mar 3, 2026": {n: "Worm Moon", w: "Awakening. The earth softens. Life stirs.", r: "Stand barefoot. Shake your body. 'I am awake.'"},
    "Apr 2, 2026": {n: "Pink Moon", w: "Emergence. You have survived the dark; risk being seen.", r: "Hold a pink flower. Visualize blooming. 'I bloom without apology.'"},
    "May 1, 2026": {n: "Flower Moon", w: "Abundance. Fertility. You are a garden.", r: "Create a mandala. Breathe in growth. 'I am open to receive.'"},
    "May 31, 2026": {n: "Strawberry Moon", w: "Sweetness. Ripeness. Taste the fruit of your labor.", r: "Eat sweet fruit slowly. Savor. 'My life is sweet and full.'"},
    "Jun 29, 2026": {n: "Buck Moon", w: "Strength. Ambition. Claim territory.", r: "Arms up like antlers. Roar: 'I am here. I am strong.'"},
    "Jul 29, 2026": {n: "Sturgeon Moon", w: "Depth. Resilience. Swim against the current.", r: "Submerge hands in water. 'I trust my depth.'"},
    "Aug 28, 2026": {n: "Harvest Moon", w: "Gathering. Gratitude.", r: "Hold seeds. Offer to birds. 'I receive my harvest.'"},
    "Sep 26, 2026": {n: "Hunter's Moon", w: "Preparation. Release.", r: "Light candle. Blow out to seal release. 'It is done. I am free.'"},
    "Oct 25, 2026": {n: "Beaver Moon", w: "Security. Check foundations.", r: "Clean altar. Light sage. 'My sanctuary is safe.'"},
    "Nov 24, 2026": {n: "Cold Moon", w: "Stillness. Integration.", r: "Sit in dark 5 mins. 'I am the light in winter.'"},
    "Dec 24, 2026": {n: "Long Night Moon", w: "Dreaming. Ancestors speak.", r: "Mugwort under pillow. Ask for dreams."},
    "Jan 22, 2027": {n: "Threshold Moon", w: "The 13th Moon. The void space.", r: "Stand in doorway. Step through consciously. 'I cross the threshold.'"}
  };

  const FULL_MOONS_ARRAY = [
    {d: "Jan 3, 2026", z: "Cancer ‚ôã"}, {d: "Feb 1, 2026", z: "Leo ‚ôå"}, {d: "Mar 3, 2026", z: "Virgo ‚ôç"}, {d: "Apr 2, 2026", z: "Libra ‚ôé"}, {d: "May 1, 2026", z: "Scorpio ‚ôè"}, {d: "May 31, 2026", z: "Sagittarius ‚ôê"}, {d: "Jun 29, 2026", z: "Capricorn ‚ôë"}, {d: "Jul 29, 2026", z: "Aquarius ‚ôí"}, {d: "Aug 28, 2026", z: "Pisces ‚ôì"}, {d: "Sep 26, 2026", z: "Aries ‚ôà"}, {d: "Oct 25, 2026", z: "Taurus ‚ôâ"}, {d: "Nov 24, 2026", z: "Gemini ‚ôä"}, {d: "Dec 24, 2026", z: "Cancer ‚ôã"},
    {d: "Jan 22, 2027", z: "Leo ‚ôå"} 
  ];

  const NEW_MOON_DATA = {
    "Jan 18, 2026": {s: "Capricorn", w: "Architect. Build the mountain.", r: "Plan the year."},
    "Feb 17, 2026": {s: "Aquarius", w: "Visionary. Break the mold.", r: "Download vision."},
    "Mar 18, 2026": {s: "Pisces", w: "Mystic. Surrender logic.", r: "Salt bath."},
    "Apr 17, 2026": {s: "Aries", w: "Spark. Raw beginnings.", r: "Candle magic."},
    "May 16, 2026": {s: "Taurus", w: "Garden. Plant worthiness.", r: "Seed and coin."},
    "Jun 15, 2026": {s: "Gemini", w: "Messenger. Speak it.", r: "Letter to universe."},
    "Jul 14, 2026": {s: "Cancer", w: "Womb. Emotional fertility.", r: "Nest and nourish."},
    "Aug 12, 2026": {s: "Leo", w: "Crown. Shine bright.", r: "Mirror work."},
    "Sep 11, 2026": {s: "Virgo", w: "Healer. Purify routine.", r: "Cleanse space."},
    "Oct 10, 2026": {s: "Libra", w: "Mirror. Balance relations.", r: "Candle balance."},
    "Nov 9, 2026": {s: "Scorpio", w: "Shadow. Transform fear.", r: "Darkness sitting."},
    "Dec 8, 2026": {s: "Sagittarius", w: "Arrow. Aim high.", r: "Archer pose."}
  };

  const NEW_MOONS_ARRAY = ["Jan 18, 2026", "Feb 17, 2026", "Mar 18, 2026", "Apr 17, 2026", "May 16, 2026", "Jun 15, 2026", "Jul 14, 2026", "Aug 12, 2026", "Sep 11, 2026", "Oct 10, 2026", "Nov 9, 2026", "Dec 8, 2026"];

  const CELESTIAL_EVENTS = {
    "Feb 2": {n: "Imbolc Portal", d: "A sacred midpoint between Winter and Spring. The earth is stirring. Energy: Promise, Purification, First Light.", l: "spiritual meaning of imbolc"},
    "Aug 8": {n: "Lion's Gate Portal", d: "A massive alignment of Earth, Sirius, and the Sun. High-frequency light codes for ascension and bold manifestation.", l: "lions gate portal spiritual meaning"},
    "Nov 1": {n: "Samhain Portal", d: "The veil is thinnest. Ancestors are close. Energy: Commemorating the dead, Divination, Deep Roots.", l: "samhain spiritual significance"},
    "Feb 26": {n: "Mercury Retrograde Begins", d: "Communication turns inward. Do not fear; review. Energy: Reflection, Rewriting, Pausing.", l: "mercury retrograde spiritual meaning"},
    "Mar 20": {n: "Mercury Direct", d: "The shadow period clears. Move forward with the wisdom learned in the silence.", l: "mercury direct spiritual meaning"},
    "Jun 29": {n: "Mercury Retrograde Begins", d: "Thoughts turn nostalgic. Old friends may return. Energy: Reconnecting, Revisiting, Remembering.", l: "mercury retrograde in cancer spiritual meaning"},
    "Oct 21": {n: "Mercury Retrograde Begins", d: "Deep psychological review. Secrets are revealed for healing.", l: "mercury retrograde in scorpio spiritual meaning"},
    "Jan 1": {n: "Mars Retrograde", d: "Action turns passive. Anger requires understanding, not expression. Energy: Internal Drive, Patience.", l: "mars retrograde spiritual meaning"}
  };

  const MOON_ANCHORS = [
    {d: new Date(2026, 0, 3), n: "Wolf Moon"}, {d: new Date(2027, 0, 22), n: "Wolf Moon"}
  ];

  const SHADOW_WORK = {
    "Aries": "Where am I afraid to be weak, and does my anger protect a deeper hurt?",
    "Taurus": "What comfort zone has become a cage? What am I hoarding out of fear?",
    "Gemini": "What truth am I silencing to keep the peace? Where is my mind distracting my heart?",
    "Cancer": "What old wound am I nurturing instead of healing? Where do I need to mother myself?",
    "Leo": "Where do I seek validation from others instead of myself? What part of my light am I hiding?",
    "Virgo": "Where does my perfectionism stop me from living? What mess am I afraid to make?",
    "Libra": "Where am I compromising my soul to please another? What imbalance am I ignoring?",
    "Scorpio": "What secret am I keeping from myself? What needs to die so I can be reborn?",
    "Sagittarius": "What am I running away from? Does my quest for freedom hurt those I love?",
    "Capricorn": "Where have I let ambition silence my intuition? What burden is not mine to carry?",
    "Aquarius": "Where do I detach to avoid feeling? Am I observing life instead of living it?",
    "Pisces": "What reality am I escaping? Where do I need boundaries to protect my energy?"
  };

  function getDynamicContent(phase, zodiacSign, day) {
    try {
      if(!zodiacSign) return { whisper: "The stars are silent.", ritual: "Breathe." };
      const s = zodiacSign.split(' ')[0]; 
      const varIdx = day % 3; 
      let pKey = "Waxing";
      if (phase.includes("New")) pKey = "New";
      else if (phase.includes("Full")) pKey = "Full";
      else if (phase.includes("Waning") || phase.includes("Last")) pKey = "Waning";

      let whisper = `The moon in ${s} asks you to listen deeply today.`;
      let ritual = "Sit in silence and breathe.";
      if (DAILY_WISDOM_LIBRARY[s] && DAILY_WISDOM_LIBRARY[s][pKey]) {
        whisper = DAILY_WISDOM_LIBRARY[s][pKey][varIdx] || DAILY_WISDOM_LIBRARY[s][pKey][0];
      }
      if (DAILY_RITUALS[s]) {
        ritual = DAILY_RITUALS[s][varIdx] || DAILY_RITUALS[s][0];
      }
      return { whisper, ritual };
    } catch(err) { return { whisper: "Listen to your own heart.", ritual: "Light a candle." }; }
  }

  function getAffirmation(element) {
    const affirmations = { "FIRE": "I am the flame.", "EARTH": "I am the mountain.", "AIR": "I am the wind.", "WATER": "I am the river." };
    return affirmations[element] || "I am aligned.";
  }

  function getCelestialData(date) {
    try {
      const dStrFull = date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
      const dStrShort = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
      const jd = (date.getTime() / 86400000) + 2440587.5;
      const T = (jd - 2451545.0) / 36525;
      let moonLong = (218.316 + 481267.881 * T + 6.289 * Math.sin((135.27 + 477198.87 * T) * Math.PI / 180));
      moonLong = (moonLong + 5.0) % 360;
      if (moonLong < 0) moonLong += 360;
      
      const signs = ["Aries ‚ôà","Taurus ‚ôâ","Gemini ‚ôä","Cancer ‚ôã","Leo ‚ôå","Virgo ‚ôç","Libra ‚ôé","Scorpio ‚ôè","Sagittarius ‚ôê","Capricorn ‚ôë","Aquarius ‚ôí","Pisces ‚ôì"];
      const zodIndex = Math.floor(moonLong / 30);
      const zod = signs[zodIndex] || "Aries ‚ôà";
      const el = ZOD_ELEMENTS[zod] || "EARTH";
      
      let sunLong = (280.466 + 36000.770 * T) % 360;
      let angle = (moonLong - sunLong + 360) % 360;
      
      // Sun Sign Logic V83/V85
      const sunSigns = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
      const sunIndex = Math.floor(sunLong / 30);
      const sunZod = sunSigns[sunIndex] || "Aries";

      let isFull = FULL_MOONS_ARRAY.some(m => m.d === dStrFull);
      let isNew = NEW_MOONS_ARRAY.includes(dStrFull);
      
      let pivotData = PIVOT_DATA[dStrShort];
      let isPivot = !!pivotData;
      let isEvent = CELESTIAL_EVENTS[dStrShort];

      let phase = "Waning Crescent", ico = "üåò";
      if (isFull) { phase = "Full Moon"; ico = "üåï"; }
      else if (isNew) { phase = "New Moon"; ico = "üåë"; }
      else if (angle < 90) { phase = "Waxing Crescent"; ico = "üåí"; }
      else if (angle < 100) { phase = "First Quarter"; ico = "üåì"; }
      else if (angle < 180) { phase = "Waxing Gibbous"; ico = "üåî"; }
      else if (angle < 260) { phase = "Waning Gibbous"; ico = "üåñ"; }
      else if (angle < 280) { phase = "Last Quarter"; ico = "üåó"; }

      // V85: CORRECT LUNAR DAY LOGIC (New Moon = Day 1)
      let tDay = 1;
      let lastNM = new Date(NEW_MOONS_ARRAY[0]);
      for(let nmStr of NEW_MOONS_ARRAY) {
          let nmDate = new Date(nmStr);
          // If this NM is before or equal to today, it's the anchor
          if(nmDate <= date) lastNM = nmDate;
          else break;
      }
      let diffTime = date - lastNM;
      tDay = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
      if(tDay > 30) tDay = 1; // Fallback reset
      
      let whisper, ritual, affirm;
      let fullMoonData = FULL_MOON_DATA[dStrFull];
      let newMoonData = NEW_MOON_DATA[dStrFull];

      if (isPivot) {
        whisper = pivotData.w;
        ritual = pivotData.r;
        affirm = "I am balanced. I am whole.";
      } else if (isFull && fullMoonData) {
        whisper = fullMoonData.w;
        ritual = fullMoonData.r;
        affirm = "I am illuminated.";
      } else if (isNew && newMoonData) {
        whisper = newMoonData.w;
        ritual = newMoonData.r;
        affirm = "I am new.";
      } else {
        let content = getDynamicContent(phase, zod, date.getDate());
        whisper = content.whisper;
        ritual = content.ritual;
        affirm = getAffirmation(el);
      }
      
      let shadow = "";
      if (isNew) {
        shadow = SHADOW_WORK[zod.split(' ')[0]] || "What is hidden?";
      }

      if (dStrFull.includes("Jan 22, 2027")) {
         // Override logic for 13th moon handled by FULL_MOON_DATA lookup
      }

      return { phase, ico, zod, sunZod, tDay, el, elColor: ELEMENTS[el], dStr: dStrShort, year: date.getFullYear(), isFull, isNew, isPivot: pivotData, isEvent, archetype: fullMoonData, whisper, ritual, shadow, affirm };
    } catch(e) {
      console.log("Celestial Calc Error", e);
      return { phase: "Moon", ico: "üåë", zod: "Aries ‚ôà", sunZod: "Aries", tDay: 1, el: "FIRE", elColor: "#fff", dStr: "", year: 2026, isFull:false, isNew:false, isPivot:false, isEvent:false, archetype:null, whisper:"Quiet.", ritual:"Breathe.", shadow:"", affirm:"" };
    }
  }

  function render() {
    const grid = document.getElementById("calendar"); 
    if(!grid) return;
    grid.innerHTML = "";
    document.getElementById("monthLabel").innerText = `${activeD.toLocaleString('default', { month: 'long' }).toUpperCase()} ${activeD.getFullYear()}`;
    ["M","T","W","T","F","S","S"].forEach(l => grid.innerHTML += `<div class="day-label">${l}</div>`);
    const first = new Date(activeD.getFullYear(), activeD.getMonth(), 1);
    const last = new Date(activeD.getFullYear(), activeD.getMonth() + 1, 0).getDate();
    let offset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
    for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;
    
    const todayStr = new Date().toDateString();

    for(let i=1; i<=last; i++) {
      const d = new Date(activeD.getFullYear(), activeD.getMonth(), i);
      const data = getCelestialData(d);
      const cell = document.createElement("div");
      
      let classes = ['day'];
      if(d.toDateString() === selectedDate) classes.push('selected');
      if(d.toDateString() === todayStr) classes.push('today');
      if(data.isFull) classes.push('full-moon-day');
      if(data.isNew) classes.push('new-moon-day');
      if(data.isPivot || data.isEvent) classes.push('celestial-pivot');
      if(db.logs[d.toDateString()]) classes.push('period');
      
      cell.className = classes.join(' ');
      cell.innerHTML = `<span class="d-num">${i}</span><span class="t-num">${data.tDay}</span><span class="m-ico" style="filter: drop-shadow(0 0 5px ${data.elColor})">${data.ico}</span><span class="z-ico">${data.zod.split(' ')[0]}</span>`;
      cell.onclick = () => { selectedDate = d.toDateString(); updateDash(d); render(); };
      grid.appendChild(cell);
    }
  }

  function updateDash(date) {
    const data = getCelestialData(date);
    document.documentElement.style.setProperty('--aura', data.elColor);
    
    // V83/V85: Master Title Logic - Always include the emoji
    const titleText = data.archetype ? data.archetype.n.toUpperCase() : data.phase.toUpperCase();
    const displayTitle = `${titleText} ${data.ico}`;
    
    const titleEl = document.getElementById("dashTitle");
    titleEl.innerText = displayTitle; 
    titleEl.onclick = function() { openMasterModal(data); };
    
    document.getElementById("dashSub").innerText = `LUNAR DAY ${data.tDay} ‚Ä¢ ${data.dStr}, ${data.year}`;
    
    let eventHTML = "";
    if(data.isPivot && data.isPivot.n === "Spring Equinox") {
      eventHTML += `<div class="event-badge newyear-badge">HAPPY ANCESTRAL NEW YEAR! üå∏</div><br>`;
    } else if(data.isPivot) {
      eventHTML += `<div class="event-badge portal-badge">‚ú® ${data.isPivot.n.toUpperCase()}</div>`;
    }
    if(data.isEvent) eventHTML += `<div class="event-badge retro-badge">üëÅÔ∏è ${data.isEvent.n.toUpperCase()}</div>`;
    
    document.getElementById("eventDisplay").innerHTML = eventHTML;
    document.getElementById("guidanceText").innerText = data.whisper;
    document.getElementById("ritualText").innerText = data.ritual;
    document.getElementById("affirmationText").innerText = data.affirm;
    
    if (data.isNew && data.shadow) {
      document.getElementById("shadowCard").style.display = "block";
      document.getElementById("shadowText").innerText = data.shadow;
    } else {
      document.getElementById("shadowCard").style.display = "none";
    }
    
    const savedEnergy = db.energy[date.toDateString()];
    document.querySelectorAll('.energy-btn').forEach(btn => btn.classList.remove('active'));
    if(savedEnergy) {
      const map = {'fire':'e-fire','water':'e-water','air':'e-air','earth':'e-earth'};
      if(document.getElementById(map[savedEnergy])) document.getElementById(map[savedEnergy]).classList.add('active');
      const labels = {'fire':'FIRE: HIGH / CREATIVE','water':'WATER: EMOTIONAL / FLOW','air':'AIR: MENTAL / CLEAR','earth':'EARTH: REST / GROUNDED'};
      document.getElementById("energyLabel").innerText = labels[savedEnergy];
    } else {
      document.getElementById("energyLabel").innerText = "Select your dominant energy";
    }
    
    db.zodCache[date.toDateString()] = data.zod;
    localStorage.setItem('ancestral_moon_v85', JSON.stringify(db));
  }

  // V83/V85: UPDATED MASTER MODAL WITH SUN SEASON LINK
  function openMasterModal(data) {
    const modal = document.getElementById("cosmicModal");
    const title = document.getElementById("modalTitle");
    const content = document.getElementById("modalContent");
    const overlay = document.querySelector(".modal-overlay");
    
    title.innerText = "COSMIC ALIGNMENT";
    
    const zodiacName = data.zod.split(' ')[0];
    const zodiacMeaning = ZODIAC_WISDOM[zodiacName] || "Trust the stars.";
    const phaseMeaning = PHASE_MEANINGS[data.phase] || "A time of transition.";
    const elementMeaning = ELEMENT_MEANINGS[data.el] || "Balance your energy.";
    const sunMeaning = SUN_SIGN_DATA[data.sunZod] || "The Season of Life.";
    
    let html = `
    <div class="modal-section">
      <span class="modal-label" style="color:var(--portal)">SUN IN ${data.sunZod.toUpperCase()} (THE SEASON)</span>
      <div class="modal-content-text">${sunMeaning}</div>
      <a class="modal-link" href="https://www.google.com/search?q=sun+in+${data.sunZod}+season+spiritual+meaning" target="_blank">Explore ${data.sunZod} Season Energy</a>
    </div>
    <div class="modal-section">
      <span class="modal-label">MOON IN ${data.zod.toUpperCase()} (THE MOOD)</span>
      <div class="modal-content-text">${zodiacMeaning}</div>
      <a class="modal-link" href="https://www.google.com/search?q=moon+in+${zodiacName}+spiritual+meaning" target="_blank">Dive Deeper into ${zodiacName} Moon</a>
    </div>
    <div class="modal-section">
      <span class="modal-label">PHASE INTEL: ${data.phase.toUpperCase()}</span>
      <div class="modal-content-text">${phaseMeaning}</div>
      <a class="modal-link" href="https://www.google.com/search?q=${data.phase}+moon+spiritual+meaning" target="_blank">Explore ${data.phase} Energy</a>
    </div>
    <div class="modal-section" style="border-bottom:none;">
      <span class="modal-label" style="color:${data.elColor}">‚úß ${data.el} ENERGY ‚úß</span>
      <div class="modal-content-text">${elementMeaning}</div>
      <a class="modal-link" href="https://www.google.com/search?q=${data.el.toLowerCase()}+element+spiritual+meaning" target="_blank">Mastering ${data.el} Energy</a>
    </div>`;
    
    content.innerHTML = html;
    modal.style.display = "block";
    overlay.style.display = "block";
  }

  function setEnergy(val) {
    let map = {'üî•':'fire','üíß':'water','üå¨Ô∏è':'air','ü™®':'earth'};
    db.energy[selectedDate] = map[val];
    localStorage.setItem('ancestral_moon_v85', JSON.stringify(db));
    updateDash(new Date(selectedDate));
  }

  function closeModal() { document.getElementById("cosmicModal").style.display = "none"; document.querySelector(".modal-overlay").style.display = "none"; }

  function copySisterReport() {
    const d = new Date(selectedDate);
    const data = getCelestialData(d);
    let extra = data.isEvent ? `\nüåÄ Intel: ${data.isEvent.n}` : "";
    if (data.isPivot) extra = `\n‚ú® Portal: ${data.isPivot.n.n}`;
    let shadow = data.isNew ? `\nüåë Shadow Work: ${data.shadow}` : "";

    const report = `‚òæ Ancestral Moon Report: ${data.dStr}, ${data.year} ‚òΩ\nMoon: ${data.archetype ? data.archetype.n : data.phase}\nSign: ${data.zod} (${data.el})\n\nWhisper: ${document.getElementById("guidanceText").innerText}\n\nRitual: ${data.ritual}${shadow}${extra}\n\nSynced via The Ancestral Moon Map ‚ú®`;
    navigator.clipboard.writeText(report).then(() => alert("Report Copied!"));
  }

  function jumpToDate(dateStr) { selectedDate = dateStr; activeD = new Date(dateStr); render(); updateDash(activeD); showView('dash'); }
  function deleteEntry(dateStr) { if(confirm("Release this entry?")) { delete db.journals[dateStr]; delete db.logs[dateStr]; delete db.energy[dateStr]; localStorage.setItem('ancestral_moon_v85', JSON.stringify(db)); showView('grimoire'); } }

  function backupData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "ancestral_moon_backup.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  function restoreData(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedDb = JSON.parse(e.target.result);
        db = importedDb;
        localStorage.setItem('ancestral_moon_v85', JSON.stringify(db));
        alert("Grimoire Restored Successfully.");
        render(); updateDash(new Date(selectedDate)); showView('grimoire');
      } catch(err) { alert("Invalid backup file."); }
    };
    reader.readAsText(file);
  }

  function exportToCSV() {
    let csv = "Date,Moon Phase,Zodiac,Element,Flow,Energy,Journal Entry\n";
    const dates = Object.keys(db.journals).concat(Object.keys(db.logs), Object.keys(db.energy)).sort((a,b) => new Date(b) - new Date(a));
    const uniqueDates = [...new Set(dates)];
    
    uniqueDates.forEach(dStr => {
      const d = new Date(dStr);
      const celestial = getCelestialData(d);
      
      let flow = db.logs[dStr] ? "Yes" : "No";
      let energy = db.energy[dStr] ? db.energy[dStr].toUpperCase() : "N/A";
      let entry = db.journals[dStr] ? db.journals[dStr].replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""') : "";
      let phase = celestial.archetype ? celestial.archetype.n : celestial.phase;
      
      csv += `"${dStr}","${phase}","${celestial.zod}","${celestial.el}","${flow}","${energy}","${entry}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "grimoire_export.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function showView(view) {
    document.getElementById('oracleDash').style.display = 'none';
    document.getElementById('grimoireView').style.display = 'none';
    document.getElementById('yearlyView').style.display = 'none';
    if(view === 'dash') document.getElementById('oracleDash').style.display = 'block';
    
    if(view === 'grimoire') {
      const g = document.getElementById('grimoireView'); g.style.display = 'block';
      const cont = document.getElementById('grimoireContent'); cont.innerHTML = "";
      const dates = Object.keys(db.journals).concat(Object.keys(db.logs), Object.keys(db.energy)).sort((a,b) => new Date(b) - new Date(a));
      [...new Set(dates)].forEach(d => {
        if(db.journals[d] || db.logs[d] || db.energy[d]) {
          let en = db.energy[d] ? (db.energy[d] === 'fire' ? 'üî•' : db.energy[d] === 'water' ? 'üíß' : db.energy[d] === 'air' ? 'üå¨Ô∏è' : 'ü™®') : '';
          cont.innerHTML += `<div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; margin-bottom:10px; text-align:left; border-left:3px solid var(--aura);">
            <div style="font-size:0.6rem; color:var(--gold); display:flex; justify-content:space-between; margin-bottom:5px;"><span>${d} ‚Ä¢ ${db.zodCache[d] || 'Cosmos'}</span> <span>${en} ${db.logs[d] ? 'ü©∏' : ''}</span></div>
            <div style="font-family:'Charm'; font-size:1.1rem; color:#eee;">${db.journals[d] || "<i>Quiet.</i>"}</div>
            <div class="grim-actions"><button class="grim-btn" onclick="jumpToDate('${d}')">‚úèÔ∏è</button><button class="grim-btn" onclick="deleteEntry('${d}')">üóëÔ∏è</button></div>
          </div>`;
        }
      });
    }
    if(view === 'yearly') {
      document.getElementById('yearlyView').style.display = 'block';
      const yc = document.getElementById('yearlyContent'); yc.innerHTML = "";
      const currentYear = activeD.getFullYear();
      
      yc.innerHTML += `<h3 style="color:var(--gold); font-family:'Cinzel'; text-align:center;">${currentYear} CELESTIAL MAP</h3>`;
      
      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; margin-top:15px;">CELESTIAL PIVOTS</h4>`;
      for(let p in PIVOT_DATA) {
        if (p.includes("Equinox") || p.includes("Solstice") || PIVOT_DATA[p].n.includes("Equinox") || PIVOT_DATA[p].n.includes("Solstice")) {
             if(currentYear === 2027 && (p === "Sep 22" || p === "Dec 21")) continue; 
             if(currentYear === 2026 && (p === "Sep 23" || p === "Dec 22")) continue; 
             
             yc.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.7rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;"><span>‚ú® ${PIVOT_DATA[p].n}</span> <span>${p}</span></div>`;
        }
      }
      
      for(let e in CELESTIAL_EVENTS) yc.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.7rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0; color:var(--retro);"><span>üåÄ ${CELESTIAL_EVENTS[e].n}</span> <span>${e}</span></div>`;
      
      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; margin-top:20px;">13 FULL MOONS</h4>`;
      
      const yearFullMoons = FULL_MOONS_ARRAY.filter(m => m.d.includes(currentYear.toString()));
      yearFullMoons.forEach(m => {
        const arch = FULL_MOON_DATA[m.d] || {n:"Moon"};
        const displayDate = m.d.replace(`, ${currentYear}`, '');
        yc.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;"><span>üåï ${displayDate} - ${arch.n}</span> <span>${m.z}</span></div>`;
      });

      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; margin-top:20px;">13 NEW MOONS</h4>`;
      
      const yearNewMoons = NEW_MOONS_ARRAY.filter(d => d.includes(currentYear.toString()));
      
      yearNewMoons.forEach(dStrFull => {
        const d = new Date(dStrFull);
        const data = getCelestialData(d);
        const displayDate = dStrFull.replace(`, ${currentYear}`, '');
        yc.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0; color:var(--amethyst);"><span>üåë ${displayDate} - New Moon</span> <span>${data.zod}</span></div>`;
      });
    }
  }

  function saveData() { db.journals[selectedDate] = document.getElementById("journalInput").value; localStorage.setItem('ancestral_moon_v85', JSON.stringify(db)); }
  function toggleFlow() { db.logs[selectedDate] = !db.logs[selectedDate]; localStorage.setItem('ancestral_moon_v85', JSON.stringify(db)); render(); updateDash(new Date(selectedDate)); }
  function changeMonth(n) { activeD.setMonth(activeD.getMonth() + n); render(); }

  // V85: FINAL STAR ENGINE
  const sField = document.getElementById('starField');
  for(let i=0; i<200; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*2+'px'; s.style.height = s.style.width; // circular
    s.style.setProperty('--d', (Math.random()*4+2)+'s'); sField.appendChild(s);
  }

  render(); updateDash(new Date());
</script>
</body>
</html>
