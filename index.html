<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Ancestral Moon Map | V67 Infinite Weave</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Charm:wght@400;700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">
  <style>
    :root { 
      --space: #020105; --gold: #e6ccff; --glass: rgba(12, 6, 24, 0.96); 
      --blood: #ff3385; --aura: #9d50bb; --amethyst: #df80ff;
      --retro: #ff6b6b; --portal: #ffd700; --moon-glow: #a8e6cf; --zodiac: #99ccff;
    }
    body { 
      font-family: 'Quicksand', sans-serif; background: var(--space); 
      background-image: radial-gradient(circle at top, #1a0b2e 0%, var(--space) 100%); 
      color: #fdfbff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
    }
    .star-field { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--d) infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }

    #oracleDash, #grimoireView, #yearlyView { 
      width: 92%; max-width: 450px; background: var(--glass); backdrop-filter: blur(30px); 
      border: 1px solid rgba(230, 204, 255, 0.1); border-top: 3px solid var(--aura); 
      border-radius: 35px; padding: 20px; margin: 15px 0; box-shadow: 0 15px 50px rgba(0,0,0,0.9); text-align: center; display: none; position: relative;
    }
    #oracleDash { display: block; }

    #cosmicModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: rgba(15, 5, 25, 0.98); border: 2px solid var(--gold); border-radius: 25px; padding: 25px; z-index: 1000; text-align: center; box-shadow: 0 0 50px rgba(200, 180, 255, 0.3); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }

    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; width: 100%; max-width: 450px; margin-bottom: 10px; }
    .day-label { font-size: 0.55rem; color: var(--gold); font-family: 'Cinzel'; opacity: 0.6; }
    .day { background: rgba(255,255,255,0.02); border-radius: 10px; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1.5px solid transparent; cursor: pointer; transition: 0.3s; }
    
    .day.today { border: 2.5px solid var(--gold); box-shadow: 0 0 15px var(--gold); z-index: 2; }
    .day.full-moon-day { background: radial-gradient(circle, rgba(230, 204, 255, 0.3) 0%, transparent 70%); }
    .day.new-moon-day { background: radial-gradient(circle, rgba(75, 0, 130, 0.4) 0%, transparent 70%); }
    .day.celestial-pivot { border: 1.5px dashed var(--gold); }
    .day.selected { border: 1px solid #fff; background: rgba(255, 255, 255, 0.1); }
    .day.period { border-bottom: 3px solid var(--blood) !important; }

    .d-num { position: absolute; top: 4px; left: 6px; font-size: 0.55rem; opacity: 0.4; }
    .t-num { position: absolute; top: 4px; right: 6px; font-size: 0.55rem; color: var(--gold); font-weight: bold; }
    .m-ico { font-size: 1rem; margin-top: 5px; filter: drop-shadow(0 0 5px var(--aura)); }
    .z-ico { font-size: 0.45rem; color: var(--gold); margin-top: 2px; font-family: 'Cinzel'; }

    .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); border-radius: 15px; padding: 8px 12px; font-family: 'Cinzel'; font-size: 0.6rem; margin: 5px; }
    .cycle-btn { border: 1.5px solid var(--blood); color: var(--blood); background: transparent; padding: 14px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.8rem; width: 100%; margin-top: 15px; transition: 0.3s; }
    .cycle-btn.active { background: var(--blood); color: white; box-shadow: 0 0 15px var(--blood); }
    .sister-btn { background: rgba(255,255,255,0.05); color: var(--gold); border: 1px solid var(--aura); padding: 10px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.65rem; width: 100%; margin-top: 10px; }
    .explore-btn { background: var(--gold); color: var(--space); border: none; padding: 10px 25px; border-radius: 20px; font-family: 'Cinzel'; font-size: 0.75rem; margin-top: 15px; cursor: pointer; text-decoration: none; display: inline-block; box-shadow: 0 0 15px var(--gold); }

    .wisdom-card { text-align: left; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 25px; border-left: 3px solid var(--aura); margin-bottom: 15px; }
    .wisdom-label { font-family: 'Cinzel'; font-size: 0.6rem; color: var(--gold); letter-spacing: 2px; display: block; margin-bottom: 8px; }
    .wisdom-text { font-family: 'Charm'; font-size: 1.2rem; line-height: 1.5; color: #eee; }
    
    .energy-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .energy-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 8px; flex: 1; margin: 0 3px; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
    .energy-btn.active { background: var(--aura); border-color: var(--gold); box-shadow: 0 0 10px var(--aura); transform: scale(1.1); }
    .energy-label { font-family: 'Cinzel'; font-size: 0.55rem; color: var(--gold); margin-bottom: 15px; height: 10px; letter-spacing: 1px; }

    #journalInput { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; color: #fff; font-family: 'Charm'; font-size: 1.2rem; min-height: 100px; box-sizing: border-box; outline: none; }
    
    .event-badge { font-size: 0.6rem; padding: 4px 12px; border-radius: 15px; display: inline-block; margin-bottom: 5px; font-family: 'Cinzel'; letter-spacing: 1px; cursor: pointer; }
    .portal-badge { background: var(--portal); color: var(--space); box-shadow: 0 0 10px var(--portal); }
    .retro-badge { background: var(--retro); color: var(--space); box-shadow: 0 0 10px var(--retro); }
    .moon-badge { background: var(--moon-glow); color: var(--space); box-shadow: 0 0 10px var(--moon-glow); }
    .zodiac-badge { background: var(--zodiac); color: var(--space); box-shadow: 0 0 10px var(--zodiac); }
    .newyear-badge { background: linear-gradient(90deg, #2ecc71, #df80ff); color: white; box-shadow: 0 0 20px #2ecc71; padding: 8px 20px; font-size: 0.75rem; border: 1px solid white; cursor: pointer;}
    
    .grim-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; }
    .grim-btn { background: transparent; border: none; color: #aaa; font-size: 0.9rem; cursor: pointer; }
    .support-link { margin-top: 20px; font-size: 0.7rem; color: var(--gold); opacity: 0.7; cursor: pointer; text-decoration: underline; font-family: 'Cinzel'; display: block; }
    
    /* Backup Controls */
    .backup-section { border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 20px; }
    .backup-title { font-family: 'Cinzel'; font-size: 0.7rem; color: var(--gold); margin-bottom: 10px; display:block;}
    .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .backup-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); padding: 10px; border-radius: 10px; font-family: 'Cinzel'; font-size: 0.6rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .backup-btn:hover { background: rgba(255,255,255,0.1); }
    .export-btn { background: var(--aura); border: none; color: white; grid-column: span 2; }
  </style>
</head>
<body>

<div class="star-field" id="starField"></div>

<div style="display: flex; justify-content: space-between; width: 92%; max-width: 450px;">
  <button class="nav-btn" onclick="showView('yearly')">YEARLY MAP</button>
  <button class="nav-btn" onclick="showView('grimoire')">MY HISTORY</button>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 450px; margin: 10px 0;">
  <span style="cursor:pointer; font-size: 2rem; color:var(--gold);" onclick="changeMonth(-1)">‚òæ</span>
  <h3 id="monthLabel" style="font-family:'Cinzel'; letter-spacing: 4px; margin:0; font-size: 1rem;"></h3>
  <span style="cursor:pointer; font-size: 2rem; color:var(--gold);" onclick="changeMonth(1)">‚òΩ</span>
</div>

<div id="calendar"></div>

<div id="oracleDash">
  <div id="eventDisplay"></div>
  <div id="elementTag" style="font-size: 0.5rem; letter-spacing: 1.5px; color: var(--aura); font-weight: bold; margin-bottom: 5px;"></div>
  <span id="detailedPhase" style="font-family: 'Cinzel'; font-size: 0.75rem; color: var(--gold); opacity: 0.9; letter-spacing: 3px; font-weight: bold;"></span>
  <h2 id="dashTitle" style="font-family:'Cinzel'; margin: 5px 0; color:var(--gold); letter-spacing: 3px; font-size: 1.3rem;"></h2>
  <div id="dashSub" style="font-size: 0.6rem; letter-spacing: 2px; margin-bottom: 20px; opacity: 0.8; font-family: 'Cinzel';"></div>
  
  <div class="wisdom-card">
    <span class="wisdom-label">ANCESTRAL WHISPER</span>
    <div class="wisdom-text" id="guidanceText"></div>
  </div>

  <div class="wisdom-card" id="shadowCard" style="display:none; border-left: 3px solid var(--retro);">
    <span class="wisdom-label" style="color:var(--retro);">SHADOW WORK INQUIRY</span>
    <div class="wisdom-text" id="shadowText"></div>
  </div>

  <div class="wisdom-card">
    <span class="wisdom-label">SACRED EARTH RITUAL</span>
    <div class="wisdom-text" id="ritualText"></div>
  </div>

  <div class="energy-row">
    <div class="energy-btn" onclick="setEnergy('üî•')" id="e-fire">üî•</div>
    <div class="energy-btn" onclick="setEnergy('üíß')" id="e-water">üíß</div>
    <div class="energy-btn" onclick="setEnergy('üå¨Ô∏è')" id="e-air">üå¨Ô∏è</div>
    <div class="energy-btn" onclick="setEnergy('ü™®')" id="e-earth">ü™®</div>
  </div>
  <div id="energyLabel" class="energy-label">Select your dominant energy</div>

  <textarea id="journalInput" placeholder="Scribe your soul's journey..." oninput="saveData()"></textarea>
  
  <div style="display: flex; flex-direction: column; gap: 5px;">
    <button id="flowBtn" class="cycle-btn" onclick="toggleFlow()">MARK MOON FLOW</button>
    <button class="sister-btn" onclick="copySisterReport()">
      <span>‚ú®</span> SHARE SISTER REPORT <span>‚ú®</span>
    </button>
  </div>
</div>

<div class="modal-overlay" onclick="closeModal()"></div>
<div id="cosmicModal">
  <h2 id="modalTitle" style="font-family:'Cinzel'; color:var(--gold);"></h2>
  <div id="modalText" style="font-family:'Charm'; font-size:1.1rem; color:#fff; margin:20px 0;"></div>
  <div id="sunMoonDistinction" style="font-size: 0.7rem; color: var(--zodiac); border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px; font-family: 'Quicksand'; font-style: italic; display:none;">
    Note: The Sun Sign is your external Season. This tracks your Moon Sign‚Äîyour internal emotional tide.
  </div>
  <a id="modalLink" href="#" target="_blank" class="explore-btn">EXPLORE DEEPER</a>
</div>

<div id="grimoireView">
  <span style="float:right; cursor:pointer;" onclick="showView('dash')">‚úï</span>
  <h2 style="font-family:'Cinzel';">MY SACRED HISTORY</h2>
  <div style="font-size:0.6rem; margin-bottom:10px; opacity:0.6;">Your journey is sacred. Export to view your patterns.</div>
  
  <div class="backup-section">
    <span class="backup-title">DATA MANAGEMENT</span>
    <div class="backup-grid">
        <button class="backup-btn export-btn" onclick="exportToCSV()">üìä EXPORT SPREADSHEET (READABLE)</button>
        <button class="backup-btn" onclick="backupData()">‚¨áÔ∏è BACKUP (FILE)</button>
        <button class="backup-btn" onclick="document.getElementById('restoreInput').click()">‚¨ÜÔ∏è RESTORE</button>
    </div>
    <input type="file" id="restoreInput" style="display:none" onchange="restoreData(this)">
  </div>
  
  <div id="grimoireContent" style="max-height: 350px; overflow-y: auto; margin-top: 15px;"></div>
  <a class="support-link" href="https://ko-fi.com/theancientrhythm" target="_blank">Created with Love ‚Ä¢ Support the Journey</a>
</div>

<div id="yearlyView">
  <span style="float:right; cursor:pointer;" onclick="showView('dash')">‚úï</span>
  <h2 style="font-family:'Cinzel'; font-size: 1rem;">CELESTIAL TIMELINE</h2>
  <div id="yearlyContent" style="text-align: left; padding: 10px; font-size: 0.75rem;"></div>
</div>

<script>
  let activeD = new Date(2026, 0, 16); 
  let selectedDate = new Date().toDateString();
  let db = JSON.parse(localStorage.getItem('ancestral_moon_v67')) || { logs: {}, journals: {}, zodCache: {}, energy: {} };

  const ELEMENTS = { "FIRE": "#ff4d4d", "EARTH": "#2ecc71", "AIR": "#3498db", "WATER": "#df80ff" };
  const ZOD_ELEMENTS = { "Aries ‚ôà":"FIRE", "Leo ‚ôå":"FIRE", "Sagittarius ‚ôê":"FIRE", "Taurus ‚ôâ":"EARTH", "Virgo ‚ôç":"EARTH", "Capricorn ‚ôë":"EARTH", "Gemini ‚ôä":"AIR", "Libra ‚ôé":"AIR", "Aquarius ‚ôí":"AIR", "Cancer ‚ôã":"WATER", "Scorpio ‚ôè":"WATER", "Pisces ‚ôì":"WATER" };
  
  const ZODIAC_WISDOM = {
    "Aries": "When the Moon is in Aries, the soul craves action. You may feel a spark of divine impulse. It is a time for warrior energy‚Äîbeginning, initiating, and bold courage.",
    "Taurus": "Moon in Taurus calls for grounding. Your internal tide slows down to honor the senses. Root yourself in pleasure, food, and the tangible earth.",
    "Gemini": "A Gemini Moon quickens the mind. The air is alive with curiosity. Your soul wants to speak, connect, and weave stories. Listen to the wind.",
    "Cancer": "The Moon is at home in Cancer. Emotions flow like deep rivers. It is a time for the shell‚Äîturn inward, nurture the self, and honor the mother wound.",
    "Leo": "Moon in Leo demands the heart be open. You are sovereign. Your soul seeks expression, warmth, and the courage to shine without apology.",
    "Virgo": "In Virgo, the Moon asks for sacred order. It is a time to purify the temple of the body. Healing comes through ritual, detail, and service to the self.",
    "Libra": "A Libra Moon seeks harmony. The soul looks for its reflection in others. Balance beauty with truth; relationship is the mirror of the moment.",
    "Scorpio": "Moon in Scorpio is the descent into the underworld. The tide is deep and dark. Secrets, transformation, and rebirth are accessible now.",
    "Sagittarius": "The Sagittarian Moon pulls the bow back. The soul seeks expansion, truth, and the horizon. Trust the quest and the wild unknown.",
    "Capricorn": "Moon in Capricorn builds the legacy. Emotions become structure. It is a time for the elder within to speak‚Äîpatience, ambition, and power.",
    "Aquarius": "In Aquarius, the Moon looks to the future. You may feel detached yet connected to the whole. Honor the rebel spirit and the cosmic web.",
    "Pisces": "The Pisces Moon dissolves boundaries. You are one with the ocean. Dreams are vivid, intuition is loud, and the veil is thin."
  };

  const SHADOW_WORK = {
    "Aries": "Where am I afraid to be weak, and does my anger protect a deeper hurt?",
    "Taurus": "What comfort zone has become a cage? What am I hoarding out of fear?",
    "Gemini": "What truth am I silencing to keep the peace? Where is my mind distracting my heart?",
    "Cancer": "What old wound am I nurturing instead of healing? Where do I need to mother myself?",
    "Leo": "Where do I seek validation from others instead of myself? What part of my light am I hiding?",
    "Virgo": "Where does my perfectionism stop me from living? What mess am I afraid to make?",
    "Libra": "Where am I compromising my soul to please another? What imbalance am I ignoring?",
    "Scorpio": "What secret am I keeping from myself? What needs to die so I can be reborn?",
    "Sagittarius": "What am I running away from? Does my quest for freedom hurt those I love?",
    "Capricorn": "Where have I let ambition silence my intuition? What burden is not mine to carry?",
    "Aquarius": "Where do I detach to avoid feeling? Am I observing life instead of living it?",
    "Pisces": "What reality am I escaping? Where do I need boundaries to protect my energy?"
  };

  const CELESTIAL_EVENTS = {
    "Feb 2": {n: "Imbolc Portal", d: "A sacred midpoint between Winter and Spring. The earth is stirring. Energy: Promise, Purification, First Light.", l: "spiritual meaning of imbolc"},
    "Aug 8": {n: "Lion's Gate Portal", d: "A massive alignment of Earth, Sirius, and the Sun. High-frequency light codes for ascension and bold manifestation.", l: "lions gate portal spiritual meaning"},
    "Nov 1": {n: "Samhain Portal", d: "The veil is thinnest. Ancestors are close. Energy: Commemorating the dead, Divination, Deep Roots.", l: "samhain spiritual significance"},
    "Feb 26": {n: "Mercury Retrograde Begins", d: "Communication turns inward. Do not fear; review. Energy: Reflection, Rewriting, Pausing.", l: "mercury retrograde spiritual meaning"},
    "Mar 20": {n: "Mercury Direct", d: "The shadow period clears. Move forward with the wisdom learned in the silence.", l: "mercury direct spiritual meaning"},
    "Jun 29": {n: "Mercury Retrograde Begins", d: "Thoughts turn nostalgic. Old friends may return. Energy: Reconnecting, Revisiting, Remembering.", l: "mercury retrograde in cancer spiritual meaning"},
    "Oct 21": {n: "Mercury Retrograde Begins", d: "Deep psychological review. Secrets are revealed for healing.", l: "mercury retrograde in scorpio spiritual meaning"},
    "Jan 1": {n: "Mars Retrograde", d: "Action turns passive. Anger requires understanding, not expression. Energy: Internal Drive, Patience.", l: "mars retrograde spiritual meaning"}
  };

  const PIVOTS = {
    "Mar 20": {n: "Spring Equinox", d: "The Ancestral New Year. Balance of day and night. Life bursts forth from the void. Energy: Rebirth, New Beginnings, Balance.", l: "spring equinox spiritual meaning"},
    "Jun 21": {n: "Summer Solstice", d: "The longest day. The sun is at its peak power. Celebrate the fullness of life. Energy: Vitality, Passion, Illumination.", l: "summer solstice spiritual meaning"},
    "Sep 22": {n: "Autumn Equinox", d: "The second harvest. Day and night equal again. We begin the descent into the inner world. Energy: Balance, Release, Gratitude.", l: "autumn equinox spiritual meaning"},
    "Dec 21": {n: "Winter Solstice", d: "The longest night. The return of the light. We honor the stillness and the spark in the dark. Energy: Rest, Hope, Rebirth.", l: "winter solstice spiritual meaning"}
  };

  // üåÄ V67 LIVING WISDOM ENGINE
  // Format: [Phase Type] -> [Zodiac] -> [Variations]
  function generateDailyWisdom(phase, sign, dayNum) {
    const s = sign.split(' ')[0]; // remove emoji
    // Fallback basics for variety
    const basics = [
      `The energy of ${s} colors the ${phase} moon. Listen to your intuition today.`,
      `With the moon in ${s}, your soul asks you to focus on ${ZOD_ELEMENTS[sign]} energy.`,
      `A ${phase} in ${s} is a powerful time to align your internal tide.`
    ];

    // Specific Phase + Sign Logic (The Matrix of 96)
    const library = {
      "Aries": {
        "Waxing": ["The spark has caught. Aries asks you to fan the flame with bold action.", "Do not hesitate. The warrior spirit of Aries supports your forward movement now.", "Initiate. The waxing energy combined with Aries fire creates a portal for new beginnings."],
        "Waning": ["Release the anger that no longer serves you. Let the fire burn down to embers.", "Aries energy turns inward. Reflect on where you fought too hard and where you need rest.", "Shed the need to be first. There is wisdom in the pause."],
        "Full": ["Your passion is a beacon. Illuminate your desires with the fullness of Aries fire.", "A climax of courage. Stand tall and declare your sovereignty to the cosmos.", "The warrior stands in the light. What victory are you celebrating today?"],
        "New": ["In the dark, a seed of fire waits. Set a bold intention that scares you a little.", "The void is potential. Aries asks you to dream of a new conquest.", "Silence before the strike. Gather your energy for the cycle ahead."]
      },
      "Taurus": {
        "Waxing": ["Build slowly. Taurus asks you to lay one brick at a time with love.", "Nourish the growing seed. Attend to your physical body as a temple.", "Ground your intentions. Make them tangible, real, and rooted in the earth."],
        "Waning": ["Release physical clutter. Return what you do not need to the soil.", "Compost the excess. Taurus asks you to find value in simplicity.", "Let go of stubbornness. Like the earth, allow yourself to be reshaped by the seasons."],
        "Full": ["A harvest of pleasure. Celebrate the abundance in your hands right now.", "The senses are heightened. Honor the body with good food, scent, and touch.", "Manifestation in form. What you have built is solid. Give thanks."],
        "New": ["Plant deep. The soil is rich and dark. Sow seeds of long-term worth.", "A quiet moment to set intentions for security and peace.", "Rest in the earth's embrace. You are safe to dream of abundance."]
      },
      "Gemini": {
        "Waxing": ["Speak your truth. The waxing moon carries your words on the wind.", "Connect ideas. Gemini asks you to weave a new story for your life.", "Curiosity is the key. Follow the thread of interest wherever it leads."],
        "Waning": ["Quiet the mind. Release the spinning thoughts to the breeze.", "Unlearn. Let go of old narratives that keep you small.", "The wind settles. Find the silence between the words."],
        "Full": ["Illuminate the mind. A realization comes in a flash of clarity.", "The conversation is open. Speak clearly and listen deeply.", "A whirlwind of connection. Share your light with your community."],
        "New": ["Plant a thought-form. The air is still and ready for a new word.", "Set an intention for communication. What do you need to say?", "A blank page. The Gemini new moon asks you to write the first line."]
      },
      "Cancer": {
        "Waxing": ["Nurture the dream. Protect your growing intentions like a mother.", "Flow with the rising tide. Trust your emotional guidance system.", "Build a shell of safety. You grow best when you feel secure."],
        "Waning": ["Release the emotional weight. Cry if you need to; it cleanses the soul.", "Let the tide go out. Forgive the past so you can move freely.", "Return to the source. The waters are receding to reveal the truth."],
        "Full": ["Overflowing heart. Let your emotions spill over; they are holy.", "The Mother shines. Honor your lineage and the women who came before.", "A high tide of intuition. Trust what you feel, even if you cannot explain it."],
        "New": ["The womb of the world. Rest in the dark waters of creation.", "Set an intention for home and family. Plant love in the center.", "Retreat inward. The crab finds safety in the sand to dream."]
      },
      "Leo": {
        "Waxing": ["Shine. The growing moon asks you to take up space.", "Create. Leo energy demands that you express your unique soul.", "Play. Approach your goals with the joy of a child."],
        "Waning": ["Release the need for applause. Your worth is internal.", "Let the ego rest. The sun sets so the stars can shine.", "Shed the performance. Who are you when no one is watching?"],
        "Full": ["Radiance. You are the sun center of your own universe today.", "Heart-centered power. Lead with love and others will follow.", "Celebrate yourself. It is not vanity; it is recognizing the divine within."],
        "New": ["A seed of creativity. What art waits in the dark to be born?", "Set an intention for joy. Where do you need more play?", "The heart's desire. Listen to the steady beat of your own truth."]
      },
      "Virgo": {
        "Waxing": ["Refine the plan. God is in the details.", "Attend to the daily rituals. Small steps lead to the summit.", "Purify your intent. Virgo asks for clarity and service."],
        "Waning": ["Cleanse. Sweep the mental and physical dust away.", "Release perfectionism. You are enough exactly as you are.", "Analyze what worked and let go of what failed."],
        "Full": ["The priestess stands tall. Your service is your magic.", "Order from chaos. See the pattern in the weaving.", "Healing light. Focus on the wholeness of the body."],
        "New": ["Plant a seed of order. Organize your inner world.", "Set an intention for health. Your body is the vessel.", "Quiet service. How can you serve your soul in the dark?"]
      },
      "Libra": {
        "Waxing": ["Balance the scales. Move forward with grace and diplomacy.", "Beautify your path. Libra asks you to find the art in the journey.", "Connect. Partnership aids your growth right now."],
        "Waning": ["Release the need to please. Harmony starts within.", "Let go of indecision. Trust the choice you made.", "Unbind yourself from the expectations of others."],
        "Full": ["Mirror magic. The world reflects your internal state.", "A climax of beauty. Surround yourself with what you love.", "Justice and harmony. Seek the middle path in the full light."],
        "New": ["Set an intention for peace. Where do you need balance?", "Sow seeds of partnership. Call in your divine mirrors.", "Rest in equilibrium. The scales are still."]
      },
      "Scorpio": {
        "Waxing": ["Dive deep. The surface is not where the treasure lies.", "Invest your energy. Scorpio asks for total commitment.", "Trust your gut. The mystery is unfolding."],
        "Waning": ["Shed the skin. Transformation requires letting go of the old form.", "Release the grudge. Poison only hurts the vessel that holds it.", "The compost of the soul. Let the dead leaves feed the roots."],
        "Full": ["The Phoenix rises. A powerful time for rebirth and revelation.", "Secrets revealed. Look at the shadow with compassion.", "Intense magic. Your power is potent; use it wisely."],
        "New": ["The void. Sit in the absolute dark and do not be afraid.", "Set an intention for transformation. What must die to be born?", "Plant a secret. Keep your magic hidden while it germinates."]
      },
      "Sagittarius": {
        "Waxing": ["Aim high. The arrow flies further than you think.", "Explore. Say yes to the adventure calling your name.", "Expand your vision. Look beyond the horizon."],
        "Waning": ["Release the dogma. Let go of 'being right' to find truth.", "Simplify the quest. Carry only what you need.", "The wanderer rests. Find wisdom in the stillness."],
        "Full": ["The truth illuminates. See the big picture clearly.", "Wild celebration. Dance with the cosmos tonight.", "The teacher speaks. Share your wisdom with the world."],
        "New": ["Plant a seed of freedom. Where do you want to roam?", "Set an intention for truth. Seek the philosophy that frees you.", "The dark horizon. Trust that the path is there even if you cannot see it."]
      },
      "Capricorn": {
        "Waxing": ["Climb. The mountain is steep but you are strong.", "Commit. Capricorn energy rewards discipline and structure.", "Build the legacy. Every stone matters."],
        "Waning": ["Release the burden. You do not have to carry the world.", "Let go of the rigid plan. Flow around the obstacle.", "The Elder rests. Wisdom comes from silence, not just work."],
        "Full": ["The summit. Look at how far you have come.", "Power manifested. Own your authority in this life.", "Structure and light. Your foundations are illuminated."],
        "New": ["Blueprint in the dark. Plan the empire you wish to build.", "Set an intention for career and purpose. What is your Great Work?", "Ground your ambition. Root it in the earth before climbing."]
      },
      "Aquarius": {
        "Waxing": ["Innovate. Try a new way of doing the old thing.", "Connect with the web. Your vibration affects the collective.", "Break the mold. Freedom is your fuel."],
        "Waning": ["Release the detachment. Come back to your heart.", "Let go of the need to be different. Just be.", "Clear the static. Tune your frequency to a clearer channel."],
        "Full": ["Cosmic connection. You are a star in a vast constellation.", "The Rebel shines. Stand for what you believe in.", "A vision of the future. See what is possible for humanity."],
        "New": ["Download the vision. The frequency is open for new ideas.", "Set an intention for freedom. Where do you need space?", "Plant a seed for the collective. Dream for the world."]
      },
      "Pisces": {
        "Waxing": ["Dream. The veil is thin; listen to the whispers.", "Flow. Do not push the river; float with it.", "Create from the soul. Art is your prayer."],
        "Waning": ["Dissolve. Let the boundaries melt away.", "Release the illusion. Surrender to the great ocean.", "Cleansing rain. Wash away the sorrow of the world."],
        "Full": ["Mystical union. You are one with the divine.", "The dreamer awakens. Intuition is at its peak.", "Ocean of light. Bathe in the spiritual waters."],
        "New": ["The womb of the universe. Anything is possible in the void.", "Set an intention for spiritual connection. Pray.", "Drift in the silence. Let the current take you where you need to go."]
      }
    };

    // Determine broad phase key for library lookup
    let pKey = "Waxing";
    if (phase.includes("New")) pKey = "New";
    else if (phase.includes("Full")) pKey = "Full";
    else if (phase.includes("Waning") || phase.includes("Last")) pKey = "Waning";

    // Get variation based on day number to ensure daily rotation
    const variation = (dayNum % 3);
    
    if (library[s] && library[s][pKey]) {
      return library[s][pKey][variation];
    } else {
      return basics[variation];
    }
  }

  function getDailyRitual(phase, sign, dayNum) {
    const s = sign.split(' ')[0];
    const rituals = {
      "Aries": ["Light a red candle and stare into the flame.", "Move your body vigorously for 5 minutes.", "Stand in the sun and breathe in fire."],
      "Taurus": ["Walk barefoot on the grass.", "Eat a piece of fruit slowly, savoring every bite.", "Hold a smooth stone in your palm."],
      "Gemini": ["Write a letter to your future self.", "Stand in the wind and whisper your wish.", "Burn incense and watch the smoke dance."],
      "Cancer": ["Take a ritual bath with salt.", "Place a bowl of water under the moon.", "Hold your hand over your heart and breathe."],
      "Leo": ["Wear something gold or yellow.", "Dance to your favorite song alone.", "Sun gaze safely at sunrise or sunset."],
      "Virgo": ["Clean one corner of your room mindfully.", "Drink herbal tea with intention.", "Write a list of what you are grateful for."],
      "Libra": ["Light two candles for balance.", "Place fresh flowers on your altar.", "Meditate on the sound of a bell."],
      "Scorpio": ["Sit in total darkness and silence.", "Write a secret on paper and burn it.", "Place a bowl of water in the dark."],
      "Sagittarius": ["Walk in a new direction today.", "Light a purple candle for wisdom.", "Look at the horizon and dream."],
      "Capricorn": ["Stand like a mountain, unmoving.", "Plant a seed in a small pot.", "Hold a piece of quartz or rock."],
      "Aquarius": ["Meditate on the stars.", "Open a window and breathe fresh air.", "Visualize a web of light connecting us all."],
      "Pisces": ["Listen to the sound of rain or water.", "Dip your feet in water.", "Sleep with a crystal under your pillow."]
    };
    return rituals[s] ? rituals[s][dayNum % 3] : "Sit in silence and breathe.";
  }

  const FULL_MOON_DATA = {
    "Jan 3": {n: "Wolf Moon", t: "Endurance", r: "Light a white candle. Stand in the cold air and hum your deepest truth. Imagine your voice joining the howl of your lineage.", l: "wolf moon spiritual meaning"},
    "Feb 1": {n: "Snow Moon", t: "Purity", r: "Gather clean snow or ice in a bowl. As it melts, whisper the fears you wish to dissolve. Pour the water into the earth.", l: "snow moon spiritual meaning"},
    "Mar 3": {n: "Worm Moon", t: "Awakening", r: "Stand barefoot on the earth or floor. Pulse your toes. Feel the vibration of the life force waking up beneath you.", l: "worm moon spiritual meaning"},
    "Apr 2": {n: "Pink Moon", t: "Emergence", r: "Dip a pink flower or stone in water. Anoint your heart and forehead. Declare: 'I am blooming without apology.'", l: "pink moon spiritual meaning"},
    "May 1": {n: "Flower Moon", t: "Potential", r: "Create a mandala of leaves and petals on the ground. Sit in the center and breathe in the abundance of the garden.", l: "flower moon spiritual meaning"},
    "May 31": {n: "Strawberry Moon", t: "Vitality", r: "Eat a sweet fruit mindfully. Feel the nectar as the physical manifestation of your own hard-earned sweetness.", l: "strawberry moon spiritual meaning"},
    "Jun 29": {n: "Buck Moon", t: "Abundance", r: "Stand tall, reaching arms high like antlers. Claim your space. Visualize your spirit connecting heaven and earth.", l: "buck moon spiritual meaning"},
    "Jul 29": {n: "Sturgeon Moon", t: "Power", r: "Submerge your hands in a bowl of water. Ask the ancient spirits of the deep for the resilience to swim against the current.", l: "sturgeon moon spiritual meaning"},
    "Aug 28": {n: "Harvest Moon", t: "Gratitude", r: "Hold a handful of grains or seeds. Name three things you have harvested this cycle. Offer the seeds to the birds or soil.", l: "harvest moon spiritual meaning"},
    "Sep 26": {n: "Hunter's Moon", t: "Release", r: "Focus on a flame. Identify one habit you are hunting down to release. Blow out the candle to seal the end of that cycle.", l: "hunter's moon spiritual meaning"},
    "Oct 25": {n: "Beaver Moon", t: "Preparation", r: "Physically clean your altar or sacred space. Light incense to clear the air. Prepare your inner temple for winter.", l: "beaver moon spiritual meaning"},
    "Nov 24": {n: "Cold Moon", t: "Stillness", r: "Sit in total darkness for 5 minutes. Find the internal light that glows when the external world is frozen.", l: "cold moon spiritual meaning"},
    "Dec 24": {n: "Long Night Moon", t: "Dreaming", r: "Place mugwort or lavender under your pillow. Ask your ancestors to speak to you in the dreamtime tonight.", l: "long night moon spiritual meaning"},
    "Jan 22, 2027": {n: "Threshold Moon", t: "Wisdom", r: "Stand in a doorway. Step through with your right foot, consciously leaving the old cycle behind.", l: "spiritual meaning of 13th moon"}
  };

  const MOON_ANCHORS = [
    {d: new Date(2026, 0, 3), n: "Wolf Moon"}, {d: new Date(2026, 1, 1), n: "Snow Moon"}, {d: new Date(2026, 2, 3), n: "Worm Moon"}, {d: new Date(2026, 3, 2), n: "Pink Moon"}, {d: new Date(2026, 4, 1), n: "Flower Moon"}, {d: new Date(2026, 4, 31), n: "Strawberry Moon"}, {d: new Date(2026, 5, 29), n: "Buck Moon"}, {d: new Date(2026, 6, 29), n: "Sturgeon Moon"}, {d: new Date(2026, 7, 28), n: "Harvest Moon"}, {d: new Date(2026, 8, 26), n: "Hunter's Moon"}, {d: new Date(2026, 9, 25), n: "Beaver Moon"}, {d: new Date(2026, 10, 24), n: "Cold Moon"}, {d: new Date(2026, 11, 24), n: "Long Night Moon"}
  ];

  const FULL_MOONS = [{d: "Jan 3", z: "Cancer ‚ôã"}, {d: "Feb 1", z: "Leo ‚ôå"}, {d: "Mar 3", z: "Virgo ‚ôç"}, {d: "Apr 2", z: "Libra ‚ôé"}, {d: "May 1", z: "Scorpio ‚ôè"}, {d: "May 31", z: "Sagittarius ‚ôê"}, {d: "Jun 29", z: "Capricorn ‚ôë"}, {d: "Jul 29", z: "Aquarius ‚ôí"}, {d: "Aug 28", z: "Pisces ‚ôì"}, {d: "Sep 26", z: "Aries ‚ôà"}, {d: "Oct 25", z: "Taurus ‚ôâ"}, {d: "Nov 24", z: "Gemini ‚ôä"}, {d: "Dec 24", z: "Cancer ‚ôã"}];
  const NEW_MOONS = ["Jan 18", "Feb 17", "Mar 18", "Apr 17", "May 16", "Jun 15", "Jul 14", "Aug 12", "Sep 11", "Oct 10", "Nov 9", "Dec 8"];

  function getCelestialData(date) {
    const dStr = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    const jd = (date.getTime() / 86400000) + 2440587.5;
    const T = (jd - 2451545.0) / 36525;
    let moonLong = (218.316 + 481267.881 * T + 6.289 * Math.sin((135.27 + 477198.87 * T) * Math.PI / 180));
    moonLong = (moonLong + 5.0) % 360; 
    const signs = ["Aries ‚ôà","Taurus ‚ôâ","Gemini ‚ôä","Cancer ‚ôã","Leo ‚ôå","Virgo ‚ôç","Libra ‚ôé","Scorpio ‚ôè","Sagittarius ‚ôê","Capricorn ‚ôë","Aquarius ‚ôí","Pisces ‚ôì"];
    const zod = signs[Math.floor(moonLong / 30)];
    const el = ZOD_ELEMENTS[zod];
    let sunLong = (280.466 + 36000.770 * T) % 360;
    let angle = (moonLong - sunLong + 360) % 360;
    
    let isFull = FULL_MOONS.some(m => m.d === dStr);
    let isNew = NEW_MOONS.includes(dStr);
    let isPivot = PIVOTS[dStr];
    let isEvent = CELESTIAL_EVENTS[dStr];

    let phase = "Waning Crescent", ico = "üåò";
    if (isFull) { phase = "Full Moon"; ico = "üåï"; }
    else if (isNew) { phase = "New Moon"; ico = "üåë"; }
    else if (angle < 90) { phase = "Waxing Crescent"; ico = "üåí"; }
    else if (angle < 100) { phase = "First Quarter"; ico = "üåì"; }
    else if (angle < 180) { phase = "Waxing Gibbous"; ico = "üåî"; }
    else if (angle < 260) { phase = "Waning Gibbous"; ico = "üåñ"; }
    else if (angle < 280) { phase = "Last Quarter"; ico = "üåó"; }

    let anchor = MOON_ANCHORS[0];
    for (let m of MOON_ANCHORS) { if (date >= m.d) anchor = m; }
    const diffTime = Math.abs(date - anchor.d);
    let tDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    // V67 Dynamic Wisdom Engine
    let archetype = FULL_MOON_DATA[dStr];
    
    // Use the dynamic engine for whisper unless it's a specific Full Moon date with a preset
    let whisper = archetype ? archetype.t + ": " + WHISPER_MATRIX["Full Moon"][el] : generateDailyWisdom(phase, zod, date.getDate());
    
    // Use dynamic ritual unless it's a specific Full Moon
    let ritual = archetype ? archetype.r : getDailyRitual(phase, zod, date.getDate());
    
    let shadow = "";
    if (isNew) {
      shadow = SHADOW_WORK[zod.split(' ')[0]];
    }

    if (dStr === "Jan 22" && date.getFullYear() === 2027) {
       archetype = FULL_MOON_DATA["Jan 22, 2027"];
       isFull = true; whisper = archetype.t + ": " + WHISPER_MATRIX["Full Moon"]["FIRE"]; ritual = archetype.r;
    }

    return { phase, ico, zod, tDay, el, elColor: ELEMENTS[el], dStr, year: date.getFullYear(), isFull, isNew, isPivot, isEvent, archetype, whisper, ritual, shadow };
  }

  function render() {
    const grid = document.getElementById("calendar"); grid.innerHTML = "";
    document.getElementById("monthLabel").innerText = `${activeD.toLocaleString('default', { month: 'long' }).toUpperCase()} ${activeD.getFullYear()}`;
    ["M","T","W","T","F","S","S"].forEach(l => grid.innerHTML += `<div class="day-label">${l}</div>`);
    const first = new Date(activeD.getFullYear(), activeD.getMonth(), 1);
    const last = new Date(activeD.getFullYear(), activeD.getMonth() + 1, 0).getDate();
    let offset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
    for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;
    
    const todayStr = new Date().toDateString();

    for(let i=1; i<=last; i++) {
      const d = new Date(activeD.getFullYear(), activeD.getMonth(), i);
      const data = getCelestialData(d);
      const cell = document.createElement("div");
      
      let classes = ['day'];
      if(d.toDateString() === selectedDate) classes.push('selected');
      if(d.toDateString() === todayStr) classes.push('today');
      if(data.isFull) classes.push('full-moon-day');
      if(data.isNew) classes.push('new-moon-day');
      if(data.isPivot || data.isEvent) classes.push('celestial-pivot');
      if(db.logs[d.toDateString()]) classes.push('period');
      
      cell.className = classes.join(' ');
      cell.innerHTML = `<span class="d-num">${i}</span><span class="t-num">${data.tDay}</span><span class="m-ico" style="filter: drop-shadow(0 0 5px ${data.elColor})">${data.ico}</span><span class="z-ico">${data.zod.split(' ')[0]}</span>`;
      cell.onclick = () => { selectedDate = d.toDateString(); updateDash(d); render(); };
      grid.appendChild(cell);
    }
  }

  function updateDash(date) {
    const data = getCelestialData(date);
    document.documentElement.style.setProperty('--aura', data.elColor);
    
    const displayTitle = data.archetype ? data.archetype.n.toUpperCase() : `${data.phase.toUpperCase()} ${data.ico}`;
    document.getElementById("dashTitle").innerText = displayTitle;
    document.getElementById("detailedPhase").innerText = data.phase.toUpperCase();
    document.getElementById("dashSub").innerText = `LUNAR DAY ${data.tDay} ‚Ä¢ ${data.dStr}, ${data.year}`;
    document.getElementById("elementTag").innerText = `‚úß ${data.el} ENERGY ‚úß`;
    document.getElementById("journalInput").value = db.journals[date.toDateString()] || "";
    document.getElementById("flowBtn").className = db.logs[date.toDateString()] ? "cycle-btn active" : "cycle-btn";
    
    let eventHTML = "";
    if(data.isPivot && data.isPivot.n === "Spring Equinox") {
      eventHTML += `<div class="event-badge newyear-badge" onclick="openModal('${data.isPivot.n}', '${data.isPivot.d}', '${data.isPivot.l}')">HAPPY ANCESTRAL NEW YEAR! üå∏‚ú®üåø</div><br>`;
    } else if(data.isPivot) {
      eventHTML += `<div class="event-badge portal-badge" onclick="openModal('${data.isPivot.n}', '${data.isPivot.d}', '${data.isPivot.l}')">‚ú® ${data.isPivot.n.toUpperCase()}</div>`;
    }
    
    if(data.isEvent) eventHTML += `<div class="event-badge retro-badge" onclick="openModal('${data.isEvent.n}', '${data.isEvent.d}', '${data.isEvent.l}')">üëÅÔ∏è ${data.isEvent.n.toUpperCase()}</div>`;
    
    eventHTML += `<div class="event-badge zodiac-badge" onclick="openZodiacModal('${data.zod.split(' ')[0]}')">‚ú® MOON IN ${data.zod.toUpperCase()}</div>`;
    
    if(data.archetype && data.isFull) eventHTML += `<div class="event-badge moon-badge" onclick="openModal('${data.archetype.n}', 'Full Moon in ${data.zod}. Theme: ${data.archetype.t}.', '${data.archetype.l}')">üëÅÔ∏è INTEL</div>`;
    
    document.getElementById("eventDisplay").innerHTML = eventHTML;
    document.getElementById("guidanceText").innerText = data.whisper;
    document.getElementById("ritualText").innerText = data.ritual;
    
    if (data.isNew && data.shadow) {
      document.getElementById("shadowCard").style.display = "block";
      document.getElementById("shadowText").innerText = data.shadow;
    } else {
      document.getElementById("shadowCard").style.display = "none";
    }
    
    const savedEnergy = db.energy[date.toDateString()];
    document.querySelectorAll('.energy-btn').forEach(btn => btn.classList.remove('active'));
    if(savedEnergy) {
      const map = {'fire':'e-fire','water':'e-water','air':'e-air','earth':'e-earth'};
      if(document.getElementById(map[savedEnergy])) document.getElementById(map[savedEnergy]).classList.add('active');
      const labels = {'fire':'FIRE: HIGH / CREATIVE','water':'WATER: EMOTIONAL / FLOW','air':'AIR: MENTAL / CLEAR','earth':'EARTH: REST / GROUNDED'};
      document.getElementById("energyLabel").innerText = labels[savedEnergy];
    } else {
      document.getElementById("energyLabel").innerText = "Select your dominant energy";
    }
    
    db.zodCache[date.toDateString()] = data.zod;
    localStorage.setItem('ancestral_moon_v67', JSON.stringify(db));
  }

  function setEnergy(val) {
    let map = {'üî•':'fire','üíß':'water','üå¨Ô∏è':'air','ü™®':'earth'};
    db.energy[selectedDate] = map[val];
    localStorage.setItem('ancestral_moon_v67', JSON.stringify(db));
    updateDash(new Date(selectedDate));
  }

  function openModal(title, desc, query) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalText").innerText = desc;
    document.getElementById("sunMoonDistinction").style.display = "none";
    document.getElementById("modalLink").href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    document.getElementById("cosmicModal").style.display = "block";
    document.querySelector(".modal-overlay").style.display = "block";
  }

  function openZodiacModal(sign) {
    document.getElementById("modalTitle").innerText = `MOON IN ${sign.toUpperCase()}`;
    document.getElementById("modalText").innerText = ZODIAC_WISDOM[sign];
    document.getElementById("sunMoonDistinction").style.display = "block";
    document.getElementById("modalLink").href = `https://www.google.com/search?q=moon+in+${sign}+spiritual+meaning`;
    document.getElementById("cosmicModal").style.display = "block";
    document.querySelector(".modal-overlay").style.display = "block";
  }

  function closeModal() { document.getElementById("cosmicModal").style.display = "none"; document.querySelector(".modal-overlay").style.display = "none"; }

  function copySisterReport() {
    const d = new Date(selectedDate);
    const data = getCelestialData(d);
    let extra = data.isEvent ? `\nüåÄ Intel: ${data.isEvent.n}` : "";
    if (data.isPivot) extra = `\n‚ú® Portal: ${data.isPivot.n}`;
    let shadow = data.isNew ? `\nüåë Shadow Work: ${data.shadow}` : "";

    const report = `‚òæ Ancestral Moon Report: ${data.dStr}, ${data.year} ‚òΩ\nMoon: ${data.archetype ? data.archetype.n : data.phase}\nSign: ${data.zod} (${data.el})\n\nWhisper: ${document.getElementById("guidanceText").innerText}\n\nRitual: ${data.ritual}${shadow}${extra}\n\nSynced via The Ancestral Moon Map ‚ú®`;
    navigator.clipboard.writeText(report).then(() => alert("Report Copied!"));
  }

  function jumpToDate(dateStr) { selectedDate = dateStr; activeD = new Date(dateStr); render(); updateDash(activeD); showView('dash'); }
  function deleteEntry(dateStr) { if(confirm("Release this entry?")) { delete db.journals[dateStr]; delete db.logs[dateStr]; delete db.energy[dateStr]; localStorage.setItem('ancestral_moon_v67', JSON.stringify(db)); showView('grimoire'); } }

  function backupData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "ancestral_moon_backup.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  function restoreData(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedDb = JSON.parse(e.target.result);
        db = importedDb;
        localStorage.setItem('ancestral_moon_v67', JSON.stringify(db));
        alert("Grimoire Restored Successfully.");
        render(); updateDash(new Date(selectedDate)); showView('grimoire');
      } catch(err) { alert("Invalid backup file."); }
    };
    reader.readAsText(file);
  }

  function exportToCSV() {
    let csv = "Date,Moon Phase,Zodiac,Element,Flow,Energy,Journal Entry\n";
    const dates = Object.keys(db.journals).concat(Object.keys(db.logs), Object.keys(db.energy)).sort((a,b) => new Date(b) - new Date(a));
    const uniqueDates = [...new Set(dates)];
    
    uniqueDates.forEach(dStr => {
      const d = new Date(dStr);
      const celestial = getCelestialData(d);
      
      let flow = db.logs[dStr] ? "Yes" : "No";
      let energy = db.energy[dStr] ? db.energy[dStr].toUpperCase() : "N/A";
      let entry = db.journals[dStr] ? db.journals[dStr].replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""') : "";
      let phase = celestial.archetype ? celestial.archetype.n : celestial.phase;
      
      csv += `"${dStr}","${phase}","${celestial.zod}","${celestial.el}","${flow}","${energy}","${entry}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "grimoire_export.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function showView(view) {
    document.getElementById('oracleDash').style.display = 'none';
    document.getElementById('grimoireView').style.display = 'none';
    document.getElementById('yearlyView').style.display = 'none';
    if(view === 'dash') document.getElementById('oracleDash').style.display = 'block';
    
    if(view === 'grimoire') {
      const g = document.getElementById('grimoireView'); g.style.display = 'block';
      const cont = document.getElementById('grimoireContent'); cont.innerHTML = "";
      const dates = Object.keys(db.journals).concat(Object.keys(db.logs), Object.keys(db.energy)).sort((a,b) => new Date(b) - new Date(a));
      [...new Set(dates)].forEach(d => {
        if(db.journals[d] || db.logs[d] || db.energy[d]) {
          let en = db.energy[d] ? (db.energy[d] === 'fire' ? 'üî•' : db.energy[d] === 'water' ? 'üíß' : db.energy[d] === 'air' ? 'üå¨Ô∏è' : 'ü™®') : '';
          cont.innerHTML += `<div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; margin-bottom:10px; text-align:left; border-left:3px solid var(--aura);">
            <div style="font-size:0.6rem; color:var(--gold); display:flex; justify-content:space-between; margin-bottom:5px;"><span>${d} ‚Ä¢ ${db.zodCache[d] || 'Cosmos'}</span> <span>${en} ${db.logs[d] ? 'ü©∏' : ''}</span></div>
            <div style="font-family:'Charm'; font-size:1.1rem; color:#eee;">${db.journals[d] || "<i>Quiet.</i>"}</div>
            <div class="grim-actions"><button class="grim-btn" onclick="jumpToDate('${d}')">‚úèÔ∏è</button><button class="grim-btn" onclick="deleteEntry('${d}')">üóëÔ∏è</button></div>
          </div>`;
        }
      });
    }
    if(view === 'yearly') {
      document.getElementById('yearlyView').style.display = 'block';
      const yc = document.getElementById('yearlyContent'); yc.innerHTML = "";
      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel';">CELESTIAL PIVOTS</h4>`;
      for(let p in PIVOTS) yc.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.7rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;"><span>‚ú® ${PIVOTS[p].n}</span> <span>${p}</span></div>`;
      for(let e in CELESTIAL_EVENTS) yc.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.7rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0; color:var(--retro);"><span>üåÄ ${CELESTIAL_EVENTS[e].n}</span> <span>${e}</span></div>`;
      
      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; margin-top:20px;">13 FULL MOONS</h4>`;
      FULL_MOONS.forEach(m => {
        const arch = FULL_MOON_DATA[m.d] || {n:"Moon"};
        yc.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0;"><span>üåï ${m.d} - ${arch.n}</span> <span>${m.z}</span></div>`;
      });

      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; margin-top:20px;">13 NEW MOONS</h4>`;
      NEW_MOONS.forEach(dStr => {
        const d = new Date(`${dStr}, 2026`);
        const data = getCelestialData(d);
        yc.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); padding:5px 0; color:var(--amethyst);"><span>üåë ${dStr} - New Moon</span> <span>${data.zod}</span></div>`;
      });
    }
  }

  function saveData() { db.journals[selectedDate] = document.getElementById("journalInput").value; localStorage.setItem('ancestral_moon_v67', JSON.stringify(db)); }
  function toggleFlow() { db.logs[selectedDate] = !db.logs[selectedDate]; localStorage.setItem('ancestral_moon_v67', JSON.stringify(db)); render(); updateDash(new Date(selectedDate)); }
  function changeMonth(n) { activeD.setMonth(activeD.getMonth() + n); render(); }

  const sField = document.getElementById('starField');
  for(let i=0; i<80; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*2+'px'; s.style.setProperty('--d', (Math.random()*4+2)+'s'); sField.appendChild(s);
  }

  render(); updateDash(new Date());
</script>
</body>
</html>
