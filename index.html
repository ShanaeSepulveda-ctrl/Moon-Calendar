<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Celestial Oracle</title>

  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold: #d4af37;
      --silver: #c0c0c0;
      --deep-space: #05070a;
      --mystic-glow: rgba(110, 68, 255, 0.3);
    }

    body {
      font-family: 'Quicksand', sans-serif;
      background-color: var(--deep-space);
      background-image: 
        radial-gradient(circle at 50% 20%, #1a1b3a 0%, transparent 50%),
        url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #e0e0e0;
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* âœ¨ Enhanced Magical Tarot Card */
    #lunarCard {
      width: 100%;
      max-width: 360px;
      background: rgba(22, 26, 48, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid var(--gold);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 0 40px var(--mystic-glow), inset 0 0 20px rgba(212, 175, 55, 0.1);
      position: relative;
      text-align: center;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }

    #lunarCard:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 50px rgba(110, 68, 255, 0.5);
    }

    #cardTitle {
      font-family: 'Cinzel', serif;
      color: var(--gold);
      font-size: 1.8rem;
      margin: 15px 0 5px 0;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    #fullMoonNameDisplay {
        font-family: 'Cinzel', serif;
        font-size: 0.9rem;
        color: var(--silver);
        display: block;
        margin-bottom: 15px;
        letter-spacing: 2px;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--gold);
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
      padding-bottom: 10px;
    }

    .card-section { margin: 18px 0; text-align: left; }
    .card-section strong { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.7rem; display: block; letter-spacing: 1px; }
    .card-section p { margin: 5px 0; font-style: italic; font-size: 1rem; line-height: 1.5; color: #fff; }

    /* ğŸ—“ï¸ Controls */
    .controls { display: flex; gap: 25px; align-items: center; margin-bottom: 20px; }
    button {
      background: none; border: 1px solid var(--gold); color: var(--gold);
      padding: 8px 18px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel';
      transition: 0.3s;
    }
    button:hover { background: var(--gold); color: var(--deep-space); }

    /* ğŸŒŒ Calendar */
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 600px;
    }

    .day-header { font-family: 'Cinzel'; color: var(--gold); font-size: 0.75rem; text-align: center; opacity: 0.7; }

    .day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(212, 175, 55, 0.1);
      border-radius: 12px;
      aspect-ratio: 1/1.3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .day:hover { 
        background: rgba(212, 175, 55, 0.15); 
        border-color: var(--gold);
        transform: scale(1.05);
    }
    .day.today { border: 1px solid #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

    .day-num { font-size: 0.6rem; opacity: 0.5; margin-bottom: 4px; }
    .moon-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .zodiac-tag { font-size: 0.55rem; color: var(--gold); font-weight: bold; }
  </style>
</head>
<body>

  <div id="lunarCard">
    <div class="card-meta">
      <span id="cardPhase"></span>
      <span id="cardZodiac"></span>
    </div>
    <h2 id="cardTitle"></h2>
    <span id="fullMoonNameDisplay"></span>
    
    <div class="card-section"><strong>Affirmation</strong><p id="cardAff"></p></div>
    <div class="card-section"><strong>Ritual</strong><p id="cardRit"></p></div>
    <div class="card-section"><strong>Journaling with the Stars</strong><p id="cardJour"></p></div>
  </div>

  <div class="controls">
    <button onclick="changeMonth(-1)">PREV</button>
    <span id="monthName" style="font-family: 'Cinzel'; letter-spacing: 2px;"></span>
    <button onclick="changeMonth(1)">NEXT</button>
  </div>

  <div id="calendar"></div>

<script>
  let currentViewDate = new Date();
  const LUNAR_ANCHOR = new Date(2024, 0, 11);
  const ZODIAC_SIGNS = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
  const ARCHETYPES = ["The Deep Rest","The Dreaming","The Gestation","The Stirring","The Rooting","The Leafing","The Budding","The Flowering","The Radiance","The Fruiting","The Harvest","The Composting","The Stillness"];
  
  const FULL_MOON_NAMES = [
    { name: "Wolf Moon", emoji: "ğŸºğŸŒ•" }, { name: "Snow Moon", emoji: "â„ï¸ğŸŒ•" }, { name: "Worm Moon", emoji: "ğŸª±ğŸŒ•" },
    { name: "Pink Moon", emoji: "ğŸŒ¸ğŸŒ•" }, { name: "Flower Moon", emoji: "ğŸŒ¼ğŸŒ•" }, { name: "Strawberry Moon", emoji: "ğŸ“ğŸŒ•" },
    { name: "Buck Moon", emoji: "ğŸ¦ŒğŸŒ•" }, { name: "Sturgeon Moon", emoji: "ğŸŸğŸŒ•" }, { name: "Harvest Moon", emoji: "ğŸŒ¾ğŸŒ•" },
    { name: "Hunterâ€™s Moon", emoji: "ğŸ¹ğŸŒ•" }, { name: "Beaver Moon", emoji: "ğŸ¦«ğŸŒ•" }, { name: "Cold Moon", emoji: "ğŸ¥¶ğŸŒ•" }
  ];

  const PHASE_ICONS = {
    "New Moon": "ğŸŒ‘", "Waxing Crescent": "ğŸŒ’", "First Quarter": "ğŸŒ“", "Waxing Gibbous": "ğŸŒ”",
    "Full Moon": "ğŸŒ•", "Waning Gibbous": "ğŸŒ–", "Last Quarter": "ğŸŒ—", "Waning Crescent": "ğŸŒ˜"
  };

  function getLunarDetails(date) {
    // 1. Phase Calculation
    const illum = SunCalc.getMoonIllumination(date);
    const p = illum.phase;
    let phaseName = "Waning Crescent";
    if (p < 0.03 || p > 0.97) phaseName = "New Moon";
    else if (p < 0.22) phaseName = "Waxing Crescent";
    else if (p < 0.28) phaseName = "First Quarter";
    else if (p < 0.47) phaseName = "Waxing Gibbous";
    else if (p < 0.53) phaseName = "Full Moon";
    else if (p < 0.72) phaseName = "Waning Gibbous";
    else if (p < 0.78) phaseName = "Last Quarter";

    // 2. Zodiac Calculation (Corrected longitude)
    const pos = SunCalc.getMoonPosition(date, 40, -74); // Using general lat/lon for consistency
    const lonDeg = (pos.lng * 180 / Math.PI + 360) % 360;
    const zodiac = ZODIAC_SIGNS[Math.floor(lonDeg / 30)] || "Aries";

    // 3. Archetype Calculation
    const diffDays = Math.floor((date.getTime() - LUNAR_ANCHOR.getTime()) / 86400000);
    const archIdx = ((Math.floor(diffDays / 28) % 13) + 13) % 13;
    const moonDay = ((diffDays % 28) + 28) % 28 + 1;

    return { phaseName, zodiac, archetype: ARCHETYPES[archIdx], moonDay, emoji: PHASE_ICONS[phaseName] };
  }

  function updateCard(date) {
    const d = getLunarDetails(date);
    const card = document.getElementById("lunarCard");
    card.style.opacity = '0.5';
    
    setTimeout(() => {
      document.getElementById("cardTitle").innerText = d.archetype;
      document.getElementById("cardPhase").innerText = `${d.emoji} ${d.phaseName} Â· Day ${d.moonDay}`;
      document.getElementById("cardZodiac").innerText = `Moon in ${d.zodiac}`;
      
      // Full Moon Logic
      const isFull = d.phaseName === "Full Moon";
      const fmName = isFull ? FULL_MOON_NAMES[date.getMonth()] : null;
      document.getElementById("fullMoonNameDisplay").innerText = fmName ? `âœ§ ${fmName.name} ${fmName.emoji} âœ§` : "";

      // Guidance
      const seed = date.getDate();
      const affs = ["I step into my power with grace.", "I am guided by the light of the stars.", "I trust the unseen path before me.", "My magic is ancient and true."];
      document.getElementById("cardAff").innerText = affs[seed % 4];
      document.getElementById("cardRit").innerText = "Anoint your wrists with lavender oil and look toward the night sky.";
      document.getElementById("cardJour").innerText = `How is the energy of ${d.zodiac} affecting my heart's desires today?`;
      
      card.style.opacity = '1';
    }, 300);
  }

  function renderCalendar() {
    const grid = document.getElementById("calendar");
    grid.innerHTML = "";
    
    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();
    document.getElementById("monthName").innerText = currentViewDate.toLocaleString('default', { month: 'long', year: 'numeric' });

    ["MO", "TU", "WE", "TH", "FR", "SA", "SU"].forEach(day => {
      const div = document.createElement("div");
      div.className = "day-header";
      div.innerText = day;
      grid.appendChild(div);
    });

    const firstDay = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let offset = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

    for (let i = 0; i < offset; i++) grid.appendChild(document.createElement("div"));

    for (let i = 1; i <= daysInMonth; i++) {
      const date = new Date(year, month, i);
      const info = getLunarDetails(date);
      const cell = document.createElement("div");
      cell.className = "day";
      
      if (date.toDateString() === new Date().toDateString()) cell.classList.add("today");

      cell.innerHTML = `
        <span class="day-num">${i}</span>
        <span class="moon-icon">${info.emoji}</span>
        <span class="zodiac-tag">${info.zodiac.substring(0,3)}</span>
      `;
      
      cell.onclick = () => updateCard(date);
      grid.appendChild(cell);
    }
  }

  function changeMonth(dir) {
    currentViewDate.setMonth(currentViewDate.getMonth() + dir);
    renderCalendar();
  }

  renderCalendar();
  updateCard(new Date());
</script>
</body>
</html>
