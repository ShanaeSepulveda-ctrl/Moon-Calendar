<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sacred Moon Oracle</title>

  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Charm:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --gold: #e5c07b;
      --obsidian: #0a0612;
      --amethyst: #4b3077;
      --rose: #a34c5f;
    }

    body {
      font-family: 'Charm', cursive;
      background: var(--obsidian);
      background-image: radial-gradient(circle at 50% 10%, var(--amethyst) 0%, transparent 70%), url('https://www.transparenttextures.com/patterns/stardust.png');
      color: #fdfbfb;
      margin: 0; padding: 10px;
      display: flex; flex-direction: column; align-items: center;
    }

    #lunarCard {
      width: 90%; max-width: 400px;
      background: rgba(20, 10, 30, 0.9);
      border: 2px solid var(--gold);
      border-radius: 30px;
      padding: 25px; margin: 20px 0;
      box-shadow: 0 0 40px rgba(123, 67, 151, 0.3);
      text-align: center;
      backdrop-filter: blur(8px);
    }

    .card-title { font-family: 'Cinzel'; color: var(--gold); font-size: 1.6rem; margin: 10px 0; }
    .card-meta { font-family: 'Cinzel'; font-size: 0.7rem; color: var(--gold); margin-bottom: 15px; border-bottom: 1px solid rgba(229,192,123,0.2); padding-bottom: 10px; }
    
    .section { text-align: left; margin-bottom: 15px; }
    .section strong { color: var(--gold); font-family: 'Cinzel'; font-size: 0.65rem; display: block; }
    .section p { margin: 5px 0; font-size: 1rem; line-height: 1.4; }

    /* Period Tracker Toggle */
    .period-btn { 
      background: var(--rose); color: white; border: none; padding: 5px 12px; 
      border-radius: 20px; font-size: 0.7rem; cursor: pointer; margin-top: 10px;
    }
    .is-period { border: 2px solid var(--rose) !important; box-shadow: 0 0 10px var(--rose); }

    /* Shadow Work Toggle */
    #shadowBox { display: none; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; border-left: 3px solid var(--amethyst); margin-top: 10px; }

    /* Calendar Grid */
    .controls { display: flex; gap: 30px; align-items: center; margin-bottom: 15px; font-family: 'Cinzel'; color: var(--gold); }
    .controls span { cursor: pointer; font-size: 1.5rem; }

    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; max-width: 500px; }
    .day { 
      background: rgba(255,255,255,0.03); border: 1px solid rgba(229,192,123,0.1); 
      border-radius: 10px; aspect-ratio: 1/1.3; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; cursor: pointer; position: relative;
    }
    .day.today { border: 1.2px solid #fff; }
    .day-num { position: absolute; top: 3px; left: 5px; font-size: 0.6rem; opacity: 0.4; }
    .zodiac-tag { font-size: 0.5rem; color: var(--gold); font-family: 'Cinzel'; }
    .wheel-label { font-size: 0.5rem; color: #00ffcc; font-weight: bold; }
  </style>
</head>
<body>

<div id="lunarCard">
  <span id="cardDate" style="font-family: 'Cinzel'; font-size: 0.8rem;"></span>
  <h2 id="cardTitle" class="card-title"></h2>
  
  <div class="card-meta">
    <span id="cardPhase"></span><br>
    <span id="cardZodiac"></span>
  </div>

  <div class="section"><strong>Spirit Message</strong><p id="cardSpirit"></p></div>
  <div class="section"><strong>Divine Ritual</strong><p id="cardRit"></p></div>
  <div class="section">
    <strong>Shadow Work (New Moon Only)</strong>
    <div id="shadowBox"><p id="shadowText"></p></div>
    <p id="noShadow" style="font-size: 0.8rem; opacity: 0.5;">Shadow work opens only during the New Moon.</p>
  </div>

  <button class="period-btn" onclick="togglePeriod()">Toggle Moon Flow (Period)</button>
</div>

<div class="controls">
  <span onclick="changeMonth(-1)">â˜¾</span>
  <div id="monthLabel"></div>
  <span onclick="changeMonth(1)">â˜½</span>
</div>

<div id="calendar"></div>

<script>
  let viewDate = new Date();
  const LUNAR_ANCHOR = new Date(2024, 0, 11);
  const ZODIAC_SIGNS = ["Aries â™ˆ", "Taurus â™‰", "Gemini â™Š", "Cancer â™‹", "Leo â™Œ", "Virgo â™", "Libra â™Ž", "Scorpio â™", "Sagittarius â™", "Capricorn â™‘", "Aquarius â™’", "Pisces â™“"];
  const ARCHETYPES = [
    { n: "Wolf Moon", e: "ðŸºðŸŒ•" }, { n: "Snow Moon", e: "â„ï¸ðŸŒ•" }, { n: "Worm Moon", e: "ðŸª±ðŸŒ•" },
    { n: "Pink Moon", e: "ðŸŒ¸ðŸŒ•" }, { n: "Flower Moon", e: "ðŸŒ¼ðŸŒ•" }, { n: "Strawberry Moon", e: "ðŸ“ðŸŒ•" },
    { n: "Buck Moon", e: "ðŸ¦ŒðŸŒ•" }, { n: "Sturgeon Moon", e: "ðŸŸðŸŒ•" }, { n: "Harvest Moon", e: "ðŸŒ¾ðŸŒ•" },
    { n: "Hunter's Moon", e: "ðŸ¹ðŸŒ•" }, { n: "Beaver Moon", e: "ðŸ¦«ðŸŒ•" }, { n: "Cold Moon", e: "ðŸ¥¶ðŸŒ•" }
  ];

  const SPIRIT_MESSAGES = [
    "You are the seed in winter.", "Whisper to your water.", "Your ancestors are watching.", "Softness is your shield.",
    "The tide is turning for you.", "Trust the dark before the dawn.", "You are made of stardust.", "Forgive your past self.",
    "Silence contains all answers.", "Bloom where you are planted.", "Your voice is a spell.", "Reclaim your stolen fire.",
    "The earth remembers your feet.", "You are a wild, holy thing.", "Magic is your birthright.", "Release the heavy stones.",
    "Dance for the unseen spirits.", "Your heart is a compass.", "Breathe with the ocean.", "You are the ritual.",
    "The stars are your siblings.", "Honesty is a healing balm.", "Listen to the wind's song.", "You are infinite grace.",
    "Small steps are sacred.", "The sun lives inside you.", "Your body is a temple.", "Rest is a radical act."
  ];

  // Period storage
  let periodDays = JSON.parse(localStorage.getItem('moonCycles')) || {};

  function getMoonData(date) {
    const illum = SunCalc.getMoonIllumination(date);
    const phaseIdx = Math.floor(illum.phase * 8 + 0.5) % 8;
    const pNames = ["New Moon", "Waxing Crescent", "First Quarter", "Waxing Gibbous", "Full Moon", "Waning Gibbous", "Last Quarter", "Waning Crescent"];
    const pIcons = ["ðŸŒ‘", "ðŸŒ’", "ðŸŒ“", "ðŸŒ”", "ðŸŒ•", "ðŸŒ–", "ðŸŒ—", "ðŸŒ˜"];

    // Precise Zodiac (Corrected Ecliptic Formula)
    const pos = SunCalc.getMoonPosition(date, 0, 0);
    // Correcting for the 2026 Ecliptic Plane
    let lon = (pos.lng * 180 / Math.PI + 360) % 360;
    // Apply 2026 precession offset (~23.5deg for Tropical Alignment)
    let zodiacIdx = Math.floor(((lon + 20) % 360) / 30);

    const diff = Math.floor((date - LUNAR_ANCHOR) / 86400000);
    const arch = ARCHETYPES[date.getMonth()];
    
    return { 
      phase: pNames[phaseIdx], icon: pIcons[phaseIdx], 
      zodiac: ZODIAC_SIGNS[zodiacIdx], arch, 
      day: ((diff % 28) + 28) % 28 + 1 
    };
  }

  function getWheelLabel(date) {
    const m = date.getMonth(), d = date.getDate();
    if (m === 2 && d >= 19 && d <= 21) return "Spring Rebirth ðŸŒ¿";
    if (m === 5 && d >= 20 && d <= 22) return "Summer Radiance â˜€ï¸";
    if (m === 8 && d >= 21 && d <= 23) return "Autumn Release ðŸ‚";
    if (m === 11 && d >= 20 && d <= 22) return "Winter Stillness â„ï¸";
    return null;
  }

  function togglePeriod() {
    const key = viewDate.toDateString();
    if (periodDays[key]) delete periodDays[key];
    else periodDays[key] = true;
    localStorage.setItem('moonCycles', JSON.stringify(periodDays));
    render();
  }

  function updateCard(date) {
    viewDate = new Date(date);
    const d = getMoonData(date);
    document.getElementById("cardDate").innerText = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    document.getElementById("cardTitle").innerText = `${d.arch.n} ${d.arch.e}`;
    document.getElementById("cardPhase").innerText = `${d.icon} ${d.phase} Â· Day ${d.day}`;
    document.getElementById("cardZodiac").innerText = `Moon in ${d.zodiac}`;
    
    document.getElementById("cardSpirit").innerText = SPIRIT_MESSAGES[d.day - 1];
    document.getElementById("cardRit").innerText = "Light a candle and visualize the " + d.zodiac.split(' ')[0] + " energy filling your home.";

    const isNew = d.phase === "New Moon";
    document.getElementById("shadowBox").style.display = isNew ? "block" : "none";
    document.getElementById("noShadow").style.display = isNew ? "none" : "block";
    document.getElementById("shadowText").innerText = "What am I hiding from myself that needs the darkness to speak?";
  }

  function render() {
    const cal = document.getElementById("calendar");
    cal.innerHTML = "";
    document.getElementById("monthLabel").innerText = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });

    ["M","T","W","T","F","S","S"].forEach(d => {
      const h = document.createElement("div"); h.className = "day-label"; h.innerText = d; cal.appendChild(h);
    });

    const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
    const last = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
    let offset = first.getDay() === 0 ? 6 : first.getDay() - 1;

    for (let i = 0; i < offset; i++) cal.appendChild(document.createElement("div"));

    for (let i = 1; i <= last; i++) {
      const d = new Date(viewDate.getFullYear(), viewDate.getMonth(), i);
      const info = getMoonData(d);
      const wheel = getWheelLabel(d);
      const cell = document.createElement("div");
      cell.className = "day" + (d.toDateString() === new Date().toDateString() ? " today" : "");
      if (periodDays[d.toDateString()]) cell.classList.add("is-period");

      cell.innerHTML = `
        <span class="day-num">${i}</span>
        <span>${info.icon}</span>
        <span class="zodiac-tag">${info.zodiac.split(' ')[0]}</span>
        ${wheel ? `<span class="wheel-label">âœ§</span>` : ""}
      `;
      cell.onclick = () => updateCard(d);
      cal.appendChild(cell);
    }
  }

  function changeMonth(n) { viewDate.setMonth(viewDate.getMonth() + n); render(); }

  render();
  updateCard(new Date());
</script>
</body>
</html>
