<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13 Moon Calendar</title>
    
<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
    
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b0d17;
      color: #eee;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    .day {
      background: #15192d;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      min-height: 90px;
      transition: background 0.2s;
    }

    .day:hover {
      background: #1f2550;
    }

    .gregorian {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .moon-day {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 5px;
    }

    .moon-name {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 4px;
    }

    #dayInfo {
      margin-top: 30px;
      padding: 20px;
      border-radius: 12px;
      background: #15192d;
    }
    
 .day.today {
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 0 0 12px rgba(180, 200, 255, 0.6);
  background: radial-gradient(
    circle at top,
    rgba(255, 255, 255, 0.08),
    #15192d
  );
}

/* Optional gentle pulse */
@keyframes softGlow {
  0% { box-shadow: 0 0 8px rgba(180, 200, 255, 0.4); }
  50% { box-shadow: 0 0 16px rgba(180, 200, 255, 0.8); }
  100% { box-shadow: 0 0 8px rgba(180, 200, 255, 0.4); }
}

.day.today {
  animation: softGlow 4s ease-in-out infinite;
}

#lunarGuidance {
  background: linear-gradient(160deg, #15192d, #0b0d17);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 25px;
  box-shadow: 0 0 20px rgba(180, 200, 255, 0.15);
}

#lunarGuidance h2 {
  margin-top: 0;
  text-align: center;
}

#lunarGuidance p {
  line-height: 1.4;
  margin: 10px 0;
}

  </style>
    
    <link rel="manifest" href="manifest.json">

</head>

<body>
  <h1>13 Moon Calendar</h1>

<div id="lunarGuidance">
  <h2>ðŸŒ™ Todayâ€™s Lunar Guidance</h2>
  <p id="lunarPhase"></p>
  <p><strong>Affirmation:</strong> <span id="affirmation"></span></p>
  <p><strong>Suggested Ritual:</strong> <span id="ritual"></span></p>
</div>

  <div id="calendar"></div>

  <div id="dayInfo">
    <h2>Selected Day</h2>
    <p id="dayText">Click a day to see its energy.</p></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  var calendar = document.getElementById("calendar");
  var dayText = document.getElementById("dayText");

  var todayDate = new Date();

  function getMoonPhase(date) {
    if (typeof SunCalc === "undefined") return "ðŸŒ™ Moon";

    var phase = SunCalc.getMoonIllumination(date).phase;

    if (phase < 0.03 || phase > 0.97) return "ðŸŒ‘ New Moon";
    if (phase < 0.22) return "ðŸŒ’ Waxing Crescent";
    if (phase < 0.28) return "ðŸŒ“ First Quarter";
    if (phase < 0.47) return "ðŸŒ” Waxing Gibbous";
    if (phase < 0.53) return "ðŸŒ• Full Moon";
    if (phase < 0.72) return "ðŸŒ– Waning Gibbous";
    if (phase < 0.78) return "ðŸŒ— Last Quarter";
    return "ðŸŒ˜ Waning Crescent";
  }
  
function getLunarGuidance(phase) {
  var guidance = {
    "ðŸŒ‘ New Moon": {
      affirmation: "I welcome new beginnings with clarity and trust.",
      ritual: "Set intentions in a journal or sit quietly with what is ready to be born.",
      message: "This is a sacred pause. Listen inward and allow new seeds to form."
    },
    "ðŸŒ’ Waxing Crescent": {
      affirmation: "I gently nurture what is growing within me.",
      ritual: "Take one small aligned action toward a goal or dream.",
      message: "Growth is subtle today. Honor small steps and quiet momentum."
    },
    "ðŸŒ“ First Quarter": {
      affirmation: "I move forward with courage and commitment.",
      ritual: "Clear obstacles or make a decision youâ€™ve been postponing.",
      message: "Tension invites clarity. Choose forward motion with intention."
    },
    "ðŸŒ” Waxing Gibbous": {
      affirmation: "I refine my path with patience and awareness.",
      ritual: "Adjust plans and release perfectionism.",
      message: "Refinement brings wisdom. Let your vision evolve."
    },
    "ðŸŒ• Full Moon": {
      affirmation: "I honor my growth and release what no longer serves me.",
      ritual: "Practice a release ritual or celebrate how far youâ€™ve come.",
      message: "Illumination is strong. Feel fully, release gently, celebrate truth."
    },
    "ðŸŒ– Waning Gibbous": {
      affirmation: "I integrate wisdom gained through experience.",
      ritual: "Share gratitude or reflect on recent insights.",
      message: "Meaning settles in now. Let lessons land softly."
    },
    "ðŸŒ— Last Quarter": {
      affirmation: "I release with compassion and intention.",
      ritual: "Let go of habits, commitments, or thoughts that drain you.",
      message: "Clearing creates space. Choose what truly supports you."
    },
    "ðŸŒ˜ Waning Crescent": {
      affirmation: "I rest, restore, and prepare for renewal.",
      ritual: "Slow down, rest deeply, or spend time in quiet reflection.",
      message: "This is a time of rest and surrender. Restoration is sacred."
    }
  };

  return guidance[phase] || {
    affirmation: "I flow with the natural rhythms of life.",
    ritual: "Pause and take a mindful breath.",
    message: "Move gently and listen to what your body and spirit need."
  };
}
 
  function getMoonDayMeaning(moonDay) {
  var meanings = {
    1:  "Initiation â€” a spark of beginning energy is present.",
    2:  "Polarity â€” notice balance, contrast, and relationship.",
    3:  "Activation â€” movement begins; ideas want expression.",
    4:  "Form â€” structure and boundaries support growth.",
    5:  "Empowerment â€” confidence and personal power rise.",
    6:  "Balance â€” harmony, care, and adjustment are needed.",
    7:  "Reflection â€” pause, observe, and realign.",
    8:  "Integration â€” lessons begin to settle into the body.",
    9:  "Intention â€” refocus on what truly matters.",
    10: "Manifestation â€” effort meets visible outcome.",
    11: "Release â€” clear tension, emotion, or resistance.",
    12: "Understanding â€” insight and perspective deepen.",
    13: "Transformation â€” something shifts at the core.",
    14: "Illumination â€” truth is revealed; clarity peaks.",
    15: "Expression â€” share, communicate, or celebrate.",
    16: "Adjustment â€” course-correct with compassion.",
    17: "Trust â€” surrender control and allow flow.",
    18: "Healing â€” tend to emotional or physical needs.",
    19: "Completion â€” acknowledge what has been fulfilled.",
    20: "Devotion â€” recommit to what nourishes you.",
    21: "Expansion â€” openness and possibility widen.",
    22: "Mastery â€” skills and wisdom stabilize.",
    23: "Flow â€” allow ease and natural movement.",
    24: "Gratitude â€” appreciation softens and opens the heart.",
    25: "Surrender â€” release expectations and outcomes.",
    26: "Clearing â€” simplify, declutter, cleanse.",
    27: "Stillness â€” quiet awareness prepares renewal.",
    28: "Renewal â€” rest, reset, and prepare to begin again."
  };

  return meanings[moonDay] || "";
}

  function getFirstNewMoonOfYear(year) {
  for (var month = 0; month < 12; month++) {
    for (var day = 1; day <= 31; day++) {
      var date = new Date(year, month, day);
      if (date.getMonth() !== month) continue;

      var phase = SunCalc.getMoonIllumination(date).phase;
      if (phase < 0.03 || phase > 0.97) {
        return date;
      }
    }
  }
  return null;
}

  function getLunarPosition(date) {
  var year = date.getFullYear();
  var lunarYearStart = getFirstNewMoonOfYear(year);

  // If date is BEFORE this year's New Moon, use last year's
  if (date < lunarYearStart) {
    lunarYearStart = getFirstNewMoonOfYear(year - 1);
  }

  var msPerDay = 1000 * 60 * 60 * 24;
  var daysSinceStart = Math.floor(
    (date - lunarYearStart) / msPerDay
  );

  var moonNumber = Math.floor(daysSinceStart / 28) + 1;
  var moonDay = (daysSinceStart % 28) + 1;

  return {
    moonNumber: moonNumber <= 13 ? moonNumber : null,
    moonDay: moonDay,
    lunarYearStart: lunarYearStart
  };
}
  
// Helper: lunar / equinox utilities (drop into your existing script)

// Cache for computed equinoxes to avoid repeated heavy work
var _equinoxCache = {};

// --- Compute an approximate Spring Equinox (northern hemisphere) ---
// Uses SunCalc.getPosition at lat=0,lng=0 sampled hourly around Mar 18â€“22 UTC.
// Returns a Date (UTC) for the approximated equinox moment, or null.
function getSpringEquinox(year) {
  if (typeof SunCalc === "undefined") return null;
  if (_equinoxCache[year]) return new Date(_equinoxCache[year].getTime());

  // Search window: March 18 00:00 UTC â†’ March 22 00:00 UTC
  var start = Date.UTC(year, 2, 18, 0, 0, 0); // month index 2 = March
  var end = Date.UTC(year, 2, 22, 0, 0, 0);
  var stepMs = 60 * 60 * 1000; // 1 hour samples

  var prevTime = start;
  var prevAlt = null;

  for (var t = start; t <= end; t += stepMs) {
    var sample = new Date(t);
    // Evaluate sun altitude at the equator (lat=0, lon=0)
    var pos = SunCalc.getPosition(sample, 0, 0);
    var alt = pos.altitude; // radians

    if (prevAlt !== null) {
      // Look for sign change from negative to positive (sun crossing celestial equator)
      if (prevAlt < 0 && alt >= 0) {
        // Linear interpolation between prevTime and t for a better estimate
        var ratio = Math.abs(prevAlt) / (Math.abs(prevAlt) + Math.abs(alt));
        var estMs = prevTime + Math.round((t - prevTime) * ratio);
        var est = new Date(estMs);
        _equinoxCache[year] = new Date(est.getTime());
        return est;
      }
    }
    prevAlt = alt;
    prevTime = t;
  }

  // If no crossing found, return null
  return null;
}

// --- ORIGINAL: find first new moon of a year (kept for fallback) ---
function getFirstNewMoonOfYear(year) {
  for (var month = 0; month < 12; month++) {
    for (var day = 1; day <= 31; day++) {
      var date = new Date(Date.UTC(year, month, day));
      if (date.getUTCMonth() !== month) continue;

      if (typeof SunCalc === "undefined") continue;
      var illum = SunCalc.getMoonIllumination(date);
      if (!illum || typeof illum.phase === "undefined") continue;
      var phase = illum.phase;
      // phase is 0 at new moon. Allow small tolerance
      if (phase < 0.03 || phase > 0.97) {
        return date;
      }
    }
  }
  return null;
}

// --- Use Spring Equinox as the start of the lunar-year (if available).
// If the date is before that year's equinox, use the previous year's.
// Falls back to your original new-moon approach if equinox isn't found. ---
function getLunarPosition(date) {
  // Work in UTC consistently
  var year = date.getUTCFullYear();
  var lunarYearStart = getSpringEquinox(year);

  // If we couldn't find an equinox for that year, fall back to first new moon
  if (!lunarYearStart) {
    lunarYearStart = getFirstNewMoonOfYear(year);
  }

  // If the date is BEFORE this year's equinox, use last year's equinox/new-moon
  if (lunarYearStart && date < lunarYearStart) {
    var prevEquinox = getSpringEquinox(year - 1);
    if (!prevEquinox) {
      prevEquinox = getFirstNewMoonOfYear(year - 1);
    }
    lunarYearStart = prevEquinox || lunarYearStart;
  }

  // If still null (very unlikely), fall back to Jan 1 UTC
  if (!lunarYearStart) lunarYearStart = new Date(Date.UTC(year, 0, 1));

  var msPerDay = 1000 * 60 * 60 * 24;
  // daysSinceStart is integer days difference (UTC)
  var daysSinceStart = Math.floor((date.getTime() - lunarYearStart.getTime()) / msPerDay);

  var moonNumber = Math.floor(daysSinceStart / 28) + 1;
  var moonDay = ((daysSinceStart % 28) + 28) % 28 + 1; // keep 1..28

  // if moonNumber > 13, return null for moonNumber (or handle how you wish)
  return {
    moonNumber: moonNumber <= 13 ? moonNumber : null,
    moonDay: moonDay,
    lunarYearStart: new Date(lunarYearStart.getTime())
  };
}

// --- Convert a lunar index to an absolute Date given a lunar-year start ---
// lunarYearStart: Date (UTC)
// moonNumber: 1..13
// moonDay: 1..28
function absoluteDateFromLunar(lunarYearStart, moonNumber, moonDay) {
  var msPerDay = 1000 * 60 * 60 * 24;
  var daysOffset = (moonNumber - 1) * 28 + (moonDay - 1);
  return new Date(lunarYearStart.getTime() + daysOffset * msPerDay);
}

// --- Migration helper: given your stored affirmations/events, add/update lunar metadata
// Example storedAffirmations: [{ id: 1, date: "2025-03-20T00:00:00Z", text: "..."}]
// This function will return a new array with added lunarInfo { moonNumber, moonDay, lunarYearStart }
function annotateAffirmationsWithLunarInfo(storedAffirmations) {
  // Do not modify in-place unless you want to; return a new array
  return storedAffirmations.map(function(evt) {
    var evtDate = new Date(evt.date); // assume ISO string or Date object
    var lunar = getLunarPosition(evtDate);
    var copy = Object.assign({}, evt);
    copy.lunarInfo = {
      moonNumber: lunar.moonNumber,
      moonDay: lunar.moonDay,
      lunarYearStart: lunar.lunarYearStart ? lunar.lunarYearStart.toISOString() : null
    };
    return copy;
  });
}

// --- Example migration function: re-map affirmations stored by absolute date to match the new scheme
// This demonstrates how you could reassign an affirmation that was previously tied to a specific absolute date
// into the same lunar index but anchored to the (possibly new) lunar year's start.
// Use with caution: best to store both originalDate and newDate and perform this offline or behind a flag.
function migrateAffirmationsToNewScheme(storedAffirmations) {
  // returns { migrated: [...], errors: [...] }
  var migrated = [];
  var errors = [];

  storedAffirmations.forEach(function(evt) {
    try {
      var evtDate = new Date(evt.date);
      var oldLunar = getLunarPosition(evtDate);

      // If oldLunar null -> skip or attach metadata
      if (!oldLunar || !oldLunar.lunarYearStart) {
        // just annotate and keep original
        migrated.push(Object.assign({}, evt, { migratedDate: evt.date, lunarInfo: oldLunar }));
        return;
      }

      // Compute new lunarYearStart for that lunar year's calendar according to new logic
      var year = evtDate.getUTCFullYear();
      var newLunarStart = getSpringEquinox(year) || getFirstNewMoonOfYear(year);
      // If the event is before the newLunarStart for the year, use previous year's start:
      if (newLunarStart && evtDate < newLunarStart) {
        newLunarStart = getSpringEquinox(year - 1) || getFirstNewMoonOfYear(year - 1);
      }
      if (!newLunarStart) {
        newLunarStart = new Date(Date.UTC(year, 0, 1));
      }

      // Use same lunar index (moonNumber/moonDay) to compute the new absolute date
      if (oldLunar.moonNumber == null) {
        // can't map, keep as-is but annotate
        migrated.push(Object.assign({}, evt, { migratedDate: evt.date, lunarInfo: oldLunar }));
      } else {
        var newDate = absoluteDateFromLunar(newLunarStart, oldLunar.moonNumber, oldLunar.moonDay);
        migrated.push(Object.assign({}, evt, { originalDate: evt.date, migratedDate: newDate.toISOString(), lunarInfo: oldLunar }));
      }
    } catch (err) {
      errors.push({ id: evt.id, error: err.message });
    }
  });

  return { migrated: migrated, errors: errors };
}
  
  function renderMonth(year, month) {
    calendar.innerHTML = "";

    var firstDay = new Date(year, month, 1);
    var daysInMonth = new Date(year, month + 1, 0).getDate();

    for (var i = 0; i < firstDay.getDay(); i++) {
      calendar.appendChild(document.createElement("div"));
    }

    for (var day = 1; day <= daysInMonth; day++) {
      var date = new Date(year, month, day);

      var isToday =
        date.getDate() === todayDate.getDate() &&
        date.getMonth() === todayDate.getMonth() &&
        date.getFullYear() === todayDate.getFullYear();

      var lunar = getLunarPosition(date);
      var moonDay = lunar.moonDay;
      var moonNumber = lunar.moonNumber;

      var moonPhase = getMoonPhase(date);
      
      var cell = document.createElement("div");
      cell.className = "day";
      if (isToday) cell.classList.add("today");

cell.innerHTML =
  '<div class="gregorian">' + date.toDateString() + '</div>' +
  '<div class="moon-day">Moon ' + moonNumber + ' Â· Day ' + moonDay + '</div>' +
  '<div class="moon-name">' + moonPhase + '</div>';

      cell.onclick = function (d, md, mp) {
  return function () {
    var guidance = getLunarGuidance(mp);
    var dayMeaning = getMoonDayMeaning(md);

    dayText.innerText =
      d.toDateString() +
      "\n" + mp +
      "\nMoon Day " + md +
      "\n\n" + dayMeaning +
      "\n\n" + guidance.message +
      "\n\nAffirmation:\n" + guidance.affirmation +
      "\n\nSuggested Ritual:\n" + guidance.ritual;
  };
}(date, moonDay, moonPhase);

      calendar.appendChild(cell);
    }
  }

  var now = new Date();
  renderMonth(now.getFullYear(), now.getMonth());

var todayPhase = getMoonPhase(todayDate);
var guidance = getLunarGuidance(todayPhase);

document.getElementById("lunarPhase").innerText = todayPhase;
document.getElementById("affirmation").innerText = guidance.affirmation;
document.getElementById("ritual").innerText = guidance.ritual;
});
</script>
  
  <script type="module">
    import {
      annotateAffirmationsWithLunisolar,
      previewMigrateAffirmations
    } from './lunisolar-engine.js';

    (async function() {
      // Annotate for UI display (non-destructive)
      try {
        const annotated = annotateAffirmationsWithLunisolar(window.myAffirmations);
        console.log('Annotated affirmations (preview):', annotated);

        // Preview migration (to remap to same lunisolar index)
        const preview = previewMigrateAffirmations(window.myAffirmations, { strategy: 'remapToSameLunarIndex' });
        console.log('Migration preview:', preview);

        // You can show preview.migrated to the user and ask to commit changes to GitHub manually,
        // or if you want me to help produce a patch you can commit, I can help format a diff or file edits.

      } catch (err) {
        console.error('Lunisolar engine error:', err);
      }
    })();
    </script>
</body>
</html>
