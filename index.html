<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Ancestral Moon Map | V9.0 Eclipse Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Charm:wght@400;700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">
  <style>
    :root { 
      --space: #050208; --gold: #e6ccff; --glass: rgba(20, 10, 35, 0.9); 
      --blood: #d9455f; --aura: #b8860b; --amethyst: #9d50bb;
      --retro: #ff6b6b; --portal: #00fa9a; --eclipse: #ff4d4d;
      --zodiac: #a6c1ee; --void: #1a1a1a;
    }
    body { 
      font-family: 'Quicksand', sans-serif; background: var(--space); 
      background-image: radial-gradient(circle at 50% 0%, #2a1b3d 0%, var(--space) 80%); 
      color: #fdfbff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
    }
    
    /* V9.0 STAR ENGINE */
    .star-field { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--d) infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.8; box-shadow: 0 0 6px white; } }

    /* CONTAINERS */
    #oracleDash, #grimoireView, #yearlyView { 
      width: 94%; max-width: 450px; background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(230, 204, 255, 0.08); border-top: 2px solid var(--aura); 
      border-radius: 30px; padding: 25px 20px; margin: 15px 0; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align: center; display: none; position: relative;
    }
    #oracleDash { display: block; }

    /* CALENDAR GRID */
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; max-width: 450px; margin-bottom: 15px; }
    .day-label { font-size: 0.55rem; color: var(--gold); font-family: 'Cinzel'; opacity: 0.5; margin-bottom: 5px; }
    .day { 
      background: rgba(255,255,255,0.03); border-radius: 12px; aspect-ratio: 1/1.1; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      position: relative; border: 1px solid transparent; cursor: pointer; transition: 0.2s; 
    }
    
    .day.today { border: 1px solid var(--gold); background: rgba(230, 204, 255, 0.05); }
    .day.full-moon-day { background: radial-gradient(circle, rgba(230, 204, 255, 0.4) 0%, transparent 80%); box-shadow: 0 0 10px rgba(230, 204, 255, 0.2); }
    .day.new-moon-day { background: radial-gradient(circle, rgba(0, 0, 0, 0.8) 0%, rgba(50, 50, 50, 0.2) 80%); border: 1px solid rgba(255,255,255,0.1); }
    .day.eclipse-day { border: 1.5px solid var(--eclipse); box-shadow: 0 0 10px var(--eclipse); }
    .day.selected { background: rgba(255, 255, 255, 0.15); border-color: white; }
    .day.period { border-bottom: 2px solid var(--blood) !important; }

    .d-num { position: absolute; top: 3px; left: 5px; font-size: 0.5rem; opacity: 0.4; }
    .t-num { position: absolute; top: 3px; right: 5px; font-size: 0.5rem; color: var(--gold); font-weight: bold; }
    .m-ico { font-size: 0.9rem; margin-top: 4px; }
    .z-ico { font-size: 0.45rem; color: var(--gold); margin-top: 2px; font-family: 'Cinzel'; opacity: 0.8; }

    /* UI ELEMENTS */
    .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(230,204,255,0.3); color: var(--gold); border-radius: 20px; padding: 10px 16px; font-family: 'Cinzel'; font-size: 0.65rem; transition: 0.3s; cursor: pointer;}
    .nav-btn:hover { background: rgba(230,204,255,0.1); border-color: var(--gold); }
    
    .cycle-btn { border: 1px solid var(--blood); color: var(--blood); background: rgba(217, 69, 95, 0.05); padding: 12px; border-radius: 30px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.8rem; width: 100%; margin-top: 15px; transition: 0.3s; letter-spacing: 1px; }
    .cycle-btn:active { transform: scale(0.98); }
    
    .wisdom-card { text-align: left; background: rgba(0,0,0,0.3); padding: 22px; border-radius: 20px; border-left: 3px solid var(--aura); margin-bottom: 15px; position: relative; overflow: hidden; }
    .wisdom-label { font-family: 'Cinzel'; font-size: 0.6rem; color: var(--gold); letter-spacing: 2px; display: block; margin-bottom: 10px; font-weight: bold; }
    .wisdom-text { font-family: 'Charm'; font-size: 1.25rem; line-height: 1.5; color: #f0f0f0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .affirmation { font-family: 'Cinzel'; font-size: 0.75rem; color: var(--zodiac); margin-top: 15px; opacity: 0.9; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
    
    .clickable-title { 
      cursor: pointer; position: relative; display: inline-block; padding: 10px 25px;
      background: linear-gradient(90deg, transparent, rgba(230, 204, 255, 0.05), transparent);
      border-top: 1px solid rgba(230, 204, 255, 0.2); border-bottom: 1px solid rgba(230, 204, 255, 0.2);
      transition: all 0.4s ease; 
    }
    .clickable-title:hover { letter-spacing: 4px; color: #fff; text-shadow: 0 0 15px var(--gold); }

    /* BADGES */
    .event-badge { font-size: 0.6rem; padding: 5px 12px; border-radius: 12px; display: inline-block; margin-bottom: 8px; font-family: 'Cinzel'; letter-spacing: 1px; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.2); }
    .portal-badge { background: rgba(0, 250, 154, 0.15); color: var(--portal); border-color: var(--portal); }
    .retro-badge { background: rgba(255, 107, 107, 0.15); color: var(--retro); border-color: var(--retro); }
    .eclipse-badge { background: rgba(255, 77, 77, 0.15); color: var(--eclipse); border-color: var(--eclipse); box-shadow: 0 0 15px rgba(255, 77, 77, 0.2); }
    
    /* MODAL */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; backdrop-filter: blur(5px); }
    #cosmicModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: #0f0816; border: 1px solid var(--gold); border-radius: 20px; padding: 30px; z-index: 1000; text-align: left; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(184, 134, 11, 0.2); }
    .modal-link { color: var(--zodiac); font-size: 0.75rem; text-decoration: none; display: flex; align-items: center; justify-content: space-between; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; transition: 0.2s; font-family: 'Quicksand'; border: 1px solid rgba(255,255,255,0.05); }
    .modal-link:hover { background: rgba(255,255,255,0.1); border-color: var(--zodiac); }

    /* INPUTS */
    #journalInput { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; color: #fff; font-family: 'Charm'; font-size: 1.2rem; min-height: 120px; box-sizing: border-box; outline: none; margin-top: 15px; }
    #journalInput:focus { border-color: var(--gold); background: rgba(0,0,0,0.4); }

    .energy-row { display: flex; gap: 5px; margin-top: 15px; }
    .energy-btn { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid transparent; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
    .energy-btn.active { background: rgba(255,255,255,0.15); border-color: var(--gold); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
  </style>
</head>
<body>

<div class="star-field" id="starField"></div>

<div style="display: flex; justify-content: space-between; width: 94%; max-width: 450px; margin-top: 10px;">
  <button class="nav-btn" onclick="showView('yearly')">YEARLY MAP</button>
  <button class="nav-btn" onclick="showView('grimoire')">MY GRIMOIRE</button>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 450px; margin: 15px 0;">
  <span style="cursor:pointer; font-size: 1.5rem; color:var(--gold); padding: 0 15px;" onclick="changeMonth(-1)">‚ùÆ</span>
  <h3 id="monthLabel" style="font-family:'Cinzel'; letter-spacing: 3px; margin:0; font-size: 1.1rem; color: #fff;"></h3>
  <span style="cursor:pointer; font-size: 1.5rem; color:var(--gold); padding: 0 15px;" onclick="changeMonth(1)">‚ùØ</span>
</div>

<div id="calendar"></div>

<div id="oracleDash">
  <div id="eventDisplay"></div>
  
  <h2 id="dashTitle" class="clickable-title" style="font-family:'Cinzel'; margin: 15px 0 5px 0; color:var(--gold); letter-spacing: 2px; font-size: 1.3rem;"></h2>
  <div id="dashSub" style="font-size: 0.65rem; letter-spacing: 2px; margin-bottom: 25px; opacity: 0.7; font-family: 'Cinzel'; color: var(--zodiac);"></div>
  
  <div class="wisdom-card">
    <span class="wisdom-label">ANCESTRAL WHISPER</span>
    <div class="wisdom-text" id="guidanceText"></div>
    <div class="affirmation" id="affirmationText"></div>
  </div>

  <div class="wisdom-card" id="shadowCard" style="display:none; border-left: 3px solid var(--retro);">
    <span class="wisdom-label" style="color:var(--retro);">SHADOW WORK INQUIRY</span>
    <div class="wisdom-text" id="shadowText"></div>
  </div>

  <div class="wisdom-card">
    <span class="wisdom-label">SACRED EARTH RITUAL</span>
    <div class="wisdom-text" id="ritualText"></div>
  </div>

  <div class="energy-row">
    <div class="energy-btn" onclick="setEnergy('üî•')" id="e-fire">üî•</div>
    <div class="energy-btn" onclick="setEnergy('üíß')" id="e-water">üíß</div>
    <div class="energy-btn" onclick="setEnergy('üå¨Ô∏è')" id="e-air">üå¨Ô∏è</div>
    <div class="energy-btn" onclick="setEnergy('ü™®')" id="e-earth">ü™®</div>
  </div>
  
  <textarea id="journalInput" placeholder="Scribe your soul's journey..." oninput="saveData()"></textarea>
  
  <button id="flowBtn" class="cycle-btn" onclick="toggleFlow()">MARK MOON FLOW ü©∏</button>
</div>

<div class="modal-overlay" onclick="closeModal()"></div>
<div id="cosmicModal">
  <h2 id="modalTitle" style="font-family:'Cinzel'; color:var(--gold); text-align:center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:15px; margin-bottom:20px; font-size: 1.2rem;"></h2>
  <div id="modalContent"></div>
  <div style="text-align:center; margin-top:25px;">
      <button class="nav-btn" onclick="closeModal()">CLOSE TRANSMISSION</button>
  </div>
</div>

<div id="grimoireView">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
    <h2 style="font-family:'Cinzel'; margin:0; font-size: 1.2rem;">SACRED HISTORY</h2>
    <span style="cursor:pointer; font-size:1.2rem; opacity:0.7" onclick="showView('dash')">‚úï</span>
  </div>
  
  <div style="text-align:left; margin-bottom: 20px;">
    <button class="nav-btn" style="width:100%; border-color:var(--aura);" onclick="exportToCSV()">üìä EXPORT CSV DATA</button>
    <div style="font-size:0.55rem; opacity:0.5; margin-top:5px; font-style:italic;">Download your data to keep it safe.</div>
  </div>
  
  <div id="grimoireContent" style="max-height: 400px; overflow-y: auto;"></div>
</div>

<div id="yearlyView">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
    <h2 style="font-family:'Cinzel'; margin:0; font-size: 1.2rem;">CELESTIAL TIMELINE</h2>
    <span style="cursor:pointer; font-size:1.2rem; opacity:0.7" onclick="showView('dash')">‚úï</span>
  </div>
  <div id="yearlyContent" style="text-align: left; padding: 5px; font-size: 0.75rem; max-height: 70vh; overflow-y: auto;"></div>
</div>

<script>
  // --- CONFIGURATION & STATE ---
  let activeD = new Date(); 
  let selectedDate = new Date().toDateString();
  let db = JSON.parse(localStorage.getItem('ancestral_moon_v9')) || { logs: {}, journals: {}, energy: {} };

  // --- DATA SOURCE: GRIFFITH OBSERVATORY / NASA (Pacific Time) ---
  // 2026-2027 New Moons for Day 1 Calculation
  const NEW_MOON_DATES = [
    "Jan 18, 2026", "Feb 17, 2026", "Mar 18, 2026", "Apr 17, 2026", "May 16, 2026", "Jun 15, 2026", 
    "Jul 14, 2026", "Aug 12, 2026", "Sep 11, 2026", "Oct 10, 2026", "Nov 9, 2026", "Dec 8, 2026",
    "Jan 7, 2027", "Feb 6, 2027", "Mar 7, 2027", "Apr 6, 2027"
  ];
  
  // Confirmed Full Moons (Pacific)
  const FULL_MOON_DATES = [
    {d: "Jan 3, 2026", s: "Cancer ‚ôã", n: "Wolf Moon"}, {d: "Feb 1, 2026", s: "Leo ‚ôå", n: "Snow Moon"}, 
    {d: "Mar 3, 2026", s: "Virgo ‚ôç", n: "Worm Moon"}, {d: "Apr 2, 2026", s: "Libra ‚ôé", n: "Pink Moon"}, 
    {d: "May 1, 2026", s: "Scorpio ‚ôè", n: "Flower Moon"}, {d: "May 31, 2026", s: "Sagittarius ‚ôê", n: "Strawberry Moon"}, 
    {d: "Jun 29, 2026", s: "Capricorn ‚ôë", n: "Buck Moon"}, {d: "Jul 29, 2026", s: "Aquarius ‚ôí", n: "Sturgeon Moon"}, 
    {d: "Aug 28, 2026", s: "Pisces ‚ôì", n: "Harvest Moon"}, {d: "Sep 26, 2026", s: "Aries ‚ôà", n: "Hunter's Moon"}, 
    {d: "Oct 25, 2026", s: "Taurus ‚ôâ", n: "Beaver Moon"}, {d: "Nov 24, 2026", s: "Gemini ‚ôä", n: "Cold Moon"}, 
    {d: "Dec 24, 2026", s: "Cancer ‚ôã", n: "Long Night Moon"},
    {d: "Jan 22, 2027", s: "Leo ‚ôå", n: "Wolf Moon"}, {d: "Feb 20, 2027", s: "Virgo ‚ôç", n: "Snow Moon"},
    {d: "Mar 22, 2027", s: "Libra ‚ôé", n: "Worm Moon"}, {d: "Apr 20, 2027", s: "Scorpio ‚ôè", n: "Pink Moon"}
  ];

  const ECLIPSE_DATA = {
    "Feb 17, 2026": { type: "Solar", name: "Annular Solar Eclipse", desc: "A ring of fire. A powerful reset for relationships and creativity. New beginnings carry massive weight." },
    "Mar 3, 2026": { type: "Lunar", name: "Total Lunar Eclipse", desc: "Blood Moon. Deep emotional purging. The shadow reveals what must be released." },
    "Aug 12, 2026": { type: "Solar", name: "Total Solar Eclipse", desc: "The Great Dimming. A moment of awe and total restart. The King's ego must bow to the cosmic order." },
    "Aug 28, 2026": { type: "Lunar", name: "Partial Lunar Eclipse", desc: "Subtle shifts. Emotional waters are choppy. Trust your intuition over your logic." },
    "Feb 6, 2027": { type: "Solar", name: "Annular Solar Eclipse", desc: "The Ring returns. Focus on community and humanitarian efforts." },
    "Feb 20, 2027": { type: "Lunar", name: "Penumbral Lunar Eclipse", desc: "A subtle shading. Pay attention to the undertones of conversations." }
  };

  const ZODIAC_SIGNS = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];
  const ELEMENTS = { "Fire": "#ff6b6b", "Earth": "#4ecdc4", "Air": "#ffe66d", "Water": "#1a53ff" };
  const ZOD_ELEM = { "Aries":"Fire", "Leo":"Fire", "Sagittarius":"Fire", "Taurus":"Earth", "Virgo":"Earth", "Capricorn":"Earth", "Gemini":"Air", "Libra":"Air", "Aquarius":"Air", "Cancer":"Water", "Scorpio":"Water", "Pisces":"Water" };

  // --- CONTENT LIBRARIES ---
  const WHISPERS = {
    "New": [
      "The sky is dark, but the soil is rich. Plant your intention with precision.", 
      "Silence is not empty; it is full of answers. Listen to the void.", 
      "You are being reset. Do not rush the reboot. Rest in the potential.",
      "The ancestors are gathering in the dark. Ask for their guidance now."
    ],
    "Waxing": [
      "Momentum builds. Do not look back at what you left behind.", 
      "The energy rises like sap in the spring. Push through the resistance.", 
      "Add fuel to the fire. Your small actions are compounding.",
      "Correction is natural. Adjust your sails, but keep moving forward."
    ],
    "Full": [
      "Illumination. Everything is visible now. Own your truth without flinching.", 
      "The cup runs over. Celebrate your abundance, no matter how small.", 
      "High tide of the spirit. Let the emotions flow; do not dam the river.",
      "You are a beacon. Shine your light so others may find their way."
    ],
    "Waning": [
      "Release the heavy grip. Surrender is a form of strength.", 
      "Compost the failures. They are fertilizer for the next cycle.", 
      "Cleanse your space. Outer order creates inner sanctuary.",
      "Rest. The warrior puts down the sword to sharpen it."
    ]
  };

  const RITUALS = {
    "Fire": "Light a candle. Stare into the flame until your vision blurs. Burn a piece of paper with a fear written on it.",
    "Earth": "Walk barefoot. Hold a stone. Eat a meal slowly, savoring every texture. Ground your energy.",
    "Air": "Write a letter to your future self. Burn incense and watch the smoke carry your prayers up.",
    "Water": "Take a salt bath. Cry if you need to. Drink a glass of water with the intention of 'clarity'."
  };

  // --- CORE LOGIC ---

  function getLunarDay(date) {
    // Find the most recent New Moon before or on this date
    let checkDate = new Date(date);
    checkDate.setHours(0,0,0,0);
    
    // Sort New Moons descending to find the closest previous one
    const sortedMoons = NEW_MOON_DATES.map(d => new Date(d)).sort((a,b) => b - a);
    const lastNewMoon = sortedMoons.find(nm => nm <= checkDate);
    
    if (!lastNewMoon) return 15; // Fallback if out of range
    
    const diffTime = Math.abs(checkDate - lastNewMoon);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    return diffDays + 1; // Day 1 is the New Moon itself
  }

  function getPhase(tDay) {
    if (tDay === 1) return "New Moon";
    if (tDay > 1 && tDay < 7) return "Waxing Crescent";
    if (tDay >= 7 && tDay <= 9) return "First Quarter";
    if (tDay > 9 && tDay < 14) return "Waxing Gibbous";
    if (tDay >= 14 && tDay <= 16) return "Full Moon"; // Broaden Full Moon window slightly for visuals
    if (tDay > 16 && tDay < 21) return "Waning Gibbous";
    if (tDay >= 21 && tDay <= 23) return "Last Quarter";
    return "Waning Crescent";
  }

  function getZodiac(date) {
    // Approximate Moon Sign Calculation (Refined)
    // Using a baseline known moon sign and iterating (approx 2.5 days per sign)
    // Baseline: Jan 1 2026 was Gemini
    const baseline = new Date("Jan 1, 2026");
    const diff = (date - baseline) / (1000 * 60 * 60 * 24);
    const signs = ["Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces", "Aries", "Taurus"];
    const idx = Math.floor((diff / 2.3)) % 12; // 2.3 days avg per sign
    return signs[(idx + 12) % 12];
  }

  function getCelestialData(date) {
    const dStr = date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const tDay = getLunarDay(date);
    let phase = getPhase(tDay);
    
    // Check Hardcoded Arrays for Precision
    const fullMoonObj = FULL_MOON_DATES.find(m => m.d === dStr);
    const isNew = NEW_MOON_DATES.includes(dStr);
    const eclipse = ECLIPSE_DATA[dStr];

    let zod = getZodiac(date);
    let archName = null;

    if (fullMoonObj) {
      phase = "Full Moon";
      zod = fullMoonObj.s.split(' ')[0];
      archName = fullMoonObj.n;
    } else if (isNew) {
      phase = "New Moon";
    }

    const element = ZOD_ELEM[zod] || "Earth";
    const elColor = ELEMENTS[element];

    // Content Selection
    const seed = (date.getDate() + date.getMonth()) % 4;
    let whisperType = phase.includes("New") ? "New" : phase.includes("Full") ? "Full" : phase.includes("Waxing") ? "Waxing" : "Waning";
    let whisper = WHISPERS[whisperType][seed];
    let ritual = RITUALS[element];
    
    if (eclipse) {
      whisper = `ECLIPSE PORTAL: ${eclipse.desc}`;
      ritual = "Do nothing. Eclipses are for observation, not manifestation. Rest deeply.";
    }

    return {
      date, dStr, tDay, phase, zod, element, elColor,
      isFull: !!fullMoonObj, isNew, eclipse, archName,
      whisper, ritual
    };
  }

  // --- RENDER ---
  function render() {
    const grid = document.getElementById("calendar"); 
    grid.innerHTML = "";
    
    const mLabel = activeD.toLocaleString('default', { month: 'long' }).toUpperCase();
    const yLabel = activeD.getFullYear();
    document.getElementById("monthLabel").innerText = `${mLabel} ${yLabel}`;
    
    ["M","T","W","T","F","S","S"].forEach(l => grid.innerHTML += `<div class="day-label">${l}</div>`);
    
    const firstDay = new Date(activeD.getFullYear(), activeD.getMonth(), 1);
    const lastDay = new Date(activeD.getFullYear(), activeD.getMonth() + 1, 0).getDate();
    
    // Adjust for Monday start
    let offset = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
    for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;

    const todayStr = new Date().toDateString();

    for(let i=1; i<=lastDay; i++) {
      const d = new Date(activeD.getFullYear(), activeD.getMonth(), i);
      const data = getCelestialData(d);
      
      const cell = document.createElement("div");
      let classes = ['day'];
      if(d.toDateString() === selectedDate) classes.push('selected');
      if(d.toDateString() === todayStr) classes.push('today');
      if(data.isFull) classes.push('full-moon-day');
      if(data.isNew) classes.push('new-moon-day');
      if(data.eclipse) classes.push('eclipse-day');
      if(db.logs[d.toDateString()]) classes.push('period');
      
      cell.className = classes.join(' ');
      
      let ico = "üåë";
      if(data.phase.includes("Waxing")) ico = "üåí";
      if(data.phase.includes("Full")) ico = "üåï";
      if(data.phase.includes("Waning")) ico = "üåò";
      
      cell.innerHTML = `
        <span class="d-num">${i}</span>
        <span class="t-num">${data.tDay}</span>
        <span class="m-ico">${ico}</span>
        <span class="z-ico" style="color:${data.elColor}">${data.zod.substring(0,3)}</span>
      `;
      cell.onclick = () => { selectedDate = d.toDateString(); updateDash(); render(); };
      grid.appendChild(cell);
    }
  }

  function updateDash() {
    const d = new Date(selectedDate);
    const data = getCelestialData(d);
    
    const titleEl = document.getElementById("dashTitle");
    let displayTitle = data.archName ? data.archName.toUpperCase() : data.phase.toUpperCase();
    if(data.eclipse) displayTitle = "‚ö†Ô∏è " + data.eclipse.name.toUpperCase();
    titleEl.innerText = displayTitle;
    titleEl.onclick = () => openModal(data);
    
    document.getElementById("dashSub").innerText = `LUNAR DAY ${data.tDay} ‚Ä¢ ${data.zod.toUpperCase()} MOON ‚Ä¢ ${data.dStr.toUpperCase()}`;
    document.documentElement.style.setProperty('--aura', data.elColor);
    
    let evHTML = "";
    if(data.eclipse) evHTML = `<div class="event-badge eclipse-badge">${data.eclipse.type.toUpperCase()} ECLIPSE</div>`;
    else if(data.isNew) evHTML = `<div class="event-badge portal-badge">NEW CYCLE BEGINS</div>`;
    else if(data.isFull) evHTML = `<div class="event-badge portal-badge">PEAK ENERGY</div>`;
    document.getElementById("eventDisplay").innerHTML = evHTML;

    document.getElementById("guidanceText").innerText = data.whisper;
    document.getElementById("ritualText").innerText = data.ritual;
    document.getElementById("affirmationText").innerText = `I honor the ${data.element} within me.`;

    // Input Handling
    document.getElementById("journalInput").value = db.journals[selectedDate] || "";
    
    // Shadow Work Card for New Moons
    if(data.isNew || data.eclipse) {
      document.getElementById("shadowCard").style.display = "block";
      document.getElementById("shadowText").innerText = "What old pattern are you ready to bury in the dark today?";
    } else {
      document.getElementById("shadowCard").style.display = "none";
    }
  }

  function openModal(data) {
    const modal = document.getElementById("cosmicModal");
    const content = document.getElementById("modalContent");
    document.getElementById("modalTitle").innerText = "COSMIC ALIGNMENT";
    document.querySelector(".modal-overlay").style.display = "block";
    modal.style.display = "block";
    
    content.innerHTML = `
      <div style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
        <span class="wisdom-label">PHASE FREQUENCY</span>
        <div class="wisdom-text" style="font-size:1rem;">${data.phase}</div>
        <a class="modal-link" href="https://www.google.com/search?q=spiritual+meaning+of+${data.phase}+moon" target="_blank">
          <span>Dive Deeper into ${data.phase} Energy</span> <span>‚ûî</span>
        </a>
      </div>
      <div style="margin-bottom:20px;">
        <span class="wisdom-label">ZODIAC VESSEL</span>
        <div class="wisdom-text" style="font-size:1rem;">Moon in ${data.zod} (${data.element})</div>
        <a class="modal-link" href="https://www.google.com/search?q=moon+in+${data.zod}+spiritual+meaning" target="_blank">
          <span>Explore ${data.zod} Moon Magic</span> <span>‚ûî</span>
        </a>
      </div>
      ${data.eclipse ? `
      <div style="margin-top:20px; background:rgba(255,0,0,0.1); padding:10px; border-radius:10px; border:1px solid var(--eclipse);">
        <span class="wisdom-label" style="color:var(--eclipse)">‚ö†Ô∏è ECLIPSE INTEL</span>
        <div class="wisdom-text" style="font-size:0.9rem;">${data.eclipse.desc}</div>
      </div>` : ''}
    `;
  }

  function closeModal() {
    document.getElementById("cosmicModal").style.display = "none";
    document.querySelector(".modal-overlay").style.display = "none";
  }

  function changeMonth(n) {
    let nextDate = new Date(activeD.getFullYear(), activeD.getMonth() + n, 1);
    // Limit to April 2027
    if (nextDate > new Date(2027, 3, 30)) return alert("The Ancestral Map ends here. Return to the present.");
    if (nextDate < new Date(2025, 0, 1)) return alert("History beyond this point is fading.");
    
    activeD.setMonth(activeD.getMonth() + n);
    render();
  }

  function toggleFlow() {
    db.logs[selectedDate] = !db.logs[selectedDate];
    saveData();
    render();
  }

  function saveData() {
    db.journals[selectedDate] = document.getElementById("journalInput").value;
    localStorage.setItem('ancestral_moon_v9', JSON.stringify(db));
  }
  
  function setEnergy(val) {
    db.energy[selectedDate] = val;
    saveData();
  }

  function showView(view) {
    document.getElementById('oracleDash').style.display = 'none';
    document.getElementById('grimoireView').style.display = 'none';
    document.getElementById('yearlyView').style.display = 'none';
    
    if(view === 'dash') document.getElementById('oracleDash').style.display = 'block';
    
    if(view === 'grimoire') {
      document.getElementById('grimoireView').style.display = 'block';
      const gc = document.getElementById('grimoireContent');
      gc.innerHTML = "";
      const dates = Object.keys(db.journals).sort((a,b) => new Date(b) - new Date(a));
      if(dates.length === 0) gc.innerHTML = "<div style='opacity:0.6; margin-top:20px;'>No entries yet. Begin your journey.</div>";
      
      dates.forEach(d => {
        if(db.journals[d]) {
          gc.innerHTML += `
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:10px; text-align:left; border-left:2px solid var(--gold);">
              <div style="font-size:0.6rem; color:var(--gold); margin-bottom:5px;">${d}</div>
              <div style="font-family:'Charm'; font-size:1.1rem; color:#eee;">${db.journals[d]}</div>
            </div>`;
        }
      });
    }

    if(view === 'yearly') {
      document.getElementById('yearlyView').style.display = 'block';
      const yc = document.getElementById('yearlyContent');
      yc.innerHTML = "";
      const y = activeD.getFullYear();
      
      yc.innerHTML += `<h4 style="color:var(--gold); font-family:'Cinzel'; text-align:center;">${y} COSMIC EVENTS</h4>`;
      
      // Filter Eclipses for Year
      for (const [date, info] of Object.entries(ECLIPSE_DATA)) {
        if(date.includes(y)) {
          yc.innerHTML += `
            <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding:10px 0;">
               <span style="color:var(--eclipse); font-weight:bold; font-size:0.7rem;">${info.type.toUpperCase()} ECLIPSE</span>
               <div style="display:flex; justify-content:space-between; color:#fff;">
                 <span>${info.name}</span>
                 <span style="opacity:0.7">${date}</span>
               </div>
               <a class="modal-link" style="margin-top:5px; padding:5px;" href="https://www.google.com/search?q=${info.name}+${y}+astrology" target="_blank">Dive Deeper ‚ûî</a>
            </div>`;
        }
      }

      // Filter Moons
      FULL_MOON_DATES.forEach(m => {
        if(m.d.includes(y)) {
          yc.innerHTML += `
            <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding:8px 0; display:flex; justify-content:space-between; font-size:0.8rem;">
              <span>üåï ${m.n} (${m.s})</span>
              <span style="opacity:0.7">${m.d.split(',')[0]}</span>
            </div>`;
        }
      });
    }
  }

  function exportToCSV() {
    let csv = "Date,Journal Entry,Moon Flow,Energy\n";
    const allDates = [...new Set([...Object.keys(db.journals), ...Object.keys(db.logs)])];
    allDates.forEach(d => {
      let j = (db.journals[d] || "").replace(/,/g, " ");
      let l = db.logs[d] ? "Yes" : "No";
      let e = db.energy[d] || "-";
      csv += `${d},${j},${l},${e}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "moon_grimoire.csv"; a.click();
  }

  // --- INITIALIZE ---
  const sField = document.getElementById('starField');
  for(let i=0; i<150; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*3+'px'; s.style.height = s.style.width;
    s.style.setProperty('--d', (Math.random()*3+2)+'s'); sField.appendChild(s);
  }
  
  render();
  updateDash();

</script>
</body>
</html>
