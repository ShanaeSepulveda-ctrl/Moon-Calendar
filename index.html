<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13 Moon Calendar</title>

  <!-- SunCalc for real lunar astronomy -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b0d17;
      color: #eee;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .day {
      background: #15192d;
      border-radius: 10px;
      padding: 8px;
      min-height: 90px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .day:hover {
      background: #1f2550;
    }

    .day.today {
      border: 1px solid rgba(180,200,255,0.6);
      box-shadow: 0 0 12px rgba(180,200,255,0.6);
    }

    .gregorian {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .moon-name {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-top: 4px;
    }

    #dayInfo {
      margin-top: 20px;
      padding: 16px;
      background: #15192d;
      border-radius: 12px;
    }

#lunarCard {
  background: linear-gradient(180deg, #1b1f3b, #0b0d17);
  border-radius: 18px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 0 20px rgba(180,200,255,0.15);
  border: 1px solid rgba(255,255,255,0.08);
}

.card-header {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  opacity: 0.85;
}

#cardTitle {
  text-align: center;
  margin: 12px 0;
  font-size: 1.3rem;
  letter-spacing: 0.5px;
}

.card-section {
  margin-top: 10px;
  line-height: 1.4;
}

    #toggleGuidance {
      margin-top: 8px;
      background: none;
      border: 1px solid #888;
      color: #eee;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h1>ðŸŒ™ 13 Moon Calendar</h1>

<div id="lunarCard">
  <div class="card-header">
    <span id="cardPhase"></span>
    <span id="cardZodiac"></span>
  </div>

  <h2 id="cardTitle"></h2>

  <p class="card-section">
    <strong>Affirmation</strong><br>
    <span id="cardAffirmation"></span>
  </p>

  <p class="card-section">
    <strong>Ritual</strong><br>
    <span id="cardRitual"></span>
  </p>

  <p class="card-section">
    <strong>Journal</strong><br>
    <span id="cardJournal"></span>
  </p>
</div>

<div id="calendar"></div>

<div id="dayInfo">
  <h2>Selected Day</h2>
  <p id="dayText">Tap a day to receive its guidance.</p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const calendar = document.getElementById("calendar");
  const dayText = document.getElementById("dayText");

  const MS_PER_DAY = 86400000;
  const LUNAR_MONTH = 28;
  const LUNAR_ANCHOR = new Date(2024, 0, 11); // New Moon anchor

  const MOON_ARCHETYPES = [
    "Deep Rest",
    "Dreaming",
    "Gestation",
    "Stirring",
    "Rooting",
    "Leafing",
    "Budding",
    "Flowering",
    "Radiance",
    "Fruiting",
    "Harvest",
    "Composting",
    "Stillness"
  ];

  const FULL_MOON_NAMES = [
    "Wolf Moon","Snow Moon","Worm Moon","Pink Moon",
    "Flower Moon","Strawberry Moon","Buck Moon","Sturgeon Moon",
    "Harvest Moon","Hunterâ€™s Moon","Beaver Moon","Cold Moon"
  ];

  function getMoonPhase(date) {
    if (!window.SunCalc) return "Moon";
    const p = SunCalc.getMoonIllumination(date).phase;
    if (p < 0.03 || p > 0.97) return "New Moon";
    if (p < 0.22) return "Waxing Crescent";
    if (p < 0.28) return "First Quarter";
    if (p < 0.47) return "Waxing Gibbous";
    if (p < 0.53) return "Full Moon";
    if (p < 0.72) return "Waning Gibbous";
    if (p < 0.78) return "Last Quarter";
    return "Waning Crescent";
  }

  function getLunarData(date) {
    const days = Math.floor((date - LUNAR_ANCHOR) / MS_PER_DAY);
    const moonDay = ((days % LUNAR_MONTH) + LUNAR_MONTH) % LUNAR_MONTH + 1;
    const moonIndex = Math.floor(days / LUNAR_MONTH) % 13;
    return {
      moonDay,
      archetype: MOON_ARCHETYPES[moonIndex]
    };
  }

function renderMonth(year, month) {
  calendar.innerHTML = "";

  const firstDay = new Date(year, month, 1);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();

  // Monday-based week start
  const mondayOffset = (firstDay.getDay() + 6) % 7;
  for (let i = 0; i < mondayOffset; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const phase = getMoonPhase(date);
    const lunar = getLunarData(date);

    let specialLabel = "";
    if (isDayOutOfTime(date)) {
      specialLabel = "ðŸ§­ Day Out of Time Â· Between Worlds";
    } else if (isLunarNewYear(date)) {
      specialLabel = "ðŸŒ‘ Lunar New Year Â· Womb Moon Begins";
    } else if (isSpringEquinox(date)) {
      specialLabel = "âš– Spring Equinox";
    }

    const cell = document.createElement("div");
    cell.className = "day";

    if (date.toDateString() === today.toDateString()) {
      cell.classList.add("today");
    }

    if (phase === "Full Moon") {
      cell.style.boxShadow = "0 0 18px rgba(255,220,180,0.35)";
    }

    const fullMoonName =
      phase === "Full Moon" ? FULL_MOON_NAMES[month % 12] : "";

    cell.innerHTML = `
      <div class="gregorian">${date.toDateString()}</div>
      <div class="moon-day">${phase}</div>
      ${fullMoonName ? `<div class="moon-name">ðŸŒ• ${fullMoonName}</div>` : ""}
      <div class="moon-name">${lunar.archetype} Â· Day ${lunar.moonDay}</div>
      ${specialLabel ? `<div class="moon-name">${specialLabel}</div>` : ""}
    `;

    cell.onclick = () => {
      dayText.innerText =
`${date.toDateString()}

Moon Phase: ${phase}
${fullMoonName ? "Full Moon Name: " + fullMoonName : ""}

Moon Archetype:
${lunar.archetype}

Moon Day: ${lunar.moonDay}`;
    };

    calendar.appendChild(cell);
  }
}
  
function isSpringEquinox(date) {
  return date.getMonth() === 2 && date.getDate() >= 19 && date.getDate() <= 21;
}

function isLunarNewYear(date) {
  if (getMoonPhase(date) !== "New Moon") return false;
  const equinox = new Date(date.getFullYear(), 2, 20);
  return date >= equinox;
}

function isDayOutOfTime(date) {
  const nextDay = new Date(date);
  nextDay.setDate(date.getDate() + 1);
  return isLunarNewYear(nextDay);
}

// ===============================
// ðŸŽ´ TODAYâ€™S LUNAR CARD (SAFE)
// ===============================
const today = new Date();
const todayPhase = getMoonPhase(today);
const todayLunar = getLunarData(today);
const todayGuidance = getMoonDayGuidance(todayLunar.moonDay);

// Poetic blend title
document.getElementById("cardTitle").innerText =
  `${todayLunar.archetype} â€” ${todayPhase}`;

// Header details
document.getElementById("cardPhase").innerText = todayPhase;
document.getElementById("cardZodiac").innerText = `Moon Day ${todayLunar.moonDay}`;

// Card content
document.getElementById("cardAffirmation").innerText =
  todayGuidance.a;

document.getElementById("cardRitual").innerText =
  todayGuidance.r;

document.getElementById("cardJournal").innerText =
  todayGuidance.j;

  const now = new Date();
  renderMonth(now.getFullYear(), now.getMonth());

});
</script>

</body>
</html>
