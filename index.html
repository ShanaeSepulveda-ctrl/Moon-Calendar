<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Ancestral Moon Map | V45 Restored Alignment</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Charm:wght@400;700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">
  <style>
    :root { 
      --space: #020105; --gold: #e6ccff; --glass: rgba(12, 6, 24, 0.96); 
      --blood: #ff3385; --aura: #9d50bb; --amethyst: #df80ff;
    }
    body { 
      font-family: 'Quicksand', sans-serif; background: var(--space); 
      background-image: radial-gradient(circle at top, #1a0b2e 0%, var(--space) 100%); 
      color: #fdfbff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    }
    .star-field { position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1; pointer-events:none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--d) infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.7; } }

    #oracleDash { 
      width: 92%; max-width: 450px; background: var(--glass); border-top: 3px solid var(--aura); 
      border-radius: 35px; padding: 20px; margin: 15px 0; box-shadow: 0 15px 50px rgba(0,0,0,0.9); text-align: center;
    }

    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; width: 100%; max-width: 450px; }
    .day { background: rgba(255,255,255,0.03); border-radius: 10px; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1.5px solid transparent; }
    
    /* FIX: Today Highlight */
    .day.today { border: 2px solid var(--gold); box-shadow: 0 0 15px var(--gold); background: rgba(230, 204, 255, 0.1); }
    .day.selected { border: 1px solid #fff; }
    .day.full-moon-day { background: radial-gradient(circle, rgba(230, 204, 255, 0.3) 0%, transparent 75%); }
    .day.new-moon-day { background: radial-gradient(circle, rgba(75, 0, 130, 0.4) 0%, transparent 75%); }
    .day.celestial-pivot { border: 1.5px dashed var(--gold); }
    .day.period { border-bottom: 3px solid var(--blood) !important; }

    .d-num { position: absolute; top: 4px; left: 6px; font-size: 0.55rem; opacity: 0.5; }
    .t-num { position: absolute; top: 4px; right: 6px; font-size: 0.55rem; color: var(--gold); font-weight: bold; }
    .m-ico { font-size: 1rem; margin-top: 5px; filter: drop-shadow(0 0 5px var(--aura)); }
    .z-ico { font-size: 0.45rem; color: var(--gold); margin-top: 2px; font-family: 'Cinzel'; }

    .nav-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); color: var(--gold); border-radius: 12px; padding: 6px 12px; font-family: 'Cinzel'; font-size: 0.6rem; }
    .cycle-btn { border: 1.5px solid var(--blood); color: var(--blood); background: transparent; padding: 14px; border-radius: 30px; font-family: 'Cinzel'; font-size: 0.8rem; width: 100%; margin-top: 10px; }
    .cycle-btn.active { background: var(--blood); color: white; }
    .sister-btn { background: var(--aura); color: white; border: none; padding: 14px; border-radius: 30px; font-family: 'Cinzel'; font-size: 0.75rem; width: 100%; margin-top: 8px; }

    .wisdom-card { text-align: left; background: rgba(0,0,0,0.4); padding: 18px; border-radius: 20px; border-left: 3px solid var(--aura); margin-bottom: 12px; }
    .wisdom-text { font-family: 'Charm'; font-size: 1.2rem; color: #eee; line-height: 1.4; }
  </style>
</head>
<body>

<div class="star-field" id="starField"></div>

<div style="display: flex; justify-content: space-between; width: 92%; max-width: 450px; margin-top: 10px;">
  <button class="nav-btn" onclick="changeMonth(-1)">PREVIOUS</button>
  <h3 id="monthLabel" style="font-family:'Cinzel'; letter-spacing: 3px; margin:0; font-size: 1rem;"></h3>
  <button class="nav-btn" onclick="changeMonth(1)">NEXT</button>
</div>

<div id="calendar" style="margin-top: 15px;"></div>

<div id="oracleDash">
  <div id="pivotBadge"></div>
  <div id="natureTheme" style="font-family:'Cinzel'; font-size:0.55rem; letter-spacing:2px; color:var(--gold); margin-bottom:5px;"></div>
  <h2 id="moonTitle" style="font-family:'Cinzel'; margin:0; color:var(--gold); letter-spacing:2px;"></h2>
  <div id="cycleSub" style="font-size: 0.6rem; letter-spacing: 2px; margin-bottom: 15px; opacity: 0.8; font-family:'Cinzel';"></div>
  
  <div class="wisdom-card">
    <div class="wisdom-text" id="guidanceText"></div>
  </div>

  <textarea id="journalInput" placeholder="Scribe your journey..." oninput="saveData()" style="width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 12px; color: #fff; font-family: 'Charm'; font-size: 1.1rem; min-height: 80px; box-sizing: border-box; outline: none;"></textarea>
  
  <button id="flowBtn" class="cycle-btn" onclick="toggleFlow()">MARK MOON FLOW</button>
  <button class="sister-btn" onclick="copySisterReport()">‚ú® SISTER CONNECTION ‚ú®</button>
</div>

<script>
  let activeD = new Date(2026, 0, 16); 
  let selectedDate = new Date().toDateString();
  let db = JSON.parse(localStorage.getItem('ancestral_v45')) || { logs: {}, journals: {} };

  // Farmer's Almanac Hard-Coded Full Moons 2026
  const FULL_MOONS = {
    "Jan 3": {z: "Cancer", n: "Wolf Moon", t: "Endurance"},
    "Feb 1": {z: "Leo", n: "Snow Moon", t: "Purity"},
    "Mar 3": {z: "Virgo", n: "Worm Moon", t: "Movement"},
    "Apr 2": {z: "Libra", n: "Quickening Moon", t: "Emergence"},
    "May 1": {z: "Scorpio", n: "Seed Moon", t: "Potential"},
    "May 31": {z: "Bloom Moon", n: "Flower Moon", t: "Vitality"},
    "Jun 29": {z: "Honey Moon", n: "Mead Moon", t: "Abundance"},
    "Jul 29": {z: "Storm Moon", n: "Buck Moon", t: "Power"},
    "Aug 28": {z: "Harvest Moon", n: "Corn Moon", t: "Gratitude"},
    "Sep 26": {z: "Leaf Moon", n: "Harvest Moon", t: "Release"},
    "Oct 25": {z: "Ancestor Moon", n: "Hunter's Moon", t: "Memory"},
    "Nov 24": {z: "Frost Moon", n: "Beaver Moon", t: "Stillness"},
    "Dec 24": {z: "Long Night Moon", n: "Cold Moon", t: "Dreaming"}
  };

  const NEW_MOONS = ["Jan 18", "Feb 17", "Mar 18", "Apr 17", "May 16", "Jun 15", "Jul 14", "Aug 12", "Sep 11", "Oct 10", "Nov 9", "Dec 8"];
  const PIVOTS = {"Mar 20": "Spring Equinox", "Jun 21": "Summer Solstice", "Sep 22": "Autumn Equinox", "Dec 21": "Winter Solstice"};
  const ZOD_ELEMENTS = {"Aries ‚ôà":"FIRE", "Leo ‚ôå":"FIRE", "Sagittarius ‚ôê":"FIRE", "Taurus ‚ôâ":"EARTH", "Virgo ‚ôç":"EARTH", "Capricorn ‚ôë":"EARTH", "Gemini ‚ôä":"AIR", "Libra ‚ôé":"AIR", "Aquarius ‚ôí":"AIR", "Cancer ‚ôã":"WATER", "Scorpio ‚ôè":"WATER", "Pisces ‚ôì":"WATER"};
  const ELEMENTS = {"FIRE": "#ff4d4d", "EARTH": "#2ecc71", "AIR": "#3498db", "WATER": "#df80ff"};

  function getCelestialData(date) {
    const dStr = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    const jd = (date.getTime() / 86400000) + 2440587.5;
    const T = (jd - 2451545.0) / 36525;
    let moonLong = (218.316 + 481267.881 * T + 6.289 * Math.sin((135.27 + 477198.87 * T) * Math.PI / 180));
    moonLong = (moonLong + 5.5) % 360; // Accuracy alignment
    const zod = ["Aries ‚ôà","Taurus ‚ôâ","Gemini ‚ôä","Cancer ‚ôã","Leo ‚ôå","Virgo ‚ôç","Libra ‚ôé","Scorpio ‚ôè","Sagittarius ‚ôê","Capricorn ‚ôë","Aquarius ‚ôí","Pisces ‚ôì"][Math.floor(moonLong / 30)];
    
    // Moon Cycle Counting (Reset at Spring Equinox Mar 20)
    const equinox = new Date(2026, 2, 20).getTime();
    const diff = Math.floor((date.getTime() - equinox) / 86400000);
    let tDay = (diff % 28) + 1; if (tDay <= 0) tDay += 28;
    let mCycle = Math.floor(diff / 28) + 1;
    if (diff < 0) mCycle = 13 + Math.floor(diff / 28); // Previous year's final cycles

    const isFull = FULL_MOONS[dStr];
    const isNew = NEW_MOONS.includes(dStr);
    const el = ZOD_ELEMENTS[zod];
    
    return { zod, tDay, mCycle, isFull, isNew, isPivot: PIVOTS[dStr], el, elColor: ELEMENTS[el], dStr };
  }

  function render() {
    const grid = document.getElementById("calendar"); grid.innerHTML = "";
    document.getElementById("monthLabel").innerText = activeD.toLocaleString('default', { month: 'long' }).toUpperCase();
    const first = new Date(activeD.getFullYear(), activeD.getMonth(), 1);
    const last = new Date(activeD.getFullYear(), activeD.getMonth() + 1, 0).getDate();
    let offset = (first.getDay() === 0) ? 6 : first.getDay() - 1;
    for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;
    
    for(let i=1; i<=last; i++) {
      const d = new Date(activeD.getFullYear(), activeD.getMonth(), i);
      const data = getCelestialData(d);
      const cell = document.createElement("div");
      cell.className = `day ${d.toDateString() === selectedDate?'selected':''} ${d.toDateString() === new Date().toDateString()?'today':''} ${data.isFull?'full-moon-day':''} ${data.isNew?'new-moon-day':''} ${data.isPivot?'celestial-pivot':''} ${db.logs[d.toDateString()]?'period':''}`;
      cell.innerHTML = `<span class="d-num">${i}</span><span class="t-num">${data.tDay}</span><span class="m-ico" style="filter: drop-shadow(0 0 5px ${data.elColor})">${data.isFull?'üåï':data.isNew?'üåë':'‚òæ'}</span><span class="z-ico">${data.zod.split(' ')[0]}</span>`;
      cell.onclick = () => { selectedDate = d.toDateString(); updateDash(d); render(); };
      grid.appendChild(cell);
    }
  }

  function updateDash(date) {
    const data = getCelestialData(date);
    document.documentElement.style.setProperty('--aura', data.elColor);
    document.getElementById("moonTitle").innerText = data.isFull ? data.isFull.n.toUpperCase() : "ANCESTRAL MOON";
    document.getElementById("natureTheme").innerText = data.isFull ? `THEME: ${data.isFull.t.toUpperCase()}` : `ALIGNING WITH THE EARTH`;
    document.getElementById("cycleSub").innerText = `MOON ${data.mCycle}/13 ‚Ä¢ DAY ${data.tDay} ‚Ä¢ ${data.zod}`;
    document.getElementById("journalInput").value = db.journals[date.toDateString()] || "";
    document.getElementById("flowBtn").className = db.logs[date.toDateString()] ? "cycle-btn active" : "cycle-btn";
    
    document.getElementById("pivotBadge").innerHTML = data.isPivot ? `<div style="background:var(--gold); color:var(--space); font-family:'Cinzel'; font-size:0.6rem; padding:4px 10px; border-radius:15px; display:inline-block; margin-bottom:10px;">‚ú® ${data.isPivot.toUpperCase()}</div>` : "";

    const whisper = `Today the moon is in ${data.zod.split(' ')[0]}. The ${data.el.toLowerCase()} element reminds us that our ancestors didn't just watch the stars‚Äîthey felt them in their bones. Walk with that same knowing today.`;
    document.getElementById("guidanceText").innerText = whisper;
  }

  function saveData() { db.journals[selectedDate] = document.getElementById("journalInput").value; localStorage.setItem('ancestral_v45', JSON.stringify(db)); }
  function toggleFlow() { db.logs[selectedDate] = !db.logs[selectedDate]; localStorage.setItem('ancestral_v45', JSON.stringify(db)); render(); updateDash(new Date(selectedDate)); }
  function changeMonth(n) { activeD.setMonth(activeD.getMonth() + n); render(); }

  // Star Field
  const sField = document.getElementById('starField');
  for(let i=0; i<60; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*2+'px'; s.style.setProperty('--d', (Math.random()*3+2)+'s'); sField.appendChild(s);
  }

  render(); updateDash(new Date());
</script>
</body>
</html>
