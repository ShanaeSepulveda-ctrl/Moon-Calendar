<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>13 Moon Calendar</title>
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b0d17; color: #eee; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day { background: #15192d; border-radius: 10px; padding: 10px; cursor: pointer; min-height: 90px; transition: background 0.2s; position: relative; }
    .day:hover { background: #1f2550; }
    .gregorian { font-size: 0.8rem; opacity: 0.7; }
    .moon-day { font-size: 1.1rem; font-weight: bold; margin-top: 5px; }
    .moon-name { font-size: 0.75rem; opacity: 0.8; margin-top: 4px; }
    .label-weekday { text-align:center; font-size:0.85rem; opacity:0.75; margin-bottom:8px; }
    #dayInfo { margin-top: 30px; padding: 20px; border-radius: 12px; background: #15192d; }
    .day.today { border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 0 12px rgba(180,200,255,0.6); background: radial-gradient(circle at top, rgba(255,255,255,0.08), #15192d); }
    .solstice { outline: 2px solid rgba(255,200,100,0.18); box-shadow: 0 0 8px rgba(255,200,100,0.06) inset; }
    .equinox { outline: 2px solid rgba(100,200,255,0.18); box-shadow: 0 0 8px rgba(100,200,255,0.06) inset; }
    .special-badge { position: absolute; top: 6px; right: 8px; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; opacity: 0.95; }
    .solstice .special-badge { background: rgba(255,200,100,0.12); color: #ffdca0; }
    .equinox .special-badge { background: rgba(100,200,255,0.10); color: #bfe8ff; }
    .legend { display:flex; gap:10px; justify-content:center; margin-bottom:12px; font-size:0.9rem; opacity:0.85; }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <h1>13 Moon Calendar</h1>

  <div id="lunarGuidance">
    <h2>ðŸŒ™ Todayâ€™s Lunar Guidance</h2>
    <p id="lunarPhase"></p>
    <p><strong>Affirmation:</strong> <span id="affirmation"></span></p>
    <p><strong>Suggested Ritual:</strong> <span id="ritual"></span></p>
  </div>

  <div class="legend">
    <div><span style="background:rgba(255,200,100,0.12); padding:4px 8px; border-radius:6px; color:#ffdca0;">â˜€ Solstice</span></div>
    <div><span style="background:rgba(100,200,255,0.10); padding:4px 8px; border-radius:6px; color:#bfe8ff;">âš– Equinox</span></div>
  </div>

  <div id="calendar"></div>

  <div id="dayInfo">
    <h2>Selected Day</h2>
    <p id="dayText">Click a day to see its energy.</p>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  var calendar = document.getElementById("calendar");
  var dayText = document.getElementById("dayText");
  var todayDate = new Date();

  function getMoonPhase(date) {
    if (typeof SunCalc === "undefined") return "ðŸŒ™ Moon";
    var phase = SunCalc.getMoonIllumination(date).phase;
    if (phase < 0.03 || phase > 0.97) return "ðŸŒ‘ New Moon";
    if (phase < 0.22) return "ðŸŒ’ Waxing Crescent";
    if (phase < 0.28) return "ðŸŒ“ First Quarter";
    if (phase < 0.47) return "ðŸŒ” Waxing Gibbous";
    if (phase < 0.53) return "ðŸŒ• Full Moon";
    if (phase < 0.72) return "ðŸŒ– Waning Gibbous";
    if (phase < 0.78) return "ðŸŒ— Last Quarter";
    return "ðŸŒ˜ Waning Crescent";
  }

  // fallback lunar function (kept available)
  function getLunarPositionOriginal(date) {
    var year = date.getUTCFullYear();
    function getSpringEquinox(y) {
      if (typeof SunCalc === "undefined") return null;
      var start = Date.UTC(y,2,18,0,0,0), end = Date.UTC(y,2,22,0,0,0), stepMs = 60*60*1000;
      var prevAlt = null, prevTime = start;
      for (var t = start; t <= end; t += stepMs) {
        var sample = new Date(t);
        var pos = SunCalc.getPosition(sample, 0, 0);
        var alt = pos && typeof pos.altitude === 'number' ? pos.altitude : null;
        if (prevAlt !== null && alt !== null) {
          if (prevAlt < 0 && alt >= 0) {
            var ratio = Math.abs(prevAlt) / (Math.abs(prevAlt) + Math.abs(alt));
            var estMs = prevTime + Math.round((t - prevTime) * ratio);
            return new Date(estMs);
          }
        }
        prevAlt = alt;
        prevTime = t;
      }
      return null;
    }

    function getFirstNewMoonOfYearUTC(y) {
      if (typeof SunCalc === "undefined" || typeof SunCalc.getMoonIllumination !== 'function') return null;
      for (var m = 0; m < 12; m++) {
        for (var d = 1; d <= 31; d++) {
          var dt = new Date(Date.UTC(y, m, d));
          if (dt.getUTCMonth() !== m) continue;
          var illum = SunCalc.getMoonIllumination(dt);
          if (!illum || typeof illum.phase === 'undefined') continue;
          var phase = illum.phase;
          if (phase < 0.03 || phase > 0.97) {
            return dt;
          }
        }
      }
      return null;
    }

    var lunarYearStart = getSpringEquinox(year);
    if (!lunarYearStart) lunarYearStart = getFirstNewMoonOfYearUTC(year);
    if (!lunarYearStart) lunarYearStart = new Date(Date.UTC(year,0,1));
    if (date < lunarYearStart) {
      var prev = getSpringEquinox(year-1) || getFirstNewMoonOfYearUTC(year-1);
      if (prev) lunarYearStart = prev;
    }

    var msPerDay = 1000*60*60*24;
    var daysSinceStart = Math.floor((Date.UTC(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate()) - Date.UTC(lunarYearStart.getUTCFullYear(),lunarYearStart.getUTCMonth(),lunarYearStart.getUTCDate()))/msPerDay);
    var moonNumber = Math.floor(daysSinceStart / 28) + 1;
    var moonDay = ((daysSinceStart % 28) + 28) % 28 + 1;

    return {
      moonNumber: moonNumber <= 13 ? moonNumber : null,
      moonDay: moonDay,
      lunarYearStart: new Date(lunarYearStart.getTime())
    };
  }

  window.getLunarPositionOriginal = getLunarPositionOriginal;

  // wrapper that modules can override by setting window.getLunarPosition
  window.getLunarPositionWrapper = function(date) {
    if (typeof window.getLunarPosition === 'function' && window.getLunarPosition !== window.getLunarPositionOriginal) {
      try {
        return window.getLunarPosition(date);
      } catch (e) {
        console.warn('Override lunar function failed; falling back.', e);
        return window.getLunarPositionOriginal(date);
      }
    }
    return window.getLunarPositionOriginal(date);
  };

  // determine if a date matches an equinox/solstice (approx) by sampling around expected days using SunCalc
  function findAnnualSolarEvents(year) {
    var events = {}; // keyed by ISO date string
    if (typeof SunCalc === 'undefined' || typeof SunCalc.getPosition !== 'function') return events;

    // helper to sample around an expected day and find sign change or extremum
    function findCrossing(startDateMS, endDateMS, stepMs, comparator) {
      var best = null;
      var prevVal = null, prevT = startDateMS;
      for (var t = startDateMS; t <= endDateMS; t += stepMs) {
        var dt = new Date(t);
        var pos = SunCalc.getPosition(dt, 0, 0);
        var val = pos && typeof pos.altitude === 'number' ? pos.altitude : null;
        if (val === null) { prevVal = null; prevT = t; continue; }
        if (prevVal !== null) {
          // comparator: 'crossZero' or 'extremum'
          if (comparator === 'crossZero') {
            if (prevVal < 0 && val >= 0) {
              var ratio = Math.abs(prevVal) / (Math.abs(prevVal) + Math.abs(val));
              var estMs = prevT + Math.round((t - prevT) * ratio);
              return new Date(estMs);
            }
          } else if (comparator === 'extremum') {
            // look for local max/min comparing prevVal, val and next sample
            // here we'll accumulate and return the time with the maximum absolute altitude value in range
            if (!best || Math.abs(val) > Math.abs(best.val)) {
              best = { t: t, val: val };
            }
          }
        } else {
          if (!best && comparator === 'extremum' && Math.abs(val) > 0) best = { t: t, val: val };
        }
        prevVal = val;
        prevT = t;
      }
      return best ? new Date(best.t) : null;
    }

    // approximate windows (UTC)
    var approx = [
      { name: 'spring-equinox', mid: Date.UTC(year,2,20) , cmp:'crossZero',   window:-3 },
      { name: 'summer-solstice', mid: Date.UTC(year,5,21), cmp:'extremum',    window:7 },
      { name: 'autumn-equinox', mid: Date.UTC(year,8,22), cmp:'crossZero',   window:-3 },
      { name: 'winter-solstice', mid: Date.UTC(year,11,21), cmp:'extremum',   window:7 }
    ];

    approx.forEach(a => {
      var start = a.mid + (a.window - 5) * 24*60*60*1000;
      var end = a.mid + (a.window + 5) * 24*60*60*1000;
      var found = findCrossing(start, end, 60*60*1000, a.cmp);
      if (found) {
        events[new Date(Date.UTC(found.getUTCFullYear(), found.getUTCMonth(), found.getUTCDate())).toISOString().slice(0,10)] = a.name;
      }
    });

    return events;
  }

  // cache of events per year to avoid recomputing
  var _solarEventCache = {};

  function getSolarEventsForYear(year) {
    if (_solarEventCache[year]) return _solarEventCache[year];
    _solarEventCache[year] = findAnnualSolarEvents(year);
    return _solarEventCache[year];
  }

  // render month with weeks starting on Monday (0=Monday,6=Sunday)
  function renderMonth(year, month) {
    calendar.innerHTML = "";

    // weekday labels Monday..Sunday
    var labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    labels.forEach(function(l){ var el = document.createElement('div'); el.className='label-weekday'; el.innerText = l; calendar.appendChild(el); });

    var firstDay = new Date(year, month, 1);
    // shift so Monday is 0: shift = (weekday + 6) % 7
    var firstWeekdayShift = (firstDay.getDay() + 6) % 7;

    // fill leading blanks
    for (var i = 0; i < firstWeekdayShift; i++) {
      var blank = document.createElement('div');
      blank.className = 'day';
      calendar.appendChild(blank);
    }

    var daysInMonth = new Date(year, month + 1, 0).getDate();

    // get solar events for the year once
    var solarEvents = getSolarEventsForYear(year);

    for (var day = 1; day <= daysInMonth; day++) {
      (function(day){
        var date = new Date(year, month, day);
        var isToday = date.getDate() === todayDate.getDate() && date.getMonth() === todayDate.getMonth() && date.getFullYear() === todayDate.getFullYear();

        var lunar = window.getLunarPositionWrapper(date);
        var moonDay = lunar.moonDay;
        var moonNumber = lunar.moonNumber;
        var moonPhase = getMoonPhase(date);

        var cell = document.createElement("div");
        cell.className = "day";
        if (isToday) cell.classList.add("today");

        // check for solar events on this UTC date
        var iso = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())).toISOString().slice(0,10);
        if (solarEvents[iso]) {
          if (solarEvents[iso].indexOf('equinox') !== -1) cell.classList.add('equinox');
          if (solarEvents[iso].indexOf('solstice') !== -1) cell.classList.add('solstice');
          var badge = document.createElement('span');
          badge.className = 'special-badge';
          badge.innerText = solarEvents[iso] === 'spring-equinox' || solarEvents[iso] === 'autumn-equinox' ? 'âš– Equinox' : 'â˜€ Solstice';
          cell.appendChild(badge);
        }

        cell.innerHTML += '<div class="gregorian">' + date.toDateString() + '</div>' +
          '<div class="moon-day">Moon ' + (moonNumber === null ? 'â€”' : moonNumber) + ' Â· Day ' + (moonDay === null ? 'â€”' : moonDay) + '</div>' +
          '<div class="moon-name">' + moonPhase + '</div>';

        cell.onclick = function () {
          var guidance = getLunarGuidance(moonPhase);
          var dayMeaning = getMoonDayMeaning(moonDay);
          dayText.innerText =
            date.toDateString() +
            "\n" + moonPhase +
            "\nMoon Day " + moonDay +
            "\n\n" + dayMeaning +
            "\n\n" + guidance.message +
            "\n\nAffirmation:\n" + guidance.affirmation +
            "\n\nSuggested Ritual:\n" + guidance.ritual;
        };

        calendar.appendChild(cell);
      })(day);
    }

    // fill trailing blanks so the grid keeps full weeks (total children multiple of 7 + the 7 label cells)
    var totalCells = calendar.children.length; // includes weekday labels
    var remainder = totalCells % 7;
    if (remainder !== 0) {
      var toAdd = 7 - remainder;
      for (var j = 0; j < toAdd; j++) {
        var blank2 = document.createElement('div');
        blank2.className = 'day';
        calendar.appendChild(blank2);
      }
    }
  }

  // expose renderMonth for module to call
  window.renderMonth = renderMonth;

  // initial render
  var now = new Date();
  renderMonth(now.getFullYear(), now.getMonth());

  // fill lunar guidance UI
  var todayPhase = getMoonPhase(todayDate);
  var guidance = getLunarGuidance(todayPhase);
  document.getElementById("lunarPhase").innerText = todayPhase;
  document.getElementById("affirmation").innerText = guidance.affirmation;
  document.getElementById("ritual").innerText = guidance.ritual;

  // helper functions (same as before)
  function getLunarGuidance(phase) {
    var guidance = {
      "ðŸŒ‘ New Moon": { affirmation: "I welcome new beginnings with clarity and trust.", ritual: "Set intentions in a journal or sit quietly with what is ready to be born.", message: "This is a sacred pause. Listen inward and allow new seeds to form." },
      "ðŸŒ’ Waxing Crescent": { affirmation: "I gently nurture what is growing within me.", ritual: "Take one small aligned action toward a goal or dream.", message: "Growth is subtle today. Honor small steps and quiet momentum." },
      "ðŸŒ“ First Quarter": { affirmation: "I move forward with courage and commitment.", ritual: "Clear obstacles or make a decision youâ€™ve been postponing.", message: "Tension invites clarity. Choose forward motion with intention." },
      "ðŸŒ” Waxing Gibbous": { affirmation: "I refine my path with patience and awareness.", ritual: "Adjust plans and release perfectionism.", message: "Refinement brings wisdom. Let your vision evolve." },
      "ðŸŒ• Full Moon": { affirmation: "I honor my growth and release what no longer serves me.", ritual: "Practice a release ritual or celebrate how far youâ€™ve come.", message: "Illumination is strong. Feel fully, release gently, celebrate truth." },
      "ðŸŒ– Waning Gibbous": { affirmation: "I integrate wisdom gained through experience.", ritual: "Share gratitude or reflect on recent insights.", message: "Meaning settles in now. Let lessons land softly." },
      "ðŸŒ— Last Quarter": { affirmation: "I release with compassion and intention.", ritual: "Let go of habits, commitments, or thoughts that drain you.", message: "Clearing creates space. Choose what truly supports you." },
      "ðŸŒ˜ Waning Crescent": { affirmation: "I rest, restore, and prepare for renewal.", ritual: "Slow down, rest deeply, or spend time in quiet reflection.", message: "This is a time of rest and surrender. Restoration is sacred." }
    };
    return guidance[phase] || { affirmation: "I flow with the natural rhythms of life.", ritual: "Pause and take a mindful breath.", message: "Move gently and listen to what your body and spirit need." };
  }

  function getMoonDayMeaning(moonDay) {
    var meanings = {
      1: "Initiation â€” a spark of beginning energy is present.",
      2: "Polarity â€” notice balance, contrast, and relationship.",
      3: "Activation â€” movement begins; ideas want expression.",
      4: "Form â€” structure and boundaries support growth.",
      5: "Empowerment â€” confidence and personal power rise.",
      6: "Balance â€” harmony, care, and adjustment are needed.",
      7: "Reflection â€” pause, observe, and realign.",
      8: "Integration â€” lessons begin to settle into the body.",
      9: "Intention â€” refocus on what truly matters.",
      10: "Manifestation â€” effort meets visible outcome.",
      11: "Release â€” clear tension, emotion, or resistance.",
      12: "Understanding â€” insight and perspective deepen.",
      13: "Transformation â€” something shifts at the core.",
      14: "Illumination â€” truth is revealed; clarity peaks.",
      15: "Expression â€” share, communicate, or celebrate.",
      16: "Adjustment â€” course-correct with compassion.",
      17: "Trust â€” surrender control and allow flow.",
      18: "Healing â€” tend to emotional or physical needs.",
      19: "Completion â€” acknowledge what has been fulfilled.",
      20: "Devotion â€” recommit to what nourishes you.",
      21: "Expansion â€” openness and possibility widen.",
      22: "Mastery â€” skills and wisdom stabilize.",
      23: "Flow â€” allow ease and natural movement.",
      24: "Gratitude â€” appreciation softens and opens the heart.",
      25: "Surrender â€” release expectations and outcomes.",
      26: "Clearing â€” simplify, declutter, cleanse.",
      27: "Stillness â€” quiet awareness prepares renewal.",
      28: "Renewal â€” rest, reset, and prepare to begin again."
    };
    return meanings[moonDay] || "";
  }

});
</script>

<!-- module import that overrides lunar mapping when available -->
<script type="module">
  import { toLunisolar, annotateAffirmationsWithLunisolar, previewMigrateAffirmations } from './lunisolar-engine.js';

  (async function() {
    try {
      if (typeof toLunisolar === 'function') {
        window.getLunarPosition = function(date) {
          try {
            var lunar = toLunisolar(date);
            return {
              moonNumber: lunar && typeof lunar.moonNumber !== 'undefined' ? lunar.moonNumber : null,
              moonDay: lunar && typeof lunar.moonDay !== 'undefined' ? lunar.moonDay : null,
              lunarYearStart: lunar && lunar.lunarYearStart ? new Date(lunar.lunarYearStart) : null
            };
          } catch (e) {
            console.warn('toLunisolar failed â€” falling back to original', e);
            return window.getLunarPositionOriginal ? window.getLunarPositionOriginal(date) : { moonNumber: null, moonDay: null, lunarYearStart: null };
          }
        };
        if (typeof window.renderMonth === 'function') {
          const now = new Date();
          window.renderMonth(now.getFullYear(), now.getMonth());
        }
      } else {
        console.warn('lunisolar-engine did not export toLunisolar');
      }

      try {
        const annotated = typeof annotateAffirmationsWithLunisolar === 'function' ? annotateAffirmationsWithLunisolar(window.myAffirmations || []) : [];
        console.log('Annotated affirmations (preview):', annotated);
        const preview = typeof previewMigrateAffirmations === 'function' ? previewMigrateAffirmations(window.myAffirmations || [], { strategy: 'remapToSameLunarIndex' }) : null;
        console.log('Migration preview:', preview);
      } catch (e) {
        console.warn('Annotate/preview step failed:', e);
      }

    } catch (err) {
      console.error('Lunisolar engine error:', err);
    }
  })();
</script>
</body>
</html>
